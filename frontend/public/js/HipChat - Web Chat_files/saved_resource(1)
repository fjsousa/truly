/**
 * Version: fb4514953f2c367e1a82f214921332b4b33740ba
 * Generated: Thu, 06 Feb 2014 23:15:52 +0000
 */
function focusFirstInput(node,includeSelect){var input=null;var selector=":input[value='']:not(.nofocus):visible:enabled, .error :input:not(.nofocus):visible:enabled";if(includeSelect){selector+=", select:not(.nofocus):visible:enabled";}
if(!node){input=$(selector)[0];}else{input=$(node).find(selector)[0];}
if(input){input.focus();if(typeof input.select=='function'){input.select();}}}
$(function(){focusFirstInput();});$(function(){$(".defaultText").focus(function(srcc){if($(this).val()==$(this)[0].title){$(this).removeClass("defaultTextActive");$(this).val("");}});$(".defaultText").blur(function(){if($(this).val()==""){$(this).addClass("defaultTextActive");$(this).val($(this)[0].title);}});$(".defaultText").blur();$("form").submit(function(){$(".defaultText").each(function(){if($(this).val()==this.title){$(this).val("");}});});});$(document).bind('hipchat.load',function(){var lbs=$('a[rel="lightbox"]');if(lbs.length>0){lbs.nyroModal();}});$(document).ready(function(){if(window.devicePixelRatio>1){$("img.2x-available").each(function(i,elem){elem=$(elem);elem.attr('src',elem.attr('src').replace(".png","@2x.png"));});}});function addFormError(inputElem,text){inputElem=$(inputElem);parentCell=inputElem.parents('td');parentRow=parentCell.parent();parentRow.addClass('error');parentCell.children('.error').remove();parentCell.append('<span class="error">'+text+'</span>');inputElem.focus();}
function removeFormError(inputElem){inputElem=$(inputElem);parentCell=inputElem.parents('td');parentRow=parentCell.parent();parentRow.removeClass('error');parentCell.children('.error').remove();}
function addFormSuccess(inputElem,text){inputElem=$(inputElem);parentCell=inputElem.parents('td');parentRow=parentCell.parent();parentRow.addClass('success');parentCell.children('.success').remove();parentCell.append('<span class="success">'+text+'</span>');inputElem.focus();}
function removeFormSuccess(inputElem){inputElem=$(inputElem);parentCell=inputElem.parents('td');parentRow=parentCell.parent();parentRow.removeClass('success');parentCell.children('.success').remove();}
function show_flash(msg){$('p.flash').html(msg);}
function show_flash_notice(msg){$('p.flash_notice').html(msg);}
function show_flash_err(msg){$('p.flash_err').html(msg);}
function escape_html(unsafe){return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}
function single_form_submit(form_elem){form_elem=$(form_elem);if(form_elem.attr('was_submitted')!==undefined){return false;}
form_elem.attr('was_submitted',true);return true;}
;/*!
   SoundManager 2: Javascript Sound for the Web
   --------------------------------------------
   http://schillmania.com/projects/soundmanager2/

   Copyright (c) 2007, Scott Schiller. All rights reserved.
   Code provided under the BSD License:
   http://schillmania.com/projects/soundmanager2/license.txt

   V2.95b.20100101
*/
var soundManager=null;function SoundManager(c,e){this.flashVersion=8;this.debugMode=false;this.debugFlash=false;this.useConsole=true;this.consoleOnly=false;this.waitForWindowLoad=false;this.nullURL="null.mp3";this.allowPolling=true;this.useFastPolling=false;this.useMovieStar=false;this.bgColor="#ffffff";this.useHighPerformance=false;this.flashLoadTimeout=1000;this.wmode=null;this.allowFullScreen=true;this.allowScriptAccess="always";this.defaultOptions={autoLoad:false,stream:true,autoPlay:false,onid3:null,onload:null,whileloading:null,onplay:null,onpause:null,onresume:null,whileplaying:null,onstop:null,onfinish:null,onbeforefinish:null,onbeforefinishtime:5000,onbeforefinishcomplete:null,onjustbeforefinish:null,onjustbeforefinishtime:200,multiShot:true,multiShotEvents:false,position:null,pan:0,volume:100};this.flash9Options={isMovieStar:null,usePeakData:false,useWaveformData:false,useEQData:false,onbufferchange:null,ondataerror:null};this.movieStarOptions={onmetadata:null,useVideo:false,bufferTime:null};var d=null;var i=this;var h="soundManager";this.version=null;this.versionNumber="V2.95b.20100101";this.movieURL=null;this.url=null;this.altURL=null;this.swfLoaded=false;this.enabled=false;this.o=null;this.id=(e||"sm2movie");this.oMC=null;this.sounds={};this.soundIDs=[];this.muted=false;this.isFullScreen=false;this.isIE=(navigator.userAgent.match(/MSIE/i));this.isSafari=(navigator.userAgent.match(/safari/i));this.debugID="soundmanager-debug";this.debugURLParam=/([#?&])debug=1/i;this.specialWmodeCase=false;this._onready=[];this._debugOpen=true;this._didAppend=false;this._appendSuccess=false;this._didInit=false;this._disabled=false;this._windowLoaded=false;this._hasConsole=(typeof console!="undefined"&&typeof console.log!="undefined");this._debugLevels=["log","info","warn","error"];this._defaultFlashVersion=8;this._oRemoved=null;this._oRemovedHTML=null;var f=function(j){return document.getElementById(j)};this.filePatterns={flash8:/\.mp3(\?.*)?$/i,flash9:/\.mp3(\?.*)?$/i};this.netStreamTypes=["aac","flv","mov","mp4","m4v","f4v","m4a","mp4v","3gp","3g2"];this.netStreamPattern=new RegExp("\\.("+this.netStreamTypes.join("|")+")(\\?.*)?$","i");this.filePattern=null;this.features={buffering:false,peakData:false,waveformData:false,eqData:false,movieStar:false};this.sandbox={type:null,types:{remote:"remote (domain-based) rules",localWithFile:"local with file access (no internet access)",localWithNetwork:"local with network (internet access only, no local access)",localTrusted:"local, trusted (local+internet access)"},description:null,noRemote:null,noLocal:null};this._setVersionInfo=function(){if(i.flashVersion!=8&&i.flashVersion!=9){alert(i._str("badFV",i.flashVersion,i._defaultFlashVersion));i.flashVersion=i._defaultFlashVersion}i.version=i.versionNumber+(i.flashVersion==9?" (AS3/Flash 9)":" (AS2/Flash 8)");if(i.flashVersion>8){i.defaultOptions=i._mergeObjects(i.defaultOptions,i.flash9Options);i.features.buffering=true}if(i.flashVersion>8&&i.useMovieStar){i.defaultOptions=i._mergeObjects(i.defaultOptions,i.movieStarOptions);i.filePatterns.flash9=new RegExp("\\.(mp3|"+i.netStreamTypes.join("|")+")(\\?.*)?$","i");i.features.movieStar=true}else{i.useMovieStar=false;i.features.movieStar=false}i.filePattern=i.filePatterns[(i.flashVersion!=8?"flash9":"flash8")];i.movieURL=(i.flashVersion==8?"soundmanager2.swf":"soundmanager2_flash9.swf");i.features.peakData=i.features.waveformData=i.features.eqData=(i.flashVersion>8)};this._overHTTP=(document.location?document.location.protocol.match(/http/i):null);this._waitingforEI=false;this._initPending=false;this._tryInitOnFocus=(this.isSafari&&typeof document.hasFocus=="undefined");this._isFocused=(typeof document.hasFocus!="undefined"?document.hasFocus():null);this._okToDisable=!this._tryInitOnFocus;this.useAltURL=!this._overHTTP;var a="";this.strings={};var b="";this._str=function(){var p=Array.prototype.slice.call(arguments);var n=p.shift();var m=i.strings&&i.strings[n]?i.strings[n]:"";if(m&&p&&p.length){for(var l=0,k=p.length;l<k;l++){m=m.replace("%s",p[l])}}return m};this.supported=function(){return(i._didInit&&!i._disabled)};this.getMovie=function(j){return i.isIE?window[j]:(i.isSafari?f(j)||document[j]:f(j))};this.loadFromXML=function(j){try{i.o._loadFromXML(j)}catch(k){i._failSafely();return true}};this.createSound=function(k){var m="soundManager.createSound(): ";if(!i._didInit){throw i._complain(m+i._str("notReady"),arguments.callee.caller)}if(arguments.length==2){k={id:arguments[0],url:arguments[1]}}var l=i._mergeObjects(k);var j=l;if(j.id.toString().charAt(0).match(/^[0-9]$/)){}if(i._idCheck(j.id,true)){return i.sounds[j.id]}if(i.flashVersion>8&&i.useMovieStar){if(j.isMovieStar===null){j.isMovieStar=(j.url.match(i.netStreamPattern)?true:false)}if(j.isMovieStar){}if(j.isMovieStar&&(j.usePeakData||j.useWaveformData||j.useEQData)){j.usePeakData=false;j.useWaveformData=false;j.useEQData=false}}i.sounds[j.id]=new d(j);i.soundIDs[i.soundIDs.length]=j.id;if(i.flashVersion==8){i.o._createSound(j.id,j.onjustbeforefinishtime)}else{i.o._createSound(j.id,j.url,j.onjustbeforefinishtime,j.usePeakData,j.useWaveformData,j.useEQData,j.isMovieStar,(j.isMovieStar?j.useVideo:false),(j.isMovieStar?j.bufferTime:false))}if(j.autoLoad||j.autoPlay){if(i.sounds[j.id]){i.sounds[j.id].load(j)}}if(j.autoPlay){i.sounds[j.id].play()}return i.sounds[j.id]};this.createVideo=function(j){if(arguments.length==2){j={id:arguments[0],url:arguments[1]}}if(i.flashVersion>=9){j.isMovieStar=true;j.useVideo=true}else{return false}if(!i.useMovieStar){}return i.createSound(j)};this.destroySound=function(k,j){if(!i._idCheck(k)){return false}for(var l=0;l<i.soundIDs.length;l++){if(i.soundIDs[l]==k){i.soundIDs.splice(l,1);continue}}i.sounds[k].unload();if(!j){i.sounds[k].destruct()}delete i.sounds[k]};this.destroyVideo=this.destroySound;this.load=function(j,k){if(!i._idCheck(j)){return false}i.sounds[j].load(k)};this.unload=function(j){if(!i._idCheck(j)){return false}i.sounds[j].unload()};this.play=function(j,k){if(!i._didInit){throw i._complain(b+i._str("notReady"),arguments.callee.caller)}if(!i._idCheck(j)){if(typeof k!="Object"){k={url:k}}if(k&&k.url){k.id=j;i.createSound(k)}else{return false}}i.sounds[j].play(k)};this.start=this.play;this.setPosition=function(j,k){if(!i._idCheck(j)){return false}i.sounds[j].setPosition(k)};this.stop=function(j){if(!i._idCheck(j)){return false}i.sounds[j].stop()};this.stopAll=function(){for(var j in i.sounds){if(i.sounds[j] instanceof d){i.sounds[j].stop()}}};this.pause=function(j){if(!i._idCheck(j)){return false}i.sounds[j].pause()};this.pauseAll=function(){for(var j=i.soundIDs.length;j--;){i.sounds[i.soundIDs[j]].pause()}};this.resume=function(j){if(!i._idCheck(j)){return false}i.sounds[j].resume()};this.resumeAll=function(){for(var j=i.soundIDs.length;j--;){i.sounds[i.soundIDs[j]].resume()}};this.togglePause=function(j){if(!i._idCheck(j)){return false}i.sounds[j].togglePause()};this.setPan=function(j,k){if(!i._idCheck(j)){return false}i.sounds[j].setPan(k)};this.setVolume=function(k,j){if(!i._idCheck(k)){return false}i.sounds[k].setVolume(j)};this.mute=function(j){if(typeof j!="string"){j=null}if(!j){for(var k=i.soundIDs.length;k--;){i.sounds[i.soundIDs[k]].mute()}i.muted=true}else{if(!i._idCheck(j)){return false}i.sounds[j].mute()}};this.muteAll=function(){i.mute()};this.unmute=function(j){if(typeof j!="string"){j=null}if(!j){for(var k=i.soundIDs.length;k--;){i.sounds[i.soundIDs[k]].unmute()}i.muted=false}else{if(!i._idCheck(j)){return false}i.sounds[j].unmute()}};this.unmuteAll=function(){i.unmute()};this.toggleMute=function(j){if(!i._idCheck(j)){return false}i.sounds[j].toggleMute()};this.getMemoryUse=function(){if(i.flashVersion==8){return 0}if(i.o){return parseInt(i.o._getMemoryUse(),10)}};this.disable=function(k){if(typeof k=="undefined"){k=false}if(i._disabled){return false}i._disabled=true;for(var j=i.soundIDs.length;j--;){i._disableObject(i.sounds[i.soundIDs[j]])}i.initComplete(k)};this.canPlayURL=function(j){return(j?(j.match(i.filePattern)?true:false):null)};this.getSoundById=function(k,l){if(!k){throw new Error("SoundManager.getSoundById(): sID is null/undefined")}var j=i.sounds[k];if(!j&&!l){}return j};this.onready=function(k,j){if(k&&k instanceof Function){if(i._didInit){}if(!j){j=window}i._addOnReady(k,j);i._processOnReady();return true}else{throw i._str("needFunction")}};this.oninitmovie=function(){};this.onload=function(){soundManager._wD("soundManager.onload()",1)};this.onerror=function(){};this._idCheck=this.getSoundById;this._complain=function(k,m){var l="Error: ";if(!m){return new Error(l+k)}var o=new Error("");var p=null;if(o.stack){try{var q="@";var r=o.stack.split(q);p=r[4]}catch(n){p=o.stack}}if(typeof console!="undefined"&&typeof console.trace!="undefined"){console.trace()}var j=l+k+". \nCaller: "+m.toString()+(o.stack?" \nTop of stacktrace: "+p:(o.message?" \nMessage: "+o.message:""));return new Error(j)};var g=function(){return false};g._protected=true;this._disableObject=function(k){for(var j in k){if(typeof k[j]=="function"&&typeof k[j]._protected=="undefined"){k[j]=g}}j=null};this._failSafely=function(j){if(typeof j=="undefined"){j=false}if(!i._disabled||j){i.disable(j)}};this._normalizeMovieURL=function(j){var k=null;if(j){if(j.match(/\.swf(\?.*)?$/i)){k=j.substr(j.toLowerCase().lastIndexOf(".swf?")+4);if(k){return j}}else{if(j.lastIndexOf("/")!=j.length-1){j=j+"/"}}}return(j&&j.lastIndexOf("/")!=-1?j.substr(0,j.lastIndexOf("/")+1):"./")+i.movieURL};this._getDocument=function(){return(document.body?document.body:(document.documentElement?document.documentElement:document.getElementsByTagName("div")[0]))};this._getDocument._protected=true;this._setPolling=function(j,k){if(!i.o||!i.allowPolling){return false}i.o._setPolling(j,k)};this._createMovie=function(q,n){var p=null;var w=(n?n:i.url);var m=(i.altURL?i.altURL:w);if(i._didAppend&&i._appendSuccess){return false}i._didAppend=true;i._setVersionInfo();i.url=i._normalizeMovieURL(i._overHTTP?w:m);n=i.url;if(i.useHighPerformance&&i.useMovieStar&&i.defaultOptions.useVideo===true){p="soundManager note: disabling highPerformance, not applicable with movieStar mode+useVideo";i.useHighPerformance=false}i.wmode=(!i.wmode&&i.useHighPerformance&&!i.useMovieStar?"transparent":i.wmode);if(i.wmode!==null&&i.flashLoadTimeout!==0&&(!i.useHighPerformance||i.debugFlash)&&!i.isIE&&navigator.platform.match(/win32/i)){i.specialWmodeCase=true;i.wmode=null}if(i.flashVersion==8){i.allowFullScreen=false}var u={name:q,id:q,src:n,width:"100%",height:"100%",quality:"high",allowScriptAccess:i.allowScriptAccess,bgcolor:i.bgColor,pluginspage:"http://www.macromedia.com/go/getflashplayer",type:"application/x-shockwave-flash",wmode:i.wmode,allowfullscreen:(i.allowFullScreen?"true":"false")};if(i.debugFlash){u.FlashVars="debug=1"}if(!i.wmode){delete u.wmode}var l=null;var v=null;var j=null;var t=null;if(i.isIE){l=document.createElement("div");j='<object id="'+q+'" data="'+n+'" type="'+u.type+'" width="'+u.width+'" height="'+u.height+'"><param name="movie" value="'+n+'" /><param name="AllowScriptAccess" value="'+i.allowScriptAccess+'" /><param name="quality" value="'+u.quality+'" />'+(i.wmode?'<param name="wmode" value="'+i.wmode+'" /> ':"")+'<param name="bgcolor" value="'+i.bgColor+'" /><param name="allowFullScreen" value="'+u.allowFullScreen+'" />'+(i.debugFlash?'<param name="FlashVars" value="'+u.FlashVars+'" />':"")+"<!-- --></object>"}else{l=document.createElement("embed");for(v in u){if(u.hasOwnProperty(v)){l.setAttribute(v,u[v])}}}var r=null;var B=null;if(i.debugMode){r=document.createElement("div");r.id=i.debugID+"-toggle";B={position:"fixed",bottom:"0px",right:"0px",width:"1.2em",height:"1.2em",lineHeight:"1.2em",margin:"2px",textAlign:"center",border:"1px solid #999",cursor:"pointer",background:"#fff",color:"#333",zIndex:10001};r.appendChild(document.createTextNode("-"));r.onclick=i._toggleDebug;r.title="Toggle SM2 debug console";if(navigator.userAgent.match(/msie 6/i)){r.style.position="absolute";r.style.cursor="hand"}for(v in B){if(B.hasOwnProperty(v)){r.style[v]=B[v]}}}var k=i._getDocument();if(k){i.oMC=f("sm2-container")?f("sm2-container"):document.createElement("div");var o=(i.debugMode?" sm2-debug":"")+(i.debugFlash?" flash-debug":"");if(!i.oMC.id){i.oMC.id="sm2-container";i.oMC.className="movieContainer"+o;var A=null;t=null;if(i.useHighPerformance){A={position:"fixed",width:"8px",height:"8px",bottom:"0px",left:"0px",overflow:"hidden"}}else{A={position:"absolute",width:"8px",height:"8px",top:"-9999px",left:"-9999px"}}var z=null;if(!i.debugFlash){for(z in A){if(A.hasOwnProperty(z)){i.oMC.style[z]=A[z]}}}try{if(!i.isIE){i.oMC.appendChild(l)}k.appendChild(i.oMC);if(i.isIE){t=i.oMC.appendChild(document.createElement("div"));t.className="sm2-object-box";t.innerHTML=j}i._appendSuccess=true}catch(y){throw new Error(i._str("appXHTML"))}}else{if(i.debugMode||i.debugFlash){i.oMC.className+=o}i.oMC.appendChild(l);if(i.isIE){t=i.oMC.appendChild(document.createElement("div"));t.className="sm2-object-box";t.innerHTML=j}i._appendSuccess=true}k=null}if(p){}};this._writeDebug=function(j,l,k){};this._writeDebug._protected=true;this._wdCount=0;this._wdCount._protected=true;this._wD=this._writeDebug;this._debug=function(){for(var l=0,k=i.soundIDs.length;l<k;l++){i.sounds[i.soundIDs[l]]._debug()}};this._debugTS=function(m,j,k){if(typeof sm2Debugger!="undefined"){try{sm2Debugger.handleEvent(m,j,k)}catch(l){}}};this._debugTS._protected=true;this._mergeObjects=function(k,j){var n={};for(var l in k){if(k.hasOwnProperty(l)){n[l]=k[l]}}var m=(typeof j=="undefined"?i.defaultOptions:j);for(var p in m){if(m.hasOwnProperty(p)&&typeof n[p]=="undefined"){n[p]=m[p]}}return n};this.createMovie=function(j){if(j){i.url=j}i._initMovie()};this.go=this.createMovie;this._initMovie=function(){if(i.o){return false}i.o=i.getMovie(i.id);if(!i.o){if(!i.oRemoved){i._createMovie(i.id,i.url)}else{if(!i.isIE){i.oMC.appendChild(i.oRemoved)}else{i.oMC.innerHTML=i.oRemovedHTML}i.oRemoved=null;i._didAppend=true}i.o=i.getMovie(i.id)}if(i.o){if(i.flashLoadTimeout>0){}}if(typeof i.oninitmovie=="function"){setTimeout(i.oninitmovie,1)}};this.waitForExternalInterface=function(){if(i._waitingForEI){return false}i._waitingForEI=true;if(i._tryInitOnFocus&&!i._isFocused){return false}if(i.flashLoadTimeout>0){if(!i._didInit){var j=i.getMoviePercent()}setTimeout(function(){var k=i.getMoviePercent();if(!i._didInit){if(!i._overHTTP){if(!i.debugFlash){}}if(k===0){}i._debugTS("flashtojs",false,": Timed out"+(i._overHTTP)?" (Check flash security or flash blockers)":" (No plugin/missing SWF?)")}if(!i._didInit&&i._okToDisable){i._failSafely(true)}},i.flashLoadTimeout)}else{if(!i._didInit){}}};this.getMoviePercent=function(){return(i.o&&typeof i.o.PercentLoaded!="undefined"?i.o.PercentLoaded():null)};this.handleFocus=function(){if(i._isFocused||!i._tryInitOnFocus){return true}i._okToDisable=true;i._isFocused=true;if(i._tryInitOnFocus){window.removeEventListener("mousemove",i.handleFocus,false)}i._waitingForEI=false;setTimeout(i.waitForExternalInterface,500);if(window.removeEventListener){window.removeEventListener("focus",i.handleFocus,false)}else{if(window.detachEvent){window.detachEvent("onfocus",i.handleFocus)}}};this.initComplete=function(j){if(i._didInit){return false}i._didInit=true;if(i._disabled||j){i._processOnReady();i._debugTS("onload",false);i.onerror.apply(window);return false}else{i._debugTS("onload",true)}if(i.waitForWindowLoad&&!i._windowLoaded){if(window.addEventListener){window.addEventListener("load",i._initUserOnload,false)}else{if(window.attachEvent){window.attachEvent("onload",i._initUserOnload)}}return false}else{if(i.waitForWindowLoad&&i._windowLoaded){}i._initUserOnload()}};this._addOnReady=function(k,j){i._onready.push({method:k,scope:(j||null),fired:false})};this._processOnReady=function(){if(!i._didInit){return false}var l={success:(!i._disabled)};var k=[];for(var n=0,m=i._onready.length;n<m;n++){if(i._onready[n].fired!==true){k.push(i._onready[n])}}if(k.length){for(n=0,m=k.length;n<m;n++){if(k[n].scope){k[n].method.apply(k[n].scope,[l])}else{k[n].method(l)}k[n].fired=true}}};this._initUserOnload=function(){window.setTimeout(function(){i._processOnReady();i.onload.apply(window)})};this.init=function(){i._initMovie();if(i._didInit){return false}if(window.removeEventListener){window.removeEventListener("load",i.beginDelayedInit,false)}else{if(window.detachEvent){window.detachEvent("onload",i.beginDelayedInit)}}try{i.o._externalInterfaceTest(false);if(!i.allowPolling){}else{i._setPolling(true,i.useFastPolling?true:false)}if(!i.debugMode){i.o._disableDebug()}i.enabled=true;i._debugTS("jstoflash",true)}catch(j){i._debugTS("jstoflash",false);i._failSafely(true);i.initComplete();return false}i.initComplete()};this.beginDelayedInit=function(){i._windowLoaded=true;setTimeout(i.waitForExternalInterface,500);setTimeout(i.beginInit,20)};this.beginInit=function(){if(i._initPending){return false}i.createMovie();i._initMovie();i._initPending=true;return true};this.domContentLoaded=function(){if(document.removeEventListener){document.removeEventListener("DOMContentLoaded",i.domContentLoaded,false)}i.go()};this._externalInterfaceOK=function(j){if(i.swfLoaded){return false}var k=new Date().getTime();i._debugTS("swf",true);i._debugTS("flashtojs",true);i.swfLoaded=true;i._tryInitOnFocus=false;if(i.isIE){setTimeout(i.init,100)}else{i.init()}};this._setSandboxType=function(j){var k=i.sandbox;k.type=j;k.description=k.types[(typeof k.types[j]!="undefined"?j:"unknown")];if(k.type=="localWithFile"){k.noRemote=true;k.noLocal=false}else{if(k.type=="localWithNetwork"){k.noRemote=false;k.noLocal=true}else{if(k.type=="localTrusted"){k.noRemote=false;k.noLocal=false}}}};this.reboot=function(){if(i.soundIDs.length){}for(var j=i.soundIDs.length;j--;){i.sounds[i.soundIDs[j]].destruct()}try{if(i.isIE){i.oRemovedHTML=i.o.innerHTML}i.oRemoved=i.o.parentNode.removeChild(i.o)}catch(k){}i.oRemovedHTML=null;i.oRemoved=null;i.enabled=false;i._didInit=false;i._waitingForEI=false;i._initPending=false;i._didAppend=false;i._appendSuccess=false;i._disabled=false;i._waitingforEI=true;i.swfLoaded=false;i.soundIDs={};i.sounds=[];i.o=null;for(j=i._onready.length;j--;){i._onready[j].fired=false}window.setTimeout(soundManager.beginDelayedInit,20)};this.destruct=function(){i.disable(true)};d=function(j){var k=this;this.sID=j.id;this.url=j.url;this.options=i._mergeObjects(j);this.instanceOptions=this.options;this._iO=this.instanceOptions;this.pan=this.options.pan;this.volume=this.options.volume;this._lastURL=null;this._debug=function(){};this._debug();this.id3={};this.resetProperties=function(l){k.bytesLoaded=null;k.bytesTotal=null;k.position=null;k.duration=null;k.durationEstimate=null;k.loaded=false;k.playState=0;k.paused=false;k.readyState=0;k.muted=false;k.didBeforeFinish=false;k.didJustBeforeFinish=false;k.isBuffering=false;k.instanceOptions={};k.instanceCount=0;k.peakData={left:0,right:0};k.waveformData={left:[],right:[]};k.eqData=[];k.eqData.left=[];k.eqData.right=[]};k.resetProperties();this.load=function(l){if(typeof l!="undefined"){k._iO=i._mergeObjects(l);k.instanceOptions=k._iO}else{l=k.options;k._iO=l;k.instanceOptions=k._iO;if(k._lastURL&&k._lastURL!=k.url){k._iO.url=k.url;k.url=null}}if(typeof k._iO.url=="undefined"){k._iO.url=k.url}if(k._iO.url==k.url&&k.readyState!==0&&k.readyState!=2){return false}k.url=k._iO.url;k._lastURL=k._iO.url;k.loaded=false;k.readyState=1;k.playState=0;try{if(i.flashVersion==8){i.o._load(k.sID,k._iO.url,k._iO.stream,k._iO.autoPlay,(k._iO.whileloading?1:0))}else{i.o._load(k.sID,k._iO.url,k._iO.stream?true:false,k._iO.autoPlay?true:false);if(k._iO.isMovieStar&&k._iO.autoLoad&&!k._iO.autoPlay){k.pause()}}}catch(m){i._debugTS("onload",false);i.onerror();i.disable()}};this.unload=function(){if(k.readyState!==0){if(k.readyState!=2){k.setPosition(0,true)}i.o._unload(k.sID,i.nullURL);k.resetProperties()}};this.destruct=function(){i.o._destroySound(k.sID);i.destroySound(k.sID,true)};this.play=function(m){if(!m){m={}}k._iO=i._mergeObjects(m,k._iO);k._iO=i._mergeObjects(k._iO,k.options);k.instanceOptions=k._iO;if(k.playState==1){var l=k._iO.multiShot;if(!l){return false}else{}}if(!k.loaded){if(k.readyState===0){k._iO.autoPlay=true;k.load(k._iO)}else{if(k.readyState==2){return false}else{}}}else{}if(k.paused){k.resume()}else{k.playState=1;if(!k.instanceCount||i.flashVersion>8){k.instanceCount++}k.position=(typeof k._iO.position!="undefined"&&!isNaN(k._iO.position)?k._iO.position:0);if(k._iO.onplay){k._iO.onplay.apply(k)}k.setVolume(k._iO.volume,true);k.setPan(k._iO.pan,true);i.o._start(k.sID,k._iO.loop||1,(i.flashVersion==9?k.position:k.position/1000))}};this.start=this.play;this.stop=function(l){if(k.playState==1){k.playState=0;k.paused=false;if(k._iO.onstop){k._iO.onstop.apply(k)}i.o._stop(k.sID,l);k.instanceCount=0;k._iO={}}};this.setPosition=function(m,l){if(typeof m=="undefined"){m=0}var n=Math.min(k.duration,Math.max(m,0));k._iO.position=n;if(!l){}i.o._setPosition(k.sID,(i.flashVersion==9?k._iO.position:k._iO.position/1000),(k.paused||!k.playState))};this.pause=function(){if(k.paused||k.playState===0){return false}k.paused=true;i.o._pause(k.sID);if(k._iO.onpause){k._iO.onpause.apply(k)}};this.resume=function(){if(!k.paused||k.playState===0){return false}k.paused=false;i.o._pause(k.sID);if(k._iO.onresume){k._iO.onresume.apply(k)}};this.togglePause=function(){if(k.playState===0){k.play({position:(i.flashVersion==9?k.position:k.position/1000)});return false}if(k.paused){k.resume()}else{k.pause()}};this.setPan=function(m,l){if(typeof m=="undefined"){m=0}if(typeof l=="undefined"){l=false}i.o._setPan(k.sID,m);k._iO.pan=m;if(!l){k.pan=m}};this.setVolume=function(l,m){if(typeof l=="undefined"){l=100}if(typeof m=="undefined"){m=false}i.o._setVolume(k.sID,(i.muted&&!k.muted)||k.muted?0:l);k._iO.volume=l;if(!m){k.volume=l}};this.mute=function(){k.muted=true;i.o._setVolume(k.sID,0)};this.unmute=function(){k.muted=false;var l=typeof k._iO.volume!="undefined";i.o._setVolume(k.sID,l?k._iO.volume:k.options.volume)};this.toggleMute=function(){if(k.muted){k.unmute()}else{k.mute()}};this._whileloading=function(l,m,n){if(!k._iO.isMovieStar){k.bytesLoaded=l;k.bytesTotal=m;k.duration=Math.floor(n);k.durationEstimate=parseInt((k.bytesTotal/k.bytesLoaded)*k.duration,10);if(k.durationEstimate===undefined){k.durationEstimate=k.duration}if(k.readyState!=3&&k._iO.whileloading){k._iO.whileloading.apply(k)}}else{k.bytesLoaded=l;k.bytesTotal=m;k.duration=Math.floor(n);k.durationEstimate=k.duration;if(k.readyState!=3&&k._iO.whileloading){k._iO.whileloading.apply(k)}}};this._onid3=function(o,l){var p=[];for(var n=0,m=o.length;n<m;n++){p[o[n]]=l[n]}k.id3=i._mergeObjects(k.id3,p);if(k._iO.onid3){k._iO.onid3.apply(k)}};this._whileplaying=function(n,o,q,m,p){if(isNaN(n)||n===null){return false}if(k.playState===0&&n>0){n=0}k.position=n;if(i.flashVersion>8){if(k._iO.usePeakData&&typeof o!="undefined"&&o){k.peakData={left:o.leftPeak,right:o.rightPeak}}if(k._iO.useWaveformData&&typeof q!="undefined"&&q){k.waveformData={left:q.split(","),right:m.split(",")}}if(k._iO.useEQData){if(typeof p!="undefined"&&p.leftEQ){var l=p.leftEQ.split(",");k.eqData=l;k.eqData.left=l;if(typeof p.rightEQ!="undefined"&&p.rightEQ){k.eqData.right=p.rightEQ.split(",")}}}}if(k.playState==1){if(k.isBuffering){k._onbufferchange(0)}if(k._iO.whileplaying){k._iO.whileplaying.apply(k)}if(k.loaded&&k._iO.onbeforefinish&&k._iO.onbeforefinishtime&&!k.didBeforeFinish&&k.duration-k.position<=k._iO.onbeforefinishtime){k._onbeforefinish()}}};this._onload=function(l){l=(l==1?true:false);if(!l){if(i.sandbox.noRemote===true){}if(i.sandbox.noLocal===true){}}k.loaded=l;k.readyState=l?3:2;if(k._iO.onload){k._iO.onload.apply(k)}};this._onbeforefinish=function(){if(!k.didBeforeFinish){k.didBeforeFinish=true;if(k._iO.onbeforefinish){k._iO.onbeforefinish.apply(k)}}};this._onjustbeforefinish=function(l){if(!k.didJustBeforeFinish){k.didJustBeforeFinish=true;if(k._iO.onjustbeforefinish){k._iO.onjustbeforefinish.apply(k)}}};this._onfinish=function(){if(k._iO.onbeforefinishcomplete){k._iO.onbeforefinishcomplete.apply(k)}k.didBeforeFinish=false;k.didJustBeforeFinish=false;if(k.instanceCount){k.instanceCount--;if(!k.instanceCount){k.playState=0;k.paused=false;k.instanceCount=0;k.instanceOptions={}}if(!k.instanceCount||k._iO.multiShotEvents){if(k._iO.onfinish){k._iO.onfinish.apply(k)}}}else{if(k.useVideo){}}};this._onmetadata=function(l){if(!l.width&&!l.height){l.width=320;l.height=240}k.metadata=l;k.width=l.width;k.height=l.height;if(k._iO.onmetadata){k._iO.onmetadata.apply(k)}};this._onbufferchange=function(l){if(k.playState===0){return false}if(l==k.isBuffering){return false}k.isBuffering=(l==1?true:false);if(k._iO.onbufferchange){k._iO.onbufferchange.apply(k)}};this._ondataerror=function(l){if(k.playState>0){if(k._iO.ondataerror){k._iO.ondataerror.apply(k)}}else{}}};this._onfullscreenchange=function(j){i.isFullScreen=(j==1?true:false);if(!i.isFullScreen){try{window.focus()}catch(k){}}};if(window.addEventListener){window.addEventListener("focus",i.handleFocus,false);window.addEventListener("load",i.beginDelayedInit,false);window.addEventListener("unload",i.destruct,false);if(i._tryInitOnFocus){window.addEventListener("mousemove",i.handleFocus,false)}}else{if(window.attachEvent){window.attachEvent("onfocus",i.handleFocus);window.attachEvent("onload",i.beginDelayedInit);window.attachEvent("unload",i.destruct)}else{i._debugTS("onload",false);soundManager.onerror();soundManager.disable()}}if(document.addEventListener){document.addEventListener("DOMContentLoaded",i.domContentLoaded,false)}}if(typeof SM2_DEFER=="undefined"||!SM2_DEFER){soundManager=new SoundManager()};
;if(typeof hipchat=='undefined'){hipchat={};}
hipchat.log=function(level,msg){if(typeof console!='undefined'&&config.logging){level=level.toUpperCase();var date=new Date();var time=date.toLocaleTimeString()+'.'+date.getMilliseconds();switch(level){case'INFO':case'DEBUG':console.log('['+level+'] ['+time+'] '+msg);break;case'WARN':console.warn('['+level+'] ['+time+'] '+msg);break;case'ERROR':case'ALERT':console.error('['+level+'] ['+time+'] '+msg);break;default:console.log('['+level+'] ['+time+'] '+msg);break;}}};chat={MAX_ROSTER_CHARS:24,MAX_TAB_CHARS:15,MIN_TAB_CHARS:2,MESSAGE_UNCONFIRMED_MS:8000,PRESENCE_LABEL_AVAILABLE:'Available',PRESENCE_LABEL_AWAY:'Away',PRESENCE_LABEL_DND:'Do not disturb',PRESENCE_LABEL_UNAVAILABLE:'Unavailable',STATUS_PLACEHOLDER_TEXT_COLOR:'#999999',UPLOAD_SERVER:'uploads.hipchat.com',ACTIVE_STATE:'active',COMPOSING_STATE:'composing',GONE_STATE:'gone',INACTIVE_STATE:'inactive',CHAT_STATE_SELECTOR:'active, inactive, composing, gone',chat_displays:[],chat_states:[],chat_state_timers:[],chats_anchor_ids:[],chats_divider_times:[],chats_fully_loaded:[],chats_initial_message:[],chats_last_activity:[],chats_last_from:[],chats_oldest_message_time:[],chats_preload_events:[],chats_scroll:[],chats_scroll_at_bottom:[],current_block_ids:[],current_block_id:0,current_message_id:0,current_tab_truncate_len:15,file_reader:null,is_focused:true,is_notifying:false,last_notif:null,name_tag_regex:null,notif_count:0,notification_sound:null,page_title:'',tmp_perms:[],unconfirmed_messages:[],unread_count:0,upload_data:{},uploader:null,window_blink_timeout:null,events:$(document),add_chat_display:function(jid,text){jid=util.jid.bare_jid(jid);if($('#chats div[name="'+util.jid.sanitize(jid)+'"]').length>0){hipchat.log('debug','Tried creating a chat that already exists');return null;}
if(!text){text=app.get_display_name(jid,true);}
hipchat.log('debug','Creating new chat display: '+jid);var is_room=util.jid.is_room(jid);var node_name=(is_room?util.jid.room_name(jid):util.jid.user_id(jid));var history_load_link='<div class="historyLink loadLink" style="display: none">';history_load_link+='<img src="/img/chat/spinner.gif" />';history_load_link+='</div>';var history_show_link='<div class="historyLink showLink" style="display: none">';history_show_link+='<span style="color: #0000ff;">&#x25BE;</span>&nbsp;&nbsp;<a href="javascript:;" onclick="return false;">Show chat history</a>';history_show_link+='</div>';var chat_text='<div class="chatText"></div>';var chat_state='<div class="chatState chatBlock infoBlock"></div>';var new_chat=$(document.createElement('div'));new_chat.attr('name',jid);new_chat.addClass('chat_display');new_chat.append(history_load_link);new_chat.append(history_show_link);new_chat.append(chat_text);new_chat.append(chat_state);new_chat.hide();new_chat.on('scroll',$.proxy(this,'handle_chat_scroll'));new_chat.find('div.showLink').click($.proxy(this,'show_chat_history'));$('#chats').append(new_chat);this.chat_displays[jid]=new_chat;this.chat_states[jid]=this.ACTIVE_STATE;this.chats_anchor_ids[jid]=null;this.chats_divider_times[jid]=new Date().getTime();this.current_block_ids[jid]=null;this.chats_fully_loaded[jid]=false;this.chats_last_activity[jid]=null;this.chats_last_from[jid]=null;this.chats_oldest_message_time[jid]=new Date().getTime();this.chats_preload_events[jid]=[];this.chats_scroll[jid]=-1;this.chats_scroll_at_bottom[jid]=true;this.add_tab(jid,text);if(util.jid.is_private_chat(jid)){app.send_chat_state_message(jid,this.ACTIVE_STATE);}
this.save_tabs_to_auto_join();this.check_tab_scroll();return new_chat;},add_chat_text:function(jid,text,type,args){var chat_display=this.chat_displays[jid];if(!chat_display){hipchat.log('warn','Call to add text without chat_display available - doing nothing');return;}
if(!text){return;}
if(app.chat_is_loading[jid]){this.chats_preload_events[jid].push({text:text,type:type,args:args});return;}
var now=(new Date()).getTime();var message_time=(args.time?args.time:now);var last_active=this.chats_last_activity[jid];var from=(args.from?args.from:null);var do_escape=(type!='system');var insert_on_top=false;if(!args.is_current&&last_active&&last_active>message_time){insert_on_top=true;}
args.insert_on_top=insert_on_top;if(from&&!args.display_name){args.display_name=app.get_display_name(from,true);}
args.jid=jid;if(type=='chat'&&text.match(/^(\/me |\/em )/)){type='info';text=app.get_display_name(from)+text.substr(3);}
if(type=='chat'&&text.match(/^(\/quote )/)){args.monospace=true;text=text.substr(7);}
if(type=='chat'&&text.match(/^(\/code )/)){args.monospace=true;args.code=true;text=text.substr(6);}
if(from&&type=='chat'&&text.match(/^(\/skype)/)){var skype_link_matches=/skype:\S+&token=([^&]+)/.exec(text);if(skype_link_matches&&skype_link_matches.length==2){type='info';var skype_link=skype_link_matches[0];var conference_name=skype_link_matches[1];text=app.get_display_name(from)+' started a Skype conference: <a href="'+skype_link+'">'+decodeURIComponent(conference_name)+'</a>';do_escape=false;}}
if(args.monospace){text=helpers.format_multiline_block(text);}
matches=[];var do_linkify=(do_escape&&!args.monospace);var do_emoticons=(do_escape&&!args.monospace&&this.emoticons_enabled);var do_mentions=(!args.monospace&&do_escape);var do_word_breaks=do_escape;var body=helpers.escape_and_linkify(text,{escape_whitespace:do_escape,name_tag_regex:this.name_tag_regex,mention_regex:args.mention_regex,matches:matches,do_escape:do_escape,do_linkify:do_linkify,do_emoticons:do_emoticons,do_word_breaks:do_word_breaks,do_mentions:do_mentions});if(do_escape){body=helpers.truncate_paste(body);}
var last_active_date=(insert_on_top?new Date(this.chats_oldest_message_time[jid]):new Date(last_active));var message_date=new Date(message_time);if(last_active&&(message_date.getDate()!=last_active_date.getDate()||message_date.getMonth()!=last_active_date.getMonth()||message_date.getFullYear()!=last_active_date.getFullYear())){this.add_date_divider(jid,message_date,insert_on_top);}
if(!util.jid.is_room(jid)&&this.chats_divider_times[jid]&&this.chats_divider_times[jid]<=message_time){this.add_chat_divider(jid);}
var last_message_from=this.chats_last_from[jid];if(args.is_echo===true){this.add_preview_data(jid,type,args);}else if(!helpers.is_block_chat_type(type)&&!args.monospace&&!insert_on_top&&from&&last_active&&(message_time-last_active)<(60*1000)&&last_message_from==from){this.add_chat_line(jid,body,args);this.add_preview_data(jid,type,args);}else{this.add_chat_block(jid,body,type,args);this.add_preview_data(jid,type,args);}
var is_notify_type=(jQuery.inArray(type,['chat','file'])!=-1);if(type=='system'){is_notify_type=args.sys_notify;}
if(args.do_notify&&args.is_current&&is_notify_type){this.notify(jid,from,text);}
if(!this.chats_oldest_message_time[jid]||message_time<this.chats_oldest_message_time[jid]){this.chats_oldest_message_time[jid]=message_time;}
if(args.is_current||message_time>last_active){this.chats_last_activity[jid]=message_time;if(!helpers.is_block_chat_type(type)&&from){this.chats_last_from[jid]=from;}else{this.chats_last_from[jid]=null;}}
if(jid!=app.current_jid&&args.is_current&&from!=app.current_user_jid&&is_notify_type){var nav_link=$('#tabs li[name="tab_'+util.jid.sanitize(jid)+'"]');nav_link.toggleClass('alert',true);}},add_chat_block:function(jid,body,type,args){var chat_display=this.chat_displays[jid];if(!chat_display){hipchat.log('warn','Call to add text without chat_display available - doing nothing');return;}
var class_name='them';var from=(args.from?util.jid.bare_jid(args.from):null);if(from){if(from==util.jid.bare_jid(app.current_user_jid)||from==app.current_user_nickname_jid){class_name='me';}}
if(args.monospace){class_name+=' monospace';}
this.current_block_id++;this.current_block_ids[jid]=this.current_block_id;var block_id='block'+this.current_block_id;var html;if(!args.class_name){args.class_name='';}
args.class_name+=' '+class_name;args.block_id=block_id;switch(type){case'chat':case'image':case'link':case'twitter_status':case'twitter_user':case'video':case'youtube_video':html=this.get_chat_html(body,args);break;case'file':html=this.get_file_html(body,args);break;case'info':html=this.get_info_html(body,args);break;case'system':html=this.get_system_html(body,args);break;case'welcome':html=this.get_welcome_html(body,args);break;default:html='';hipchat.log('error','Unknown chat text type: '+type);break;}
var new_div=document.createElement('div');new_div.innerHTML=html;this.add_link_listeners(new_div);this.add_mention_tooltips(new_div);var do_scroll=(!app.chat_is_loading[jid]&&this.scroll_at_bottom(jid));if(args.insert_on_top){new_div.className='previousHistory';new_div.style.display='none';chat_display.find('.chatText > :first').before(new_div);}else{chat_display.find('.chatText').append(new_div);}
if(do_scroll){this.scroll_chat(jid);}
if(args.code){prettyPrint();}},add_chat_line:function(jid,body,args){var chat_display=this.chat_displays[jid];var class_name='msgText non-first';if(args.monospace){class_name+=' monospace';}
var current_block_id='block'+this.current_block_ids[jid];var current_block=$('#'+current_block_id);var new_line=$(document.createElement('p'));new_line.attr('class',class_name);if(args.message_id){new_line.attr('id',args.message_id);}
new_line.html(body);this.add_link_listeners(new_line);this.add_mention_tooltips(new_line);var do_scroll=(!app.chat_is_loading[jid]&&this.scroll_at_bottom(jid));current_block.append(new_line);if(do_scroll){this.scroll_chat(jid);}
if(args.code){prettyPrint();}},add_emoticon_tooltips:function(div){},add_link_listeners:function(node){var self=this;$(node).find('a').each(function(idx,elem){var link=$(elem);var href=link.attr('href');if(href&&href.substr(0,4).toLowerCase()=='http'){link.attr('target','_blank');}
if(link.attr('name')=='truncate'){link.click($.proxy(helpers,'handle_truncated_link'));}});},add_mention_tooltips:function(node){var self=this;$(node).find('span.atTag').tooltip({bodyHandler:chat.generate_mention_tooltip});},add_preview_data:function(jid,type,args){var html=null;var class_name=null;switch(type){case'image':html=this.get_image_html(args);break;case'link':class_name='linkBlock';html=this.get_link_html(args);break;case'twitter_status':case'twitter_user':html=this.get_twitter_html(args);class_name='linkBlock';break;case'video':case'youtube_video':html=this.get_video_html(args);class_name='linkBlock';break;default:break;}
if(html){var message_node=$('#'+args.message_id);if(!message_node){hipchat.error('Trying to add preview data but no message available for message ID: '+args.message_id);return;}
var preview_node=$(document.createElement('div'));preview_node.addClass('preview');preview_node.html(html);if(class_name){message_node.closest('.chatBlock').addClass(class_name);}
message_node.after(preview_node);var do_scroll=(!app.chat_is_loading[jid]&&this.scroll_at_bottom(jid));if(do_scroll){this.scroll_chat(jid);}}},add_tab:function(jid,text){jid=util.jid.bare_jid(jid);var state_class='';if(util.jid.is_room(jid)){var room_info=app.get_room_data(jid);state_class=(room_info?room_info.privacy:'public');}else{var user_info=app.get_user_info(jid);var status_info=this.get_status_info(user_info,false);state_class=status_info.show;}
var tab=$(document.createElement('li'));tab.attr('name','tab_'+jid);tab.attr('jid',jid);tab.append('<a class="open" href="javascript:;"><span class="'+state_class+'">'+helpers.truncate(util.htmlentities(text),this.current_tab_truncate_len)+'</span></a>');if(!config.is_guest){tab.append('<a class="close" href="javascript:;"><img src="/img/chat/icon_close_light.png" width="13" height="14" /></a>');tab.find('a.close').click(function(){chat.close_chat(jid,null,true);return false;}).mouseover(function(){$(this).find('img').attr('src','/img/chat/icon_close_dark.png');}).mouseout(function(){$(this).find('img').attr('src','/img/chat/icon_close_light.png');});}
tab.find('a.open').click(function(){chat.focus_chat(jid,text);return false;});tab.mouseover(function(){$(this).toggleClass('hover',true);}).mouseout(function(){$(this).toggleClass('hover',false);});$('#tabs').append(tab);},check_message_archive:function(msg,from,args){var archive_node=msg.find('x[xmlns="http://hipchat.com"] is_archived');if(archive_node.length>0){var state=archive_node.text()=='1'?true:false;room_data=app.get_room_data(from);name=app.get_display_name(args.from);args.message_type='info';args.notify=false;if(args.is_current){room_data.is_archived=state;}
if(state){args.body=name+' archived the room';}else{args.body=name+' unarchived the room';}}},check_message_file:function(msg,from,args){var file_node=msg.find('file:first');if(file_node.length>0){args.message_type='file';args.file_data=file_node;}},check_message_guest_url:function(msg,from,args){var name='';var room_data=null;var guest_access_node=msg.find('x[xmlns="http://hipchat.com"] guest_url');if(guest_access_node.length>0){room_data=app.get_room_data(from);var url=guest_access_node.text();name=app.get_display_name(args.from);args.message_type='info';args.notify=false;if(url){if(args.is_current){room_data.guest_url=url;this.enable_guest_access(url);}
args.body=name+' turned on guest access';}else{if(args.is_current){room_data.guest_url=null;this.disable_guest_access();}
args.body=name+' turned off guest access';}}},check_message_metadata:function(msg,from,args){var metadata_nodes=msg.find('x[xmlns="http://hipchat.com"] metadata');if(metadata_nodes.length>0){args.message_type=$(metadata_nodes.get(0)).find('type').text();args.metadatas=metadata_nodes;}},check_message_subject:function(msg,from,args){if(msg.find('subject').length==0){return;}
if(!util.jid.resource(msg.attr('from'))){return;}
var topic=$(msg.find('subject')[0]).text();var name=args.display_name;if(name){args.message_type='info';if(topic.length>0){args.body=name+" changed the topic to: "+topic;}else{args.body=name+" cleared the topic.";}}
if(args.is_current){app.set_room_data(from,'topic',topic);if(from==app.current_jid){this.show_topic(topic);}}},check_system_message:function(msg,from,args){var muc_node=msg.find('x[xmlns="http://hipchat.com/protocol/muc#room"]');var type_node=muc_node.find('type:first');if(type_node.text()=='system'||type_node.text()=='announcement'){var color_node=muc_node.find('color:first');if(color_node){args.color=color_node.text();}
var message_format=muc_node.find('message_format:first').text();if(message_format=='text'){args.class_name='systemMessage systemMessage-'+args.color;}else{args.message_type='system';}
args.display_name=util.jid.resource(msg.attr('from'));var notify_node=muc_node.find('notify:first');if(notify_node&&notify_node.text()=='1'){args.sys_notify=true;}
if(args.do_notify&&args.sys_notify){args.do_notify=true;}else{args.do_notify=false;}}},check_tab_scroll:function(is_expanding){if(config.mobile||config.is_guest||config.vertical_tabs){return;}
var top_bar_width=($(document).width()-$('#action_tabs').width()-20-175-30);var current_width=0;var has_hidden_tabs=false;var hidden_tabs=[];var tabs=$('#tabs li');tabs.each(function(idx,elem){var tab=$(elem);if(!tab.is(':visible')){hidden_tabs.push(tab);has_hidden_tabs=true;}else{current_width+=tab.width();}});var width_difference=top_bar_width-current_width;var self=this;if(width_difference<0){if(this.current_tab_truncate_len==this.MIN_TAB_CHARS){}else{this.current_tab_truncate_len=this.current_tab_truncate_len-1;tabs.each(function(idx,e){var elem=$(e);if(elem.attr('name')=='tab_lobby'){return;}
elem.find('a:first span').text(helpers.truncate(app.get_display_name(elem.attr('jid'),true),self.current_tab_truncate_len));});if(is_expanding!==true){this.check_tab_scroll(false);}}}else if(has_hidden_tabs&&width_difference>40){for(var i in hidden_tabs){var htab=hidden_tabs[i];if(htab.width()<=width_difference){htab.show();hidden_tabs.pop();width_difference-=htab.width();current_width+=htab.width();}else{break;}}}else if(width_difference>(6*tabs.length)){if(this.current_tab_truncate_len<this.MAX_TAB_CHARS){this.current_tab_truncate_len=this.current_tab_truncate_len+1;tabs.each(function(idx,e){var elem=$(e);if(elem.attr('name')=='tab_lobby'){return;}
elem.find('a:first span').text(helpers.truncate(app.get_display_name(elem.attr('jid'),true),self.current_tab_truncate_len));});if(is_expanding!==false){this.check_tab_scroll(true);}}}},clear_data:function(){hipchat.log('debug','Clearing chat data');var self=this;$('#tabs > li[name!="tab_lobby"]').each(function(idx,elem){var tab=$(elem);self.close_chat(tab.attr('jid'),null,false,false);});this.current_tab_truncate_len=15;},clear_upload:function(){this.upload_data={};$('#upload_ui').html('').hide();$('#upload_progress').hide();$('.input .textwrapper').show();$('#upload_image_tooltip').hide();},close_chat:function(jid,leave_message,manual_close,send_leave_presence){manual_close=((typeof manual_close=='undefined')?false:true);send_leave_presence=((typeof send_leave_presence=='undefined')?true:false);if(config.is_guest){return;}
var bare_jid=util.jid.bare_jid(jid);hipchat.log('debug','Closing chat '+bare_jid);if(util.jid.node(jid)=='lobby'){return;}
if(typeof manual_close=='undefined'){manual_close=true;}
if(manual_close&&config.mobile&&!confirm('Are you sure you want to close the chat "'+app.get_display_name(jid)+'"?')){return;}
if(app.previous_jid&&util.jid.bare_jid(app.previous_jid)==bare_jid){app.previous_jid=null;}
if(util.jid.is_room(jid)){app.leave_room(jid,leave_message,send_leave_presence);}else{if(send_leave_presence){app.send_chat_state_message(jid,this.GONE_STATE);}}
var tabs=$('#tabs li');var previous_tab=null;for(var i=0;i<tabs.length;i++){var tab=$(tabs.get(i));if(tab.attr('name')=='tab_'+bare_jid){break;}
previous_tab=tab;}
$('#tabs li[name="tab_'+util.jid.sanitize(bare_jid)+'"]').remove();$('#chats div[name="'+util.jid.sanitize(bare_jid)+'"]').remove();this.chat_displays[bare_jid]=null;this.current_block_ids[bare_jid]=0;this.chats_last_activity[bare_jid]=null;this.chats_last_from[bare_jid]=null;if(!manual_close||(app.current_jid&&bare_jid!=util.jid.bare_jid(app.current_jid))){}else if($('#chats > div').length==0){this.show_lobby();}else if(previous_tab){this.focus_chat(previous_tab.attr('jid'));}
if(manual_close){this.save_tabs_to_auto_join();}
this.check_tab_scroll();},close_chats:function(){hipchat.log('debug','Closing all open chat tabs');var self=this;$.each(this.chat_displays,function(key,value){self.close_chat(key);});},close_current_chat:function(){this.close_chat(app.current_jid);},do_file_upload:function(){var self=this;var xhr=new XMLHttpRequest();xhr.open("POST","/api/upload_file",true);xhr.onload=function(event){self.handle_drag_drop_file_upload(xhr.responseXML);};if(typeof FormData!='undefined'){var form_data=new FormData();form_data.append('user_id',util.jid.user_id(app.current_user_jid));form_data.append('group_id',util.jid.group_id(app.current_user_jid));form_data.append('jid',app.current_jid);form_data.append('token',app.token_info.token);form_data.append('desc',$('#message_input').val());form_data.append('Filedata',this.upload_data.file,this.upload_data.filename);xhr.send(form_data);}else{var boundary='formboundary-'+(new Date()).getTime();var dashdash='--';var crlf='\r\n';var boundary_line=(dashdash+boundary+crlf);var file_data='';var get_var_data=function(name,val,boundary_line){var str=boundary_line;str+='Content-Disposition: form-data; name="'+name+'"';str+='\r\n';str+='\r\n';str+=val;str+='\r\n';return str;};file_data+=get_var_data('user_id',util.jid.user_id(app.current_user_jid),boundary_line);file_data+=get_var_data('group_id',util.jid.group_id(app.current_user_jid),boundary_line);file_data+=get_var_data('jid',app.current_jid,boundary_line);file_data+=get_var_data('token',app.token_info.token,boundary_line);file_data+=get_var_data('desc',$('#message_input').val(),boundary_line);var file=this.upload_data.file;file_data+=boundary_line;file_data+='Content-Disposition: file; name="Filedata"';if(file.name){file_data+='; filename="'+file.name+'"';}else{file_data+=";";}
file_data+=crlf;file_data+='Content-Type: application/octet-stream';file_data+=crlf;file_data+=crlf;file_data+=this.upload_data.binary_file;file_data+=crlf;file_data+=(dashdash+boundary+dashdash+crlf);xhr.setRequestHeader('content-type','multipart/form-data; boundary='+boundary);xhr.sendAsBinary(file_data);}},do_iframe_upload:function(){var upload_form=$('#file_drop_frame').contents().find('#upload_form');upload_form.find('input[name="user_id"]').val(util.jid.user_id(app.current_user_jid));upload_form.find('input[name="group_id"]').val(util.jid.group_id(app.current_user_jid));upload_form.find('input[name="jid"]').val(app.current_jid);upload_form.find('input[name="token"]').val(app.token_info.token);upload_form.find('input[name="desc"]').val($('#message_input').val());upload_form.submit();$('#file_drop_frame').one('load',$.proxy(this,'handle_iframe_upload_complete'));},do_show_private_chat:function(jid,config){this.update_profile(jid);$('#top_bar').attr('class','top_bar_private');$('#top_bar').find('.topic_container').hide();$('#search_button').hide();$('#room_actions_button').hide();$('#roster').hide();$('#sidebar .footer .guest_access').hide();$('#profile').show();$('#video_button').show();if($('#video_button').length===0||jid===config.user_jid){config.no_top_bar=true;$('#top_bar').hide();}else{config.no_top_bar=false;$('#top_bar').show();}
this.show_topic(null,false);var user_info=app.get_user_info(jid);if(user_info&&user_info.show==app.PRESENCE_SHOW_DND){this.add_chat_text(jid,user_info.name+' does not want to be disturbed.','info',{});}else if(user_info&&user_info.type==app.PRESENCE_TYPE_UNAVAILABLE){this.add_chat_text(jid,user_info.name+' is offline.','info',{});}},do_show_room:function(jid,conig){config.no_top_bar=false;this.update_roster(jid);$('#profile').hide();$('#roster h2').hide();$('#roster').show();$('#top_bar').attr('class','top_bar');$('#top_bar').find('.topic_container').show();if(!config.is_guest){$('#sidebar .footer .guest_access').show();$('#search_button').show();}
if(!config.mobile&&!config.is_guest){$('#room_actions_button').show();}
$('#video_button').hide();var room_data=app.get_room_data(jid);if(room_data){this.show_topic(room_data.topic);}else{this.show_topic(null);}
if(room_data&&room_data.guest_url){this.enable_guest_access(room_data.guest_url);}else if(room_data){this.disable_guest_access(room_data.guest_url);}},disable_guest_access:function(){$('#guest_access_toggle').removeAttr('checked');$('#roster .guest_url').hide();$('#roster .guest_toggle label').html('Guest access is off '+'(<a href="http://help.hipchat.com/knowledgebase/articles/64464-what-is-guest-access-" target="_blank">?</a>)');this.update_dimensions();},edit_topic:function(){var room_data=app.get_room_data(app.current_jid);$('#topic').hide();$('#topic_input').val(room_data.topic).show().focus().select();$('.topic_container button').show();},enable_guest_access:function(url){$('#guest_access_toggle').attr('checked','checked');$('#roster .guest_url').show();$('#roster .guest_toggle label').html('Guest access is on '+'(<a target="_blank" href="http://help.hipchat.com/knowledgebase/articles/64464-what-is-guest-access-">?</a>)');$('#roster .guest_url').html('Anyone can access this room at<br />'+'<b><u><font color="#105CB6"><a target="_blank" href="'+url+'">'+url.replace(/http:\/\//,'')+'</a></font></u></b>');this.update_dimensions();},execute_preload_events:function(jid,is_previous_history){if(typeof is_previous_history=='undefined'){is_previous_history=false;}
var preload_events=this.chats_preload_events[jid];if(!preload_events){return;}
preload_events.sort(is_previous_history?helpers.sort_messages_reverse:helpers.sort_messages);var len=preload_events.length;for(var i=0;i<len;i++){var e=preload_events[i];this.add_chat_text(jid,e.text,e.type,e.args);}
preload_events.length=0;},focus_chat:function(jid,name,join_if_not_found){jid=util.jid.bare_jid(jid);hipchat.log('debug','Focus chat: '+jid);if(jid==app.lobby_jid||jid=='lobby'){if(app.current_jid!=app.lobby_jid){this.show_lobby();}
return;}
if(typeof join_if_not_found=='undefined'){join_if_not_found=true;}
var is_room=util.jid.is_room(jid);if(!is_room&&app.get_user_info(jid).role==app.ROLE_VISITOR){alert('Private chat with guests is not supported.');return;}
var chat_display=this.chat_displays[jid];if(!chat_display){if(!join_if_not_found){return;}
if(!app.join_chat(jid)){return;}
chat_display=this.chat_displays[jid];}
if(this.chat_displays[app.current_jid]){this.chats_scroll[app.current_jid]=(this.scroll_at_bottom(app.current_jid)?-1:this.chat_displays[app.current_jid].scrollTop());}
if(app.current_jid!=jid){app.previous_jid=app.current_jid;app.current_jid=jid;}
if(is_room){this.do_show_room(jid,config);}else{this.do_show_private_chat(jid,config);}
util.prefs.set_pref('chatToFocus',jid);$('#chats > div').hide();if(app.chat_is_loading[jid]){var loading=$('#loading');loading.show();$('#main_chat').append(loading);chat_display.hide();}else{$('#loading').hide();chat_display.show();}
$('#tabs li').toggleClass('selected',false);$('#tabs li[name="tab_'+util.jid.sanitize(jid)+'"]').toggleClass('selected',true).toggleClass('alert',false);if(config.mobile){$('#tabs, body h2.tabs_header').hide();$('#lobby_button').show();$('#sidebar').hide();$('#header a.logo').hide();if(name){$('#header .chat_name').show().html(name);}else{$('#header .chat_name').show().html('');}}
$('#lobby, #sidebar .footer .invite').hide();if(!config.vertical_tabs){$('#status_ui').hide();}
if(!config.no_top_bar){$('#top_bar').show();}
$('#main_chat').show();this.update_dimensions();this.focus_message_input();if(this.chats_scroll[jid]){this.scroll_chat(jid,this.chats_scroll[jid]);}},focus_message_input:function(){if(config.mobile){return;}
var elem=$('#message_input');if(elem.is(":focus")){return;}
elem.focus();},exit:function(){$(window).off('beforeunload.hipchatCore');util.prefs.save_preferences();if(config.is_guest){if(util.jid.is_room(app.current_jid)){app.leave_room(app.current_jid);}
setTimeout(function(){window.location.href='/g'+config.guest_key+'?src=chat_exit';},1000);}else{window.location.href='/home?src=chat_exit';}},generate_mention_tooltip:function(){var real_name=app.get_mention_real_name(this.innerHTML);if(!real_name||real_name.length==0){return null;}else{return real_name;}},generate_roster_tooltip:function(){var member_info=app.get_user_info($(this).attr('jid'));var occupant=(app.current_jid==app.lobby_jid?null:app.get_room_occupant(app.current_jid,$(this).attr('jid')));var status_info=chat.get_status_info((occupant||member_info),false);var separator='<br />';var tt=member_info.name;if(member_info.mention_name&&member_info.mention_name.length>0){tt+=separator+'@'+member_info.mention_name;}
if(/admin/.test(status_info.show)){tt+=separator+'Admin';}
tt+=separator+'Status: '+status_info.text;if(status_info.status.length>0){tt+=separator+'Message: '+helpers.escape(status_info.status);}
if(status_info.idle.length>0){tt+=separator+'Idle: '+status_info.idle;}
return tt;},get_chat_html:function(text,args){var html_strings=[];html_strings.push('<div class="chatBlock '+args.class_name+'"><table width="100%" cellspacing="0" cellpadding="0"><tr><td class="nameBlock"><p style="margin-top: 0;">');html_strings.push(chat.get_display_name(config,args));html_strings.push('</p></td><td id="'+args.block_id+'" class="messageBlock">');html_strings.push('<p class="timeBlock">'+helpers.format_time(args.time)+'</p>');var id_attr=(args.message_id?"id="+args.message_id:"");if(args.code){html_strings.push('<pre class="prettyprint" '+id_attr+'>'+text+'</pre>');}else if(args.monospace){html_strings.push('<pre '+id_attr+'>'+text+'</pre>');}else{html_strings.push('<p '+id_attr+' class="msgText" style="margin-top: 0;">'+text+'</p>');}
html_strings.push('</td>');html_strings.push('</td></tr></table></div>');return html_strings.join('');},get_file_html:function(text,args){var file_data=$(args.file_data);var file_path=file_data.find('name').text();var file_desc=file_data.find('desc').text();var size=file_data.find('size').text();var file_url=file_data.find('file_url').text();var thumb_url=file_data.find('thumb_url').text();var html_strings=[];html_strings.push('<div class="chatBlock fileBlock '+args.class_name+'">');html_strings.push('<table width="100%" cellspacing="0" cellpadding="0"><tr><td class="nameBlock"><p style="margin-top: 0;">');html_strings.push(chat.get_display_name(config,args));html_strings.push('</p></td><td id="'+args.block_id+'" class="messageBlock">');html_strings.push('<p class="timeBlock">'+helpers.format_time(args.time)+'</p>');var file_name=helpers.get_file_name_from_path(file_path);var icon_src='/img/filetype_icons/'+helpers.get_file_type_icon(file_name);html_strings.push('<p><img class="icon" src="'+icon_src+'" width="16" height="16" />');html_strings.push('<a target="_blank" name="file" href="'+file_url+'">'+helpers.escape(file_name)+'</a>');html_strings.push('<span class="fileSize">'+helpers.get_file_size_string(size)+'</span></p>');if(thumb_url){var scroll_func=(this.scroll_at_bottom(args.jid)?'onload="chat.scroll_chat(\''+args.jid+'\')"':'');html_strings.push('<div class="preview">');html_strings.push('<div class="image"><a target="_blank" name="file" href="'+file_url+'"><img '+scroll_func+' src="'+thumb_url+'" /></a></div>');html_strings.push('</div>');}
if(file_desc&&file_desc.length>0){html_strings.push('<p>'+helpers.escape_and_linkify(file_desc,{mention_regex:args.mention_regex})+'</p>');}
html_strings.push('</td>');html_strings.push('</td></tr></table></div>');return html_strings.join('');},get_image_html:function(args){var link_data=$(args.metadatas.get(0));var name=helpers.escape(link_data.find('name').text());var url=helpers.escape_and_linkify(link_data.find('url').text().replace(/"/g,'&quot;'),{escape_whitespace:false,name_regex:null,matches:null,do_escape:true,do_linkify:false});var thumb_url=helpers.escape_and_linkify(link_data.find('image').text().replace(/"/g,'&quot;'),{escape_whitespace:false,name_regex:null,matches:null,do_escape:true,do_linkify:false});var html_strings=[];if(name&&name.length>0){html_strings.push('<p>'+name+'</p>');}
var scroll_func=(this.scroll_at_bottom(args.jid)?'onload="chat.scroll_chat(\''+args.jid+'\')"':'');html_strings.push('<div class="image"><a name="link" target="_blank" href="'+url+'"><img '+scroll_func+' src="'+thumb_url+'" /></a></div>');return html_strings.join('');},get_info_html:function(text,args){var name='';if(args.type&&args.type=='presence'){name='name="presence_'+util.jid.bare_jid(args.from)+'"';}
var html_strings=[];html_strings.push('<div class="infoBlock chatBlock '+args.class_name+'" '+name+'><table width="100%" cellspacing="0" cellpadding="0"><tr>');html_strings.push('<td class="nameBlock"><p style="margin-top: 0;">&nbsp;</p></td><td class="messageBlock">');html_strings.push('<p class="timeBlock">'+helpers.format_time(args.time)+'</p>');html_strings.push('<p style="margin-top: 0;">'+text+'</p>');html_strings.push('</td>');html_strings.push('</td></tr></table></div>');return html_strings.join('');},get_link_html:function(args){var metadatas=$(args.metadatas);var html_strings=[];var self=this;metadatas.each(function(idx,elem){html_strings.push(self.get_link_preview($(this)));});return html_strings.join('');},get_link_preview:function(link_data){var favicon=link_data.find('favicon_url').text();var header_text=helpers.escape(link_data.find('header_text').text());var link_url=link_data.find('full_url').text().replace(/"/g,'&quot;');var link_text=helpers.escape(link_data.find('link_text').text());var desc=helpers.escape(link_data.find('desc').text());if(!link_text){link_text=link_url;}
var html_strings=["<table class='linkPreview' cellspacing='0'><tr>"];if(favicon){html_strings.push("<td><img class='icon' src='"+favicon+"' /></td>");}else{var icon_src="/img/filetype_icons/html.png";html_strings.push("<td><img class='icon' src='"+icon_src+"' /></td>");}
html_strings.push("<td><p>");if(header_text){html_strings.push("<span class='linkTitle'>"+header_text+"</span>");}
if(link_text){if(header_text){html_strings.push(" - ");}
html_strings.push("<a name='file' href='"+link_url+"'>"+link_text+"</a>");}
html_strings.push("</p>");if(desc){html_strings.push("<p class='linkDesc'>"+desc.replace(/[\n\r]/g,"<br />")+"</p>");}
html_strings.push("</td></tr></table>");return html_strings.join('');},get_message_args:function(msg){var from=util.jid.bare_jid(msg.attr('from'));var args={message_type:'chat',from:this.get_message_sender(msg),mention_regex:app.get_mention_regex(from)};if(util.jid.is_room(from)){var room_notify_pref=(app.is_private_room(from)?util.prefs.get_bool_pref('notifyForPrivateRoom',true):util.prefs.get_bool_pref('notifyForRoom',true));args.do_notify=(room_notify_pref||(util.prefs.get_bool_pref('notifyForTag',true)&&this.name_tag_regex.test(msg.find('body').text())));args.notify_with_focus=false;args.display_name=util.jid.resource(msg.attr('from'));}else{args.do_notify=util.prefs.get_bool_pref('notifyForPrivate',true);args.notify_with_focus=(from!=app.current_jid);}
var now=(new Date()).getTime();var delay=msg.find('delay:first');args.time=(delay.length>0?helpers.parse_date(delay.attr('stamp')):now);args.is_current=(delay.length==0);this.check_message_file(msg,from,args);this.check_system_message(msg,from,args);this.check_message_metadata(msg,from,args);this.check_message_guest_url(msg,from,args);this.check_message_archive(msg,from,args);this.check_message_subject(msg,from,args);var id=msg.attr('id');if(id){args.message_id=id;args.is_echo=true;}else{this.current_message_id++;args.message_id='message_'+this.current_message_id;args.is_echo=false;}
return args;},get_message_sender:function(msg){var delay=msg.find('delay:first');var from_jid=msg.attr('from');if(delay.length>0){sender=delay.attr('from_jid');if(sender&&util.jid.is_room(from_jid)){app.set_display_name(util.jid.bare_jid(sender),util.jid.resource(from_jid));}}else if(util.jid.is_room(from_jid)){sender=app.jid_from_nickname(util.jid.bare_jid(from_jid),util.jid.resource(from_jid));}else{sender=from_jid;}
return sender;},get_status_info:function(member_info,do_truncate){if(typeof do_truncate=='undefined'){do_truncate=true;}
if(!member_info||!member_info.name){return{show:'available',text:this.PRESENCE_LABEL_AVAILABLE,idle:'',status:''};}
var type=member_info.type?member_info.type:'available';var show=member_info.show;var class_name=(show?show:type);if(type==app.PRESENCE_TYPE_UNAVAILABLE&&member_info.mobile){class_name=member_info.mobile;}else if(type==app.PRESENCE_TYPE_AVAILABLE&&member_info.presence){var resource=util.jid.resource(member_info.presence.attr('from'));if(/^(iphone|android)/.test(resource)){class_name=resource;}}
if(member_info.affiliation=='admin'||member_info.affiliation=='owner'){class_name+=' admin';}
var text='';if(type==app.PRESENCE_TYPE_UNAVAILABLE){text=this.PRESENCE_LABEL_UNAVAILABLE;}else{switch(show){case null:case'':text=this.PRESENCE_LABEL_AVAILABLE;break;case app.PRESENCE_SHOW_AWAY:text=this.PRESENCE_LABEL_AWAY;break;case app.PRESENCE_SHOW_DND:text=this.PRESENCE_LABEL_DND;break;}}
var idle=((member_info.show=='away'&&member_info.idle)?member_info.idle:'');var num_idle_chars=(this.MAX_ROSTER_CHARS-member_info.name.length);var idle_string=(do_truncate?helpers.truncate(helpers.format_idle(idle),num_idle_chars):helpers.format_idle(idle));var status_string=(member_info.status?member_info.status:'');var num_status_chars=(this.MAX_ROSTER_CHARS-member_info.name.length-idle_string.length);if(status_string.length>0&&idle_string.length>0){num_status_chars-=3;}
status_string=(do_truncate?helpers.truncate(status_string,num_status_chars):status_string);if(do_truncate&&idle_string.length>0&&status_string.length>0){status_string=' - '+status_string;}
return{show:class_name,text:text,idle:idle_string,status:status_string};},get_system_html:function(text,args){var html_strings=[];var color=args.color?args.color:'';html_strings.push('<div class="systemMessage chatBlock systemMessage-'+color+'"><table width="100%" cellspacing="0" cellpadding="0"><tr><td class="nameBlock"><p style="margin-top: 0;">');html_strings.push(args.display_name);html_strings.push('</p></td><td class="messageBlock">');html_strings.push('<p class="timeBlock">'+helpers.format_time(args.time)+'</p>');html_strings.push('<div>'+text+'</div>');html_strings.push('</td>');html_strings.push('</td></tr></table></div>');return html_strings.join('');},get_twitter_html:function(args){var link_data=$(args.metadatas.get(0));var title=link_data.find('text').text();if(title){title=helpers.escape_and_linkify(title,{mention_regex:args.mention_regex});}
var thumb_url=link_data.find('profile_image_url').text();var type=link_data.find('type').text();var author=link_data.find('screen_name').text();var author_url='http://twitter.com/'+author;var url=link_data.find('url').text();var source=decodeURIComponent(link_data.find('source').text());var html_strings=[];html_strings.push('<a class="linkImage" name="link" href="'+url+'"><img height="48" width="48" src="'+thumb_url+'" /></a>');if(type=='twitter_status'){html_strings.push('<p>'+title+'</p>');html_strings.push('<p class="linkDesc">&ndash; '+link_data.find('name').text()+' (@<a href="'+author_url+'">'+author+'</a>) via '+source+'</p>');}else if(type=='twitter_user'){html_strings.push('<p>'+link_data.find('name').text()+' (@<a href="'+author_url+'">'+author+'</a>)</p>');html_strings.push('<p class="linkDesc">'+helpers.format_number(link_data.find('followers').text())+' followers</p>');}
return html_strings.join('');},get_video_html:function(args){var link_data=$(args.metadatas.get(0));var title=link_data.find('title').text();var url=link_data.find('url').text();var thumb_url=link_data.find('thumb').text();var type=link_data.find('type').text();var desc=helpers.format_number(link_data.find('views').text())+' views<br />'+
link_data.find('author').text();var html_strings=[];html_strings.push('<a class="linkImage" name="link" href="'+url+'"><img src="'+thumb_url+'" /></a>');html_strings.push('<p class="linkTitle">'+title+'</p>');html_strings.push('<p class="linkDesc">'+desc+'</p>');return html_strings.join('');},get_welcome_html:function(text,args){text='You joined the room';if(config.welcome_msg){text=config.welcome_msg;}
else if(config.is_guest){text='You\'re a guest in the '+helpers.escape(args.display_name)+' room.';if(!config.minimal){text+=' A list of people in the room is on the right.';}}
var html_strings=[];html_strings.push('<div class="welcomeMessage chatBlock"><table width="100%" cellspacing="0" cellpadding="0"><tr>');html_strings.push('<td class="nameBlock"><p style="margin-top: 0;">Welcome!</p></td><td class="messageBlock">');html_strings.push('<p style="margin-top: 0;">'+text+'</p>');html_strings.push('</td></tr></table></div>');return html_strings.join('');},add_chat_divider:function(jid){var chat_display=this.chat_displays[jid];if(!chat_display){hipchat.log('warn','Call to add text without chat_display available - doing nothing');return;}
var new_div=document.createElement('div');new_div.className='chatDivider';this.chats_last_from[jid]=null;this.chats_divider_times[jid]=null;$(chat_display).find('.chatText').append(new_div);},add_date_divider:function(jid,date,insert_on_top){var chat_display=this.chat_displays[jid];if(!chat_display){hipchat.log('warn','Call to add text without chat_display available - doing nothing');return;}
var new_div=document.createElement('div');new_div.className='dateDivider';new_div.innerHTML=dateFormat(date,"dddd mmmm d, yyyy");this.chats_last_from[jid]=null;if(insert_on_top){new_div.className+=' previousHistory';new_div.style.display='none';$(chat_display).find(".chatText > :first").before(new_div);}else{$(chat_display).find('.chatText').append(new_div);}},handle_chat_state_message:function(msg){var sender_jid=this.get_message_sender(msg);var from_jid=util.jid.bare_jid(msg.attr('from'));var state=msg.find(this.CHAT_STATE_SELECTOR);var user_info=app.get_user_info(from_jid);var is_current_user=(util.jid.bare_jid(sender_jid)==util.jid.bare_jid(app.current_user_jid));if(is_current_user){if(!util.jid.is_private_chat(from_jid)){return;}
switch(state.get(0).tagName){case this.ACTIVE_STATE:app.join_chat(from_jid);break;case this.GONE_STATE:this.close_chat(from_jid,null,true,false);break;}}else{switch(state.get(0).tagName){case this.COMPOSING_STATE:this.show_chat_state_message(from_jid,user_info.name);var self=this;this.chat_state_timers[from_jid]=setTimeout(function(){self.hide_chat_state_message(from_jid);},30000);break;case this.ACTIVE_STATE:case this.INACTIVE_STATE:this.hide_chat_state_message(from_jid);break;}}
return true;},handle_drag_drop_file_upload:function(response){this.handle_file_upload(this.upload_data.filename,response);},handle_drag_enter:function(event){$('#file_drop_frame').show();},handle_drag_out:function(event){$('#file_drop_frame').hide();},handle_chat_scroll:function(event){if(config.is_guest){return;}
var chat_display=$(event.currentTarget);var current_scroll=chat_display.scrollTop();var scroll_height=chat_display.prop('scrollHeight');if(!this.chats_fully_loaded[jid]&&current_scroll==0&&scroll_height>chat_display.height()){this.load_previous_history();chat_display.find('div.loadLink').show();}else{chat_display.find('div.loadLink').hide();var jid=chat_display.attr('name');if(current_scroll>=(scroll_height-chat_display.height())){this.chats_scroll_at_bottom[jid]=true;}else{this.chats_scroll_at_bottom[jid]=false;}}},handle_file_drop:function(event){event.stopPropagation();event.preventDefault();if(!app.can_share_files()){this.show_flash('File uploads have been disabled by a group administrator.');return;}
if(!this.file_reader){return;}
if(app.current_jid==app.lobby_jid){alert('You must be in a chat room or private chat to upload a file');}
if(event.dataTransfer.files.length>1){alert('You can only upload one file at a time. Please choose a single file.');return;}
this.upload_data.file=event.dataTransfer.files[0];if(this.file_reader){this.file_reader.readAsDataURL(this.upload_data.file);}
var parts=this.upload_data.file.name.split('.');this.on_before_file_upload(this.upload_data.file.name,parts[1]);},handle_file_dropper_change:function(event){if(!app.can_share_files()){this.show_flash('File uploads have been disabled by a group administrator.');return;}
var files=event.target.files;if(files.length>1){alert('You can only upload one file at a time. Please choose a single file.');}
this.upload_data.file=files[0];var file_name=this.upload_data.file.filename||this.upload_data.file.name;var parts=fileName.split('.');this.on_before_file_upload(file_name,parts[1]);$('#file_drop_frame').hide();},handle_file_error:function(event){this.show_flash('There was a problem loading the file for upload.');this.clear_upload();},handle_file_load:function(event){if(!app.can_share_files()){this.show_flash('File uploads have been disabled by a group administrator.');return;}
hipchat.log('info','file loaded');var is_image=helpers.is_image_file(this.upload_data.file.name);if(/^data/.test(this.file_reader.result)){if(is_image){$('#upload_image_tooltip').find('img').attr('src',this.file_reader.result);}
this.file_reader.readAsBinaryString(this.upload_data.file);}else{var parts=this.upload_data.file.name.split('.');this.on_before_file_upload(this.upload_data.file.name,parts[1]);this.upload_data.binary_file=this.file_reader.result;if(is_image){var img_tooltip=$('#upload_image_tooltip');var upload_ui=$('#upload_ui');var pos=upload_ui.offset();$("#upload_image_tooltip").css({top:(pos.top-img_tooltip.outerHeight()-10)+"px",left:(pos.left)+"px"}).show();}}},handle_file_name_defocus:function(event){var filename_input=$('#upload_ui').find('input');var new_filename=filename_input.val();var parts=new_filename.split('.');if(!new_filename||new_filename.length==0){filename_input.hide();$('#upload_ui').find('span').show();this.focus_message_input();return;}
if(parts.length<2){parts.push(this.upload_data.extension);new_filename+="."+this.upload_data.extension;}else if(parts[1]!=this.upload_data.extension){parts[1]=this.upload_data.extension;new_filename+="."+this.upload_data.extension;}
filename_input.hide();$('#upload_ui').find('span').html(new_filename).show();this.upload_data.filename=new_filename;if(this.upload_data.file){this.upload_data.file.name=new_filename;}
this.focus_message_input();},handle_file_upload:function(filename,response){if(!$('#upload_progress').is(':visible')){return;}
if($(response).find('error').length>0){this.add_chat_text(this.upload_data.jid,'There was an error uploading the file: '+$(response).find('error').text(),'info',{});}
else{var file_id=$(response).find('file_id').text();app.send_file_upload_message(this.upload_data.jid,file_id);}
this.clear_upload();this.uploader.enable();},handle_flash_click:function(event){var flash=$('#flash');if(flash.attr('jid')){var jid=flash.attr('jid');this.focus_chat(jid,app.get_display_name(jid));flash.hide();}},handle_gear_click:function(event){event.stopPropagation();var gear=$(event.currentTarget);var room_jid=gear.attr('name');var self=this;this.menu.remove_all_options();this.menu.add_option('delete','Delete room',function(){var room_name=app.get_display_name(room_jid);if(confirm('Are you sure you want to delete the room "'+room_name+'"?')){app.destroy_room(room_jid);}});this.menu.add_option('perms','Manage permissions',function(){self.show_manage_room_popup(room_jid);});this.menu.add_option('rename','Rename room',function(){self.show_room_rename_popup(room_jid);});var data=app.get_room_data(room_jid);var msg=data.is_archived?'Unarchive room':'Archive room';this.menu.add_option('archive',msg,function(){self.show_room_archive_popup(room_jid);});this.menu.toggle(gear);},handle_iframe_upload_complete:function(){this.handle_file_upload(this.upload_data.filename,$('#file_drop_frame').contents().find('response'));this.setup_upload_iframe();},handle_invite_message:function(msg){var from_room=util.jid.bare_jid(msg.attr('from'));var invite=$(msg.find('invite')[0]);var from_user=invite.attr('from');if(util.jid.bare_jid(from_user)==util.jid.bare_jid(app.current_user_jid)){app.join_chat(from_room);return;}
var reason='';if(invite.find('reason').length>0){reason=$(invite.find('reason')[0]).text();}
var invite_from_name=app.get_display_name(from_user);if(util.jid.is_room(from_user)){invite_from_name=util.jid.resource(from_user);}
var room_name=$(msg.find('name')[0]).text();var invite_prompt=invite_from_name+" invited you to join the room: "+room_name+(reason?"\n\n\""+reason+"\"":"");if(confirm(invite_prompt)){this.focus_chat(from_room,room_name,true);}},handle_lobby_row_click:function(event){var room_jid=$(event.currentTarget).attr('jid');var data=app.get_room_data(room_jid);app.join_chat(room_jid,data.name);this.focus_chat(room_jid,data.name);},handle_manage_room_save:function(event){var jid=$('#manage_room input[name="jid"]').val();var privacy=$('#manage_room input:radio:checked').val();var user_ids=[];for(var i=0;i<this.tmp_perms.length;i++){user_ids.push(util.jid.user_id(this.tmp_perms[i]));}
var send_invites=$('#send_invites').is(':checked');app.save_room_data(jid,privacy,user_ids,send_invites);$('#manage_room').dialog('close');app.discover_rooms();},handle_manage_room_cancel:function(event){$('#manage_room').dialog('close');},handle_message:function(msg){msg=$(msg);if(msg.attr('type')=='error'){this.on_stanza_error(msg);return true;}
if(msg.attr('id')){this.mark_message_confirmed(msg.attr('id'));}
var type='chat';var body=(msg.find('body').length>0?$(msg.find('body')[0]).text():null);var from_jid=util.jid.bare_jid(msg.attr('from'));if(msg.attr('type')=='headline'){this.show_announcement(from_jid,body);return true;}
if(msg.find('invite').length>0){this.handle_invite_message(msg);return true;}
var chat_display=this.chat_displays[from_jid];if(!chat_display&&body&&body.length>0){if(util.jid.is_private_chat(from_jid)){var display_name=app.get_display_name(from_jid,true);if(!app.join_chat(from_jid,display_name)){return;}
var nav_link=$('#tabs li[name="tab_'+from_jid+'"]');nav_link.toggleClass('alert',true);this.chats_divider_times[from_jid]=(msg.time?(msg.time.getTime()-1000):(new Date().getTime()-1000));this.chats_initial_message[from_jid]=msg;this.notify(from_jid,from_jid,body);return true;}}
var is_chat_state_message=msg.find(this.CHAT_STATE_SELECTOR).length>0;if(is_chat_state_message){this.handle_chat_state_message(msg);}
if(this.chat_state_timers[from_jid]){clearTimeout(this.chat_state_timers[from_jid]);this.chat_state_timers[from_jid]=null;}
var args=this.get_message_args(msg);if(msg.find('x[xmlns="http://hipchat.com/protocol/addlive"]').length>0){return args.is_current?this.handle_video_message(msg):true;}
if(msg.find('metadata > type').text()==='addlive'){return true;}
if(args.is_current&&msg.find('vcconnect')&&this.handle_legacy_video_connect_message(msg)){return true;}
if(args.body){body=args.body;}
if(!is_chat_state_message&&(!body||body.length==0)){hipchat.log('warn','Got message without body');return true;}
this.add_chat_text(from_jid,body,args.message_type,args);return true;},handle_message_keydown:function(event){if(event.keyCode==13&&!event.shiftKey){event.preventDefault();this.send_message();this.request_webkit_notification_permission();return;}},handle_message_keyup:function(event){if(event.keyCode==13){return;}
var message_input=$(event.currentTarget);if(util.jid.is_private_chat(app.current_jid)){if(message_input.val().length>0&&this.chat_states[app.current_jid]!=this.COMPOSING_STATE){this.chat_states[app.current_jid]=this.COMPOSING_STATE;app.send_chat_state_message(app.current_jid,this.COMPOSING_STATE);}else if(message_input.val().length==0){this.chat_states[app.current_jid]=this.ACTIVE_STATE;app.send_chat_state_message(app.current_jid,this.ACTIVE_STATE);}}},handle_new_chat_cancel:function(event){$('#new_chat').dialog('close');},handle_new_chat_create:function(event){if(!this.validate_new_chat()){return false;}
var name=$('#new_chat_room_name').val();var privacy=$('#new_chat input:radio:checked').val();var send_invites=$('#send_invites').is(':checked');var topic=$('#new_chat_topic').val();var members=this.tmp_perms;var room_jid=helpers.get_jid_from_chat_name(name);app.create_room(room_jid,name,privacy,members,topic,send_invites);this.focus_chat(room_jid,name,false);$('#new_chat').dialog('close');return false;},handle_paste:function(event){event=event.originalEvent;if(!event.clipboardData||!event.clipboardData.items){return;}
var items=event.clipboardData.items;if(!items[0].type||!/image\/png/.test(items[0].type)){return;}
this.upload_data.file=items[0].getAsFile();this.upload_data.file.name='upload.png';if(this.file_reader){this.file_reader.readAsDataURL(this.upload_data.file);}},handle_private_radio_click:function(event){var self=this;var jid=$(event.currentTarget).closest('div.popup').find('input[name="jid"]').val();setTimeout(function(){self.show_change_perms_popup(jid);},0);},handle_public_radio_click:function(event){this.tmp_perms=[];$('#new_chat_private_acl, #manage_room_private_acl').html('Choose who will have access...');$('#manage_room_perms_link, #new_chat_perms_link').hide();},handle_perms_admins_fetch:function(data){var member_list=$('#room_perms .user_list').empty();var owner_jid=(data.owner?data.owner:app.current_user_jid);var count=0;var i;for(i=0;i<app.roster.length;i++){var user=app.roster[i];var class_name=(count==0?'first':'');var text='<span>'+user.name+'</span>';var disabled='';var checked='';if(user.jid==owner_jid){text+=" (room creator)";disabled='disabled="disabled"';checked='checked="checked"';class_name+=' disabled';}
member_list.append('<div class="member '+class_name+'">'+'<input type="checkbox" value="'+user.jid+'" '+disabled+' '+checked+' id="perms_check_'+count+'" />'+'<label for="perms_check_'+count+'">'+text+'</label></div>');count++;}
for(i=0;i<data.group_admin.length;i++){var admin=data.group_admin[i];var input=member_list.find('div input[value="'+admin+'"]');var label=input.siblings('label');label.html(label.html()+' (group admin)');}
if(data.jid){$('#room_perms').find('#perms_jid').val(data.jid);}
if(data.member&&data.jid){if(typeof data.member=='string'){data.member=[data.member];}
for(var j=0;j<data.member.length;j++){var member_jid=data.member[j];member_list.find('div input[value="'+member_jid+'"]').attr('checked','checked');}}
member_list.find(':input:first').focus();},handle_room_actions_button:function(event){event.stopPropagation();var self=this;var room=app.get_room_data(app.current_jid);var is_admin=(config.is_admin||room.owner==app.current_user_jid);var is_private_room=app.is_private_room(app.current_jid);this.menu.remove_all_options();this.menu.add_option('browse_history','Browse chat history',function(){var node_name=util.jid.room_name(app.current_jid);var history_url='https://'+config.web_server+'/history/room/?name='+escape(node_name);window.open(history_url);});this.menu.add_option('hide_history','Hide chat history',$.proxy(this,'hide_chat_history'));if((!is_private_room)||is_admin){this.menu.add_separator();this.menu.add_option('invite','Invite someone',$.proxy(this,'show_room_invite_popup'));}
if(is_admin){if(room.guest_url){this.menu.add_option('guest_access','Turn off guest access',$.proxy(this,'toggle_guest_access'));}else{this.menu.add_option('guest_access','Turn on guest access',$.proxy(this,'toggle_guest_access'));}
this.menu.add_option('perms','Manage permissions',function(){self.show_manage_room_popup(app.current_jid);});this.menu.add_option('delete','Delete room',function(){var room_name=app.get_display_name(app.current_jid);if(confirm('Are you sure you want to delete the room "'+room_name+'"?')){app.destroy_room(app.current_jid);}});this.menu.add_option('rename','Rename room',function(){self.show_room_rename_popup(app.current_jid);});var data=app.get_room_data(app.current_jid);var msg=data.is_archived?'Unarchive room':'Archive room';this.menu.add_option('archive',msg,function(){self.show_room_archive_popup(app.current_jid);});}
this.menu.toggle($(event.currentTarget));},handle_room_perms_save:function(event){var popup=$('#room_perms');this.tmp_perms=[];var user_ids=[];var self=this;var name_list=[];popup.find('div.member').each(function(idx,elem){elem=$(elem);checkbox=elem.find('input[type="checkbox"]');if(checkbox.is(':checked')){self.tmp_perms.push(checkbox.val());user_ids.push(util.jid.user_id(checkbox.val()));name_list.push(elem.find('label span').html());}});if($('#new_chat').is(':visible')){$('#new_chat_private_acl').html('The following people will have access: '+name_list.join(', '));popup.dialog('close');$('#submit_new_chat').focus();$('#new_chat_perms_link').show();}else if($('#manage_room').is(':visible')){$('#manage_room_private_acl').html('The following people will have access: '+helpers.generate_name_list_string(name_list,10));popup.dialog('close');$('#submit_manage_room').focus();$('#manage_room_perms_link').show();}else{var args={jid:popup.find('#perms_jid').val(),members:user_ids.join(','),send_invites:(popup.find('#send_invites').is(':checked')?1:0)};app.make_api_request('change_room_perms',args,function(data){if(data&&data.error){alert('There was a problem saving room permission info.');}else{self.show_flash('Successfully saved room permissions');}});popup.dialog('close');}},handle_room_perms_cancel:function(event){$('#room_perms').dialog('close');if(this.tmp_perms.length==0){$('#new_chat_public, #manage_room_public').attr('checked','checked');$('#manage_room_perms_link, #new_chat_perms_link').hide();}else{}},handle_roster_dblclick:function(event){if(config.is_guest){return;}
if(!app.can_private_chat()){this.show_flash('One-to-one chats have been disabled by a group administrator.');return;}
var member=$(event.target);this.focus_chat(member.attr('jid'),app.get_display_name(member.attr('jid')));},handle_send_room_invites:function(event){$('#send_room_invites').dialog('close');var names=$('#invite_input').val().split(',');var jids=[];var jid='';var name;for(var i in names){name=$.trim(names[i]);if(name.length==0){continue;}
jid=app.get_jid_by_name(name);if(jid){jids.push(jid);}else{alert('There is no user with the name "'+name+'".');}}
app.invite_to_room(app.current_jid,jids,$('#invite_message').val());return false;},handle_search_button_click:function(event){event.stopPropagation();this.show_search_ui();},handle_video_button_click:function(event){event.stopPropagation();var session=this.video_session;if(session){if(session.window){if(session.jid!==app.current_jid){if(confirm('Leave your current video session?')){session.window.close();}else{return;}}else{session.window.focus();return;}}else{delete this.video_session_type;delete this.video_session;}}
this.open_video_ui(app.current_jid,'call');},handle_search_keydown:function(event){var keyCode=event.keyCode||event.which;if(keyCode==27){event.stopPropagation();$('#search_ui').hide();this.focus_message_input();}},handle_search_submit:function(event){var search_text=$('#search_ui input').val();var room_name=helpers.get_jid_room_name(app.current_jid);var url='/search?q='+escape(search_text)+'&r='+escape(room_name);if(config.mobile&&config.mobile!='iphone'){window.location.href=url;}else{window.open(url);}
$('#search_ui').hide();return false;},handle_settings_save:function(event){util.prefs.set_pref('disableSounds',(!$('#settings_sound').is(':checked')),false);util.prefs.set_pref('hidePresenceMessages',(!$('#settings_presence').is(':checked')),false);util.prefs.set_pref('timeFormat24Hour',($('#settings_24_hour').is(':checked')),false);util.prefs.set_pref('exitWarn',($('#settings_exitwarn').is(':checked')),false);util.prefs.set_pref('notifyForRoom',($('#settings_notify_open_room').is(':checked')),false);util.prefs.set_pref('notifyForPrivateRoom',($('#settings_notify_private_room').is(':checked')),false);util.prefs.set_pref('notifyForTag',($('#settings_notify_mention').is(':checked')),false);util.prefs.set_pref('notifyForPrivate',($('#settings_notify_oto_message').is(':checked')),false);if(typeof window.webkitNotifications!='undefined'){util.prefs.set_pref('showToasters',$('#settings_toaster').is(':checked'),false);}
$('#settings').dialog('close');util.prefs.save_preferences();this.show_flash('Saved settings');},handle_topic_cancel:function(event){$('#topic_input, .topic_container button').hide();$('#topic').show();},handle_topic_submit:function(event){this.set_topic($('#topic_input').val());$('#topic_input, .topic_container button').hide();$('#topic').show();},handle_status_chooser_mousedown:function(event){event.preventDefault();event.stopImmediatePropagation();var target=$(event.target);if(target.hasClass('help')){window.open('https://www.hipchat.com/help');}else if(target.hasClass('signout')){this.exit();}else{var show=(target.hasClass('available')?null:target.attr('class'));app.set_presence(app.PRESENCE_TYPE_AVAILABLE,show,'',0);$('#status_ui span, #status_message_ui').attr('class',target.attr('class'));$('#status_message_ui').show();$('#status_chooser').hide();$('#status_input').val('').focus();}},handle_status_dropdown_mouseout:function(event){if($('#status_chooser, #status_message_ui').is(':visible')){return;}
$('#status_ui .border').hide();},handle_status_dropdown_mousedown:function(event){event.preventDefault();event.stopImmediatePropagation();var currently_shown=$('#status_chooser').is(':visible');this.hide_popups();if(!currently_shown){$('#status_chooser, #status_ui .border').show();}},handle_user_kicked:function(room_jid,user_jid,actor_jid){user_jid=util.jid.bare_jid(user_jid);if(user_jid==app.current_user_jid){if(config.is_guest){$(window).off('beforeunload.hipchatCore');app.disconnect();location.reload(true);return;}
this.close_chat(room_jid,null,true,false);if(actor_jid&&(util.jid.bare_jid(actor_jid)!=util.jid.bare_jid(app.current_user_jid))){alert('You have been removed from '+app.get_display_name(room_jid));}
return;}
var msg=app.get_display_name(user_jid)+" was removed from the room.";var args={from:user_jid};this.add_chat_text(room_jid,msg,'info',args);},handle_user_profile:function(data){if(data.error){return;}
$('#status_ui .user_photo img').attr('src',data.photo_small);},handle_video_message:function(msg){var from_jid=msg.attr('from');var is_room=util.jid.is_room(from_jid);if(!is_room){var from=app.get_user_info(from_jid);if(msg.find('x > call').length>0){return this.handle_video_call_message(msg,from);}else if(msg.find('x > accept').length>0){return this.handle_video_accept_message(msg,from);}else if(msg.find('x > decline').length>0){return this.handle_video_decline_message(msg,from);}else if(msg.find('x > hangup').length>0){return this.handle_video_hangup_message(msg,from);}else{hipchat.log('ERROR','Unexpected video message type');return false;}}
hipchat.log('ERROR','Received video call message in room');return false;},handle_video_call_message:function(msg,from){hipchat.log('DEBUG','Video call message received from '+from.name);var session=this.video_session;if(session){if(session.jid===from.jid){hipchat.log('DEBUG','Received call from user already engaged in the current call');return true;}else{this.handle_video_invite_message(msg,from);return this.handle_video_interrupt_message(msg,from);}}
return this.handle_video_invite_message(msg,from);},handle_video_invite_message:function(msg,from){hipchat.log('DEBUG','Incoming video call invitation from '+from.name);this.notify(from.jid,from.jid,'Video call request from '+from.name+'.');this.events.trigger('video_call',from);var self=this;function accepted(){hipchat.log('DEBUG','Video call request accepted');self.open_video_ui(from.jid,'accept');}
function declined(){hipchat.log('DEBUG','Video call request declined');self.events.trigger('video_decline',from);app.send_video_message(from.jid,{message_id:chat.current_message_id++,type:'decline'});}
function missed(){hipchat.log('DEBUG','Video call request missed');self.events.trigger('video_missed',from);if(app.join_chat(from.jid)){var msg='You missed a video call from '+from.name+'.';chat.add_chat_text(from.jid,msg,'system',{display_name:'HipChat'});}}
self.toaster.call.notify(from).on({closed:declined,accepted:accepted,declined:declined,missed:missed});return true;},handle_video_interrupt_message:function(msg,from){hipchat.log('DEBUG','Incoming video call interrupt from '+from.name);this.events.trigger('video_interrupt',from);return true;},handle_video_accept_message:function(msg,from){hipchat.log('DEBUG','Received video accept message from '+from.name);this.events.trigger('video_accept',from);return true;},handle_video_decline_message:function(msg,from){hipchat.log('DEBUG','Received video decline message from '+from.name);if(app.join_chat(from.jid)){var msg=from.name+' declined to answer your video call.';this.add_chat_text(from.jid,msg,'system',{display_name:'HipChat'});}
this.events.trigger('video_decline',from);return true;},handle_video_hangup_message:function(msg,from){hipchat.log('DEBUG','Received video hang up message from '+from.name);this.toaster.call.retract(from.jid);if(this.video_session&&this.video_session.jid!==from.jid){from=$.extend(from,{interrupt:true});}
this.events.trigger('video_hangup',from);return true;},handle_legacy_video_connect_message:function(msg){var connect_data=msg.find('vcconnect').text();var matches=/(\w+)-([^-]+-?(\w+)?)/.exec(connect_data);if(!matches||matches.length<3){return false;}
var type=matches[1];var id=matches[2];if(type=='failure'){}else{var response=$msg({to:msg.attr('from'),from:app.current_user_jid,type:'chat'}).c('x',{xmlns:'http://hipchat.com'}).c('metadata').c('vcconnect').t('failure-'+app.current_user_jid+'-notsupported');app.connection.send(response.tree());}
return true;},switch_video_to:function(user_jid){var self=this;this.toaster.call.retract(user_jid);function do_switch(){self.open_video_ui(user_jid,'accept');}
if(self.video_session){var vwin=self.video_session.window;if(vwin){$(vwin).unload(do_switch);return vwin.close();}}
do_switch();},hide_chat_history:function(){var chat_display=$(this.chat_displays[app.current_jid]);chat_display.find('.chatBlock').hide();chat_display.find('.showLink').show();chat_display.find('.loadLink').hide();this.chats_last_activity[app.current_jid]=null;setTimeout(function(){chat.focus_message_input();},0);},hide_chat_state_message:function(jid){var chat_display=this.chat_displays[jid];if(!chat_display){hipchat.log('warn','Call to add text without chat_display available - doing nothing');return false;}
var state_message=chat_display.find('.chatState');if(state_message){state_message.hide();return true;}
return false;},hide_flash:function(){$('#flash').hide();},hide_popups:function(){$('#search_ui, #status_chooser, #status_message_ui, #status_ui .border').hide();this.menu.hide();if($('#topic_input').is(':visible')){$('#topic_input, .topic_container button').hide();$('#topic').show();}},hide_reconnect_spinner:function(){$('#flash .spinner').hide();},init:function(){app.init();this.update_dimensions();if(!config.is_guest){this.setup_popups();}
this.setup_listeners();this.setup_hotkeys();app.connect();var self=this;if(!app.can_share_files()){$('#upload_button').click(function(event){chat.show_flash('File uploads have been disabled by a group administrator.');});}else{this.uploader=new AjaxUpload('upload_button',{action:'/api/upload_file',autoSubmit:false,onChange:$.proxy(this,'on_before_file_upload'),onSubmit:$.proxy(this,'on_file_upload'),onComplete:$.proxy(this,'handle_file_upload'),name:'Filedata'});}
this.menu=new Menu();this.page_title=document.title;$('#status_ui h3').html(config.user_name);var name_parts=config.user_name.split(' ');var last_name=(name_parts[1]?name_parts[1]:'');var mention=(config.mention?config.mention:name_parts[0]);this.name_tag_regex=new RegExp('@('+mention+'\\b|all\\b|here\\b|"'+config.user_name+'")',"ig");if(typeof Audio!='undefined'){this.notification_sound=new Audio();var can_play_ogg=this.notification_sound.canPlayType('audio/ogg');var can_play_mp3=this.notification_sound.canPlayType('audio/mp3');if(can_play_mp3=='maybe'||can_play_mp3=='probably'){this.notification_sound.src='/sound/notify.mp3';}else if(can_play_ogg=='maybe'||can_play_ogg=='probably'){this.notification_sound.src='/sound/notify.ogg';}else{this.notification_sound=null;}}
this.has_flash=false;if(typeof ActiveXObject!='undefined'){try{var fo=new ActiveXObject('ShockwaveFlash.ShockwaveFlash');if(fo){this.has_flash=true;}}catch(e){}}
if(navigator.mimeTypes["application/x-shockwave-flash"]!=undefined){this.has_flash=true;}
if(config.is_guest){this.init_guest();}else{this.init_non_guest();}},init_guest:function(){$('#lobby, #tab_lobby, #room_actions_button, #search_button, #settings_button, #status_chooser .dnd').hide();this.update_dimensions();$('#top_bar .topic_container').attr('title','');},init_non_guest:function(){$('#lobby h1').html(config.group_name+' Rooms');$('#tabs').sortable({items:'li[name!="tab_lobby"]',axis:'y',placeholder:'drop_area',forcePlaceholderSize:true,delay:300,cursor:'crosshair',tolerance:'pointer',update:$.proxy(this,'save_tabs_to_auto_join')});if(!app.can_create_rooms()){$('#create_room_button').hide();}
if(util.prefs.get_bool_pref('timeFormat24Hour')){helpers.use_24h=true;}},leave_chats_not_in_auto_join:function(){var auto_join=util.prefs.get_pref('autoJoin',[]);var self=this;$('#tabs > li[name!="tab_lobby"]').each(function(idx,elem){var jid=$(elem).attr('jid');var exists=false;for(var i=0;i<auto_join.length;i++){var auto_jid=auto_join[i].jid;if(auto_jid==jid){exists=true;break;}}
if(!exists){self.close_chat(jid,null,false,false);}});},load_previous_history:function(){var jid=app.current_jid;var chat_display=this.chat_displays[jid];var anchor=document.createElement('a');this.chats_anchor_ids[jid]='anchor'+this.current_block_id;anchor.id=this.chats_anchor_ids[jid];anchor.className='scrollAnchor';chat_display.find('.chatText > :first').before(anchor);chat_display.find();app.request_history(app.current_jid,null,this.chats_oldest_message_time[jid],function(){chat.scroll_to_anchor(jid);});},mark_message_confirmed:function(message_id){var messageNode=$('#'+message_id).removeClass('msgTextError').addClass('msgText').unbind('click').tooltip();delete this.unconfirmed_messages[message_id];},mark_message_unconfirmed:function(message_id){if(!this.unconfirmed_messages[message_id]){return;}
var self=this;var messageNode=$('#'+message_id).removeClass('msgText').addClass('msgTextError').click(function(){self.resend_unconfirmed_message(message_id);}).tooltip({bodyHandler:function(){return'This message may not have reached the server. Click to resend this message.';}});},notify:function(jid,sender,message){if(config.mobile&&jid!=app.current_jid){message=helpers.truncate(message,100);if(sender&&jid!=sender){message=app.get_display_name(sender)+' <strong>('+app.get_display_name(jid)+')</strong>: '+message;}else{message=app.get_display_name(jid)+': '+message;}
this.show_flash(message,4000,jid);}
if(this.is_focused){return;}
if(app.current_user_jid==util.jid.bare_jid(sender)){return;}
this.unread_count++;var from=app.get_display_name(jid);var sender_name=(sender?app.get_display_name(sender):'');var notif_title=(util.jid.is_room(jid)?(sender_name+' ('+from+')'):sender_name);var message_text=util.strip_tags(message);if(!message_text){message_text=message;}
var self=this;if(!util.prefs.get_bool_pref('showToasters',true)){}else if(window.fluid){window.fluid.showGrowlNotification({title:notif_title,description:message_text,priority:1,sticky:false,identifier:"hipchat-notif"+this.notif_count++,onclick:function(){self.focus_chat(jid);},icon:'https://www.hipchat.com/apple-touch-icon.png'});}else if(window.webkitNotifications){var perm=window.webkitNotifications.checkPermission();var notif=null;if(perm===0){if(window.Notification){notif=new Notification(notif_title,{tag:'hipchat_notif',body:message_text});notif.onclick=function(){window.focus();self.focus_chat(jid);this.cancel();};this.last_notif=notif;}else{notif=window.webkitNotifications.createNotification('/img/icons/hipchat_32.png',notif_title,message_text);setTimeout(function(){notif.cancel();},5000);notif.show();}}}
if(window.fluid){window.fluid.dockBadge=this.unread_count;}else{Tinycon.setBubble(this.unread_count);}
if(this.is_notifying){return;}
this.is_notifying=true;setTimeout(function(){self.is_notifying=false;},3000);var disable_sounds=(config.mobile||util.prefs.get_bool_pref('disableSounds',false));if(!disable_sounds){if(this.notification_sound){this.notification_sound.play();}else if(this.has_flash){soundManager.play('notify','/sound/notify.mp3');}}
var new_title=from+' - "'+message_text+'"';if(this.window_blink_timeout){clearInterval(this.window_blink_timeout);}
this.window_blink_timeout=setInterval(function(){document.title=(document.title==new_title?self.page_title:new_title);},1000);},on_before_file_upload:function(filename,ext){this.upload_data.filename=filename;this.upload_data.extension=ext;var icon=helpers.get_file_type_icon((filename+ext));filename=helpers.truncate(filename,20,true);$('#upload_ui').html('<img src="/img/chat/filetype_icons/'+icon+'" /><span>'+helpers.escape(filename)+'</span>'+'<input type="text" style="display:none;" />'+'<img class="close" src="/img/chat/icon_close_dark.png" />').show();$('#upload_ui').find('img.close').mouseover(function(){$(this).attr('src','/img/chat/icon_close_light.png');}).mouseout(function(){$(this).attr('src','/img/chat/icon_close_dark.png');}).click($.proxy(this,'clear_upload'));$('#upload_ui').find('span').click($.proxy(this,'show_file_name_edit'));$('#upload_ui').find('input').focusout($.proxy(this,'handle_file_name_defocus'));if(/^upload/.test(filename)){this.show_file_name_edit();}else{this.focus_message_input();}},on_file_upload:function(filename,ext){this.uploader.setData({user_id:util.jid.user_id(app.current_user_jid),group_id:util.jid.group_id(app.current_user_jid),desc:$('#message_input').val(),jid:app.current_jid,token:app.token_info.token});this.uploader.disable();},on_guest_access_error:function(iq){if($('#guest_access_toggle').attr('checked')){$('#guest_access_toggle').removeAttr('checked');}else{$('#guest_access_toggle').attr('checked','checked');}
this.on_stanza_error(iq);},on_history_done:function(jid,is_previous_history){jid=util.jid.bare_jid(jid);var chat_display=this.chat_displays[jid];if(!chat_display){return;}
if(this.chats_preload_events[jid].length==0){this.chats_fully_loaded[jid]=true;chat_display.find('.loadLink').remove();}
this.execute_preload_events(jid,is_previous_history);$(chat_display).find('.previousHistory').show();if(!is_previous_history){var self=this;setTimeout(function(){self.scroll_chat(jid);},300);}
if(app.current_jid==jid){$('#loading').hide();chat_display.show();}
if(!is_previous_history&&this.chats_initial_message[jid]){var initial_msg=this.chats_initial_message[jid];var current_block_id='block'+this.current_block_ids[jid];var current_block=$('#'+current_block_id);if(current_block.length==0||current_block.find('p.msgText:last').text()!=initial_msg.find('body').text()){var args=this.get_message_args(initial_msg);this.add_chat_text(jid,initial_msg.find('body').text(),args.message_type,args);}}},on_room_loaded:function(room_jid){this.execute_preload_events(room_jid);var self=this;setTimeout(function(){self.scroll_chat(room_jid);},300);var chat_display=this.chat_displays[room_jid];if(app.current_jid==room_jid){$('#loading').hide();chat_display.show();}
if(chat_display.find('.welcomeMessage').length==0){var welcome_args={jid:room_jid,display_name:app.get_display_name(room_jid),topic:app.get_room_data(room_jid).topic};this.add_chat_text(room_jid,'Welcome','welcome',welcome_args);}},on_stanza_error:function(stanza){var from=$(stanza).attr('from');var errorNode=$(stanza).find('error');var errorType=errorNode.attr('type');var errorText=errorNode.find('text').text();var errorCondition=errorNode.find(':first').text();if(from&&errorType=='cancel'){this.close_chat(from,null,true,false);}
if(errorText&&errorText.length>0){this.show_flash(errorText);}
hipchat.log('info','Stanza Error: '+errorCondition+' ('+errorType+') -- '+errorText);},open_video_ui:function(target_jid,type){var floor=Math.floor;var user_id=util.jid.user_id(target_jid);var url='/chat/video/'+encodeURIComponent(user_id);if(window.location.href.indexOf('min=disable')>=0){url=url+'?min=disable';}
var target_vw=video_config.width;var target_vh=video_config.height;var size=util.size_window(target_vw,target_vh,640,360);var actual_w=size.w;var actual_h=size.h;var vw_ratio=actual_w/target_vw;var vh_ratio=actual_h/target_vh;if(vw_ratio<1&&vh_ratio<1){if(vw_ratio<vh_ratio){actual_w=floor(target_vw*vh_ratio);}else{actual_h=floor(target_vh*vw_ratio);}}else if(vh_ratio<1){actual_w=floor(target_vw*vh_ratio);}else if(vw_ratio<1){actual_h=floor(target_vh*vw_ratio);}
var pos=util.center_window(actual_w,actual_h);var props='width='+actual_w+',height='+actual_h+',top='+pos.top+',left='+pos.left;var vwin=open(url,'HipChat',props);this.attach_video_session(target_jid,vwin,type);vwin.focus();return vwin;},attach_video_session:function(target_jid,vwin,type){delete this.last_video_session_type;this.video_session={jid:target_jid,window:vwin,type:type};},refresh_status_ui:function(){var member=app.get_user_info(app.current_user_jid,true);var default_label='';switch(member.show){case null:case'':default_label=this.PRESENCE_LABEL_AVAILABLE;break;case app.PRESENCE_SHOW_AWAY:default_label=this.PRESENCE_LABEL_AWAY;break;case app.PRESENCE_SHOW_DND:default_label=this.PRESENCE_LABEL_DND;break;}
var status_info=this.get_status_info(member);$('#status_ui span').attr('class',status_info.show);var testRegex=new RegExp('^(?:'+this.PRESENCE_LABEL_AVAILABLE+'|'+this.PRESENCE_LABEL_AWAY+'|'+this.PRESENCE_LABEL_DND+')$');if(member.status&&member.status.length>0){$('#status_dropdown span').html(helpers.escape(helpers.truncate(member.status,12))).css('color','');}else if(default_label.length>0&&(!member.status||$('#status_dropdown span').text().match(testRegex))){$('#status_dropdown span').html(default_label).css('color',this.STATUS_PLACEHOLDER_TEXT_COLOR);}},remove_last_presence:function(room_jid,user_jid){var chat_display=this.chat_displays[room_jid];if(!chat_display){hipchat.log('warn','Call to add text without chat_display available - doing nothing');return;}
user_jid=util.jid.bare_jid(user_jid);var pres_name='presence_'+user_jid;var cur_node=chat_display.find('.chatText > div:last');do{var block=cur_node.find('> div.infoBlock');if(block.length==0){break;}
if(block.attr('name')==pres_name){block.remove();break;}}while(cur_node=cur_node.prev());},request_webkit_notification_permission:function(){if(!window.webkitNotifications){return;}
var perm=window.webkitNotifications.checkPermission();if(perm==1){window.webkitNotifications.requestPermission(function(){hipchat.log('Enabled notifications.');});}},resend_unconfirmed_message:function(message_id){var msg_data=this.unconfirmed_messages[message_id];if(msg_data){app.send_message(msg_data.body,app.current_jid,msg_data.args);}},run_slash_command:function(text){var space_idx=text.indexOf(' ');var command=(space_idx==-1?text:text.substring(0,space_idx));var arg=(space_idx==-1?null:text.substring(space_idx+1));switch(command){case'/available':case'/here':case'/back':app.set_presence(app.PRESENCE_TYPE_AVAILABLE,null,arg,0);$('#status_ui span, #status_message_ui').attr('class','available');return true;case'/away':app.set_presence(app.PRESENCE_TYPE_AVAILABLE,app.PRESENCE_SHOW_AWAY,arg,0);$('#status_ui span, #status_message_ui').attr('class','away');return true;case'/dnd':app.set_presence(app.PRESENCE_TYPE_AVAILABLE,app.PRESENCE_SHOW_DND,arg,0);$('#status_ui span, #status_message_ui').attr('class','dnd');return true;case'/part':this.close_chat(app.current_jid,arg);return true;break;case'/topic':if(arg){this.set_topic(arg);return true;}
break;case'/raw':if(arg){app.send_raw_message(arg);}
return true;break;case'/skype':app.get_profile(app.current_user_jid,this.create_skype_callback(arg,this));return true;}
return false;},create_skype_callback:function(topic,self){return function(profile){if(!profile.skype_name){alert('You must enter your Skype name in your account settings/profile to start a Skype conference');}else{self.start_skype_conference(topic,profile.skype_name);}};},save_tabs_to_auto_join:function(){var auto_join=[];$('#tabs li[name!="tab_lobby"]').each(function(idx,elem){elem=$(elem);var jid=elem.attr('jid');if(jid){var info=(util.jid.is_room(jid)?app.get_room_data(jid):app.get_user_info(jid));auto_join.push({jid:jid,name:(info?info.name:'')});}});util.prefs.set_pref('autoJoin',auto_join);},scroll_at_bottom:function(jid){var chat_display=this.chat_displays[jid];if(!chat_display){return false;}
return this.chats_scroll_at_bottom[jid];},scroll_chat:function(jid,scroll_top){var chat_display=this.chat_displays[util.jid.bare_jid(jid)];if(chat_display){var scroll_to=((scroll_top&&scroll_top!=-1)?scroll_top:chat_display.prop("scrollHeight"));chat_display.scrollTop(scroll_to);}},scroll_down:function(){var display=this.chat_displays[app.current_jid];var distance=($('#main_chat').height()*0.80);$(display).animate({scrollTop:display.scrollTop()+distance});},scroll_to_anchor:function(jid){var anchor_id=this.chats_anchor_ids[jid];if(!anchor_id){return;}
var anchor=$('#'+anchor_id);var chat_display=this.chat_displays[jid];if(!chat_display||!anchor.length==1){return;}
chat_display.scrollTop(chat_display.scrollTop()+anchor.offset().top-chat_display.offset().top);},scroll_up:function(){var display=this.chat_displays[app.current_jid];var distance=($('#main_chat').height()*0.80);$(display).animate({scrollTop:display.scrollTop()-distance});},send_message:function(){var self=this;if($('#upload_ui').is(':visible')&&$('#upload_ui').html().length>0){if($('#upload_ui').find('input:visible').length>0){this.handle_file_name_defocus();}
if(this.upload_data.file){if($('#file_drop_frame').length>0){this.do_iframe_upload();}else if(this.upload_data.binary_file){this.do_file_upload();}else{$(this.file_reader).one('load',function(){self.do_file_upload();});}}else{this.uploader.submit();}
this.upload_data.jid=app.current_jid;this.upload_data.desc=$('#message_input').val();$('#upload_ui').hide();$('#upload_image_tooltip').hide();$('#upload_progress').find('span').html('Uploading '+this.upload_data.filename+'...');$('#upload_progress').show();$('#message_input').val('');return;}
var body=$('#message_input').val();if(!body||body.length==0){return;}
if(body.length>10000){alert('That message is too large. Please shrink it to under 10,000 characters or upload it as a file instead.');return;}
if(this.run_slash_command(body)){$('#message_input').val('');this.focus_message_input();return;}
this.current_message_id++;var args={message_id:'message_'+this.current_message_id,from:app.current_user_jid,message_type:'chat',is_echo:false,time:new Date().getTime(),mention_regex:app.get_mention_regex(app.current_jid),is_current:true};if(app.send_message(body,app.current_jid,args)){this.add_chat_text(app.current_jid,body,'chat',args);$('#message_input').val('');this.focus_message_input();this.scroll_chat(app.current_jid);this.unconfirmed_messages[args.message_id]={body:body,args:args};setTimeout(function(){self.mark_message_unconfirmed(args.message_id);},this.MESSAGE_UNCONFIRMED_MS);}},setup_hotkeys:function(){var bind_elems=[$(document),$('#message_input')];for(i in bind_elems){elem=bind_elems[i];elem.bind('keydown','Ctrl+]',$.proxy(this,'show_next_tab'));elem.bind('keydown','Ctrl+Shift+]',$.proxy(this,'show_next_tab'));elem.bind('keydown','Ctrl+[',$.proxy(this,'show_prev_tab'));elem.bind('keydown','Ctrl+Shift+[',$.proxy(this,'show_prev_tab'));elem.bind('keydown','Ctrl+i',$.proxy(this,'show_room_invite_popup'));var self=this;if(window.fluid){elem.bind('keydown','Meta+Shift+]',$.proxy(this,'show_next_tab'));elem.bind('keydown','Meta+Shift+[',$.proxy(this,'show_prev_tab'));elem.bind('keydown','Ctrl+Tab',$.proxy(this,'show_next_tab'));elem.bind('keydown','Ctrl+Shift+Tab',$.proxy(this,'show_prev_tab'));elem.bind('keydown','Meta+w',function(e){self.close_current_chat();e.preventDefault();e.stopPropagation();});for(var n=1;n<=9;n++){elem.bind('keydown','Meta+'+n,function(e){self.show_tab_num(String.fromCharCode(e.which));e.preventDefault();e.stopPropagation();});}}}},set_profile_with_data:function(data){var profile=$('#profile');if(!data){profile.hide();return;}
if(data.jid!=app.current_jid){return;}
var user_info=app.get_user_info(data.jid);if(!user_info){hipchat.log('warn','No presence info available for user: '+data.jid);profile.hide();return;}
profile.find('.email').html('<a href="mailto:'+data.email+'">'+helpers.truncate(data.email,25)+'</a>');profile.find('.name').html(helpers.truncate(data.name,25));if(data.skype_name){profile.find('.skype').html('<a href="skype:'+helpers.escape(data.skype_name)+'?call">Start Skype call</a>');}else{profile.find('.skype').html('<i>No Skype name available</i>');}
profile.find('.title').html(helpers.escape(data.title)).attr('title',helpers.escape(data.title));profile.find('img.photo').attr('src',data.photo);var status_info=this.get_status_info(user_info);var status_elem=profile.find('.status');status_elem.attr('class','status '+status_info.show);status_elem.find('span').html((status_info.status.length>0?helpers.escape(status_info.status):status_info.text));},set_topic:function(topic){if(config.is_guest){return false;}
if(!topic){topic='';}
return app.set_topic(topic,app.current_jid);},start_skype_conference:function(topic,skype_name){if(!topic){topic='Skype conference';}
return app.send_message("/skype skype:"+skype_name+"?call&token="+encodeURIComponent(topic),app.current_jid);},setup_listeners:function(){var self=this;var message_input=$('#message_input');mention_autocomplete.init(message_input,message_input.parent());message_input.keydown($.proxy(this,'handle_message_keydown'));message_input.keyup($.proxy(this,'handle_message_keyup'));if($.browser.msie){$(document).focusout($.proxy(this,'window_focus_lost')).focusin($.proxy(this,'window_focus_gained'));}else{$(window).blur($.proxy(this,'window_focus_lost')).focus($.proxy(this,'window_focus_gained'));}
$(document).mousedown(function(event){var target=$(event.target);self.is_focused=true;var rightclick=false;if(event.which)rightclick=(event.which==3);else if(event.button)rightclick=(event.button==2);if(!target.is(':input')&&!rightclick){self.focus_message_input();chat.hide_popups();}});if(typeof FileReader!='undefined'){$('body').on('dragenter',function(event){event.stopPropagation();event.preventDefault();}).bind('dragover',function(event){event.stopPropagation();event.preventDefault();}).bind('paste',$.proxy(this,'handle_paste'));if(typeof XMLHttpRequest.sendAsBinary=='undefined'){XMLHttpRequest.prototype.sendAsBinary=function(datastr){function byteValue(x){return x.charCodeAt(0)&0xff;}
var ords=Array.prototype.map.call(datastr,byteValue);var ui8a=new Uint8Array(ords);this.send(ui8a.buffer);};}
var main_chat_node=$('#main_chat').get(0);if(typeof main_chat_node.addEventListener=='function'){main_chat_node.addEventListener('drop',$.proxy(this,'handle_file_drop'),false);}
this.file_reader=new FileReader();if(typeof this.file_reader.addEventListener=='function'){this.file_reader.addEventListener("load",$.proxy(this,'handle_file_load'),false);this.file_reader.addEventListener("error",$.proxy(this,'handle_file_error'),false);}else{this.file_reader.onload=$.proxy(this,'handle_file_load');this.file_reader.onerror=$.proxy(this,'handle_file_error');}}else if($.browser.webkit){$('body').append('<iframe id="file_drop_frame" style="display: none;"></iframe>');this.setup_upload_iframe();$('body').on('dragenter',$.proxy(this,'handle_drag_enter')).bind('drop',$.proxy(this,'handle_drag_out')).bind('dragend',$.proxy(this,'handle_drag_out'));}
$('#upload_progress').click($.proxy(this,'clear_upload'));$(window).on('beforeunload.hipchatCore',function(){if(!app.is_connected){return;}
if(!config.is_guest){util.prefs.save_preferences();}
if(!util.prefs.get_bool_pref('exitWarn')){return;}
return"If you leave, you'll be signed out of HipChat.";});$(window).on('unload.hipchatCore',function(){app.disconnect();});$('#status_dropdown').mouseover(function(){$(this).siblings('.border').show();}).mouseout($.proxy(this,'handle_status_dropdown_mouseout')).mousedown($.proxy(this,'handle_status_dropdown_mousedown'));$('#status_chooser').mousedown($.proxy(this,'handle_status_chooser_mousedown'));$('#status_message_ui').mousedown(function(event){event.stopPropagation();event.preventDefault();});if(config.is_guest){return;}else{this.setup_non_guest_listeners();}},setup_non_guest_listeners:function(){$('.topic_container').dblclick($.proxy(this,'edit_topic'));$('#submit_topic_button').click($.proxy(this,'handle_topic_submit'));$('#cancel_topic_button').click($.proxy(this,'handle_topic_cancel'));$('#topic_input').bind('keydown','esc',$.proxy(this,'handle_topic_cancel')).bind('keydown','return',$.proxy(this,'handle_topic_submit'));var lobby=$('#tabs li[name="tab_lobby"]');lobby.click($.proxy(this,'show_lobby')).mouseover(function(){$(this).toggleClass('hover',true);}).mouseout(function(){$(this).toggleClass('hover',false);});lobby.attr('jid',app.lobby_jid);$('#search_button').click($.proxy(this,'handle_search_button_click'));$('#search_ui').click(function(event){event.stopPropagation();}).keydown($.proxy(this,'handle_search_keydown'));$('#video_button').click($.proxy(this,'handle_video_button_click'));$('#room_actions_button').click($.proxy(this,'handle_room_actions_button'));$('#guest_access_toggle').click($.proxy(this,'toggle_guest_access'));if(config.mobile){$('#search_ui input').blur(function(){$('#search_ui').hide();});}
$('#flash').click($.proxy(this,'handle_flash_click'));$('#submit_new_chat').click($.proxy(function(){return chat.handle_new_chat_create();},this));$('#cancel_new_chat').click($.proxy(this,'handle_new_chat_cancel'));$('#submit_manage_room').click($.proxy(this,'handle_manage_room_save'));$('#cancel_manage_room').click($.proxy(this,'handle_manage_room_cancel'));$('#submit_room_perms').click($.proxy(this,'handle_room_perms_save'));$('#cancel_room_perms').click($.proxy(this,'handle_room_perms_cancel'));$('#new_chat_public, #manage_room_public').click($.proxy(this,'handle_public_radio_click'));$('#new_chat_private, #manage_room_private').click($.proxy(this,'handle_private_radio_click'));$('#submit_settings').click($.proxy(this,'handle_settings_save'));$('#invite_input').keyup(function(event){var input=event.currentTarget;var jqInput=$(input);while(input.style.height>14&&input.scrollHeight<input.offsetHeight){jqInput.height(jqInput.height()-14);}
while(input.scrollHeight>input.offsetHeight){jqInput.height(jqInput.height()+14);}});var self=this;$('#submit_room_invite').click(function(event){return self.handle_send_room_invites(event);});$('#cancel_room_invite').click(function(event){$('#send_room_invites').dialog('close');});},setup_popups:function(){var popup_args={closeText:'',autoOpen:false,closeOnEscape:true,width:422,modal:true,resizable:false,draggable:false};$('#new_chat').dialog(popup_args);$('#manage_room').dialog(popup_args);$('#room_perms').dialog(popup_args);$('#send_room_invites').dialog(popup_args);$('#settings').dialog(popup_args);},setup_upload_iframe:function(){var self=this;$('#file_drop_frame').attr('src','/chat/iframe_upload');$('#file_drop_frame').one('load',function(){var file_dropper=$('#file_drop_frame').contents().find('#file_dropper');file_dropper.on('dragleave',$.proxy(self,'handle_drag_out')).bind('change',$.proxy(self,'handle_file_dropper_change'));});},show_announcement:function(from,message){from_name=app.get_display_name(from);alert('Announcement from '+from_name+':\n\n'+message);},show_change_perms_popup:function(jid){$('#room_perms .user_list').html('<div class="loading"><div style="padding: 10px"><img src="/img/spinner.gif" /> Loading...</div></div>');$('#room_perms').dialog('open');if($('#new_chat').dialog('isOpen')){app.make_api_request('get_group_admins',{},$.proxy(this,'handle_perms_admins_fetch'),true);}else{app.make_api_request('get_room_members',{jid:jid},$.proxy(this,'handle_perms_admins_fetch'),true);}},show_chat_history:function(){var chat_display=$(this.chat_displays[app.current_jid]);chat_display.find('.chatBlock').show();chat_display.find('.showLink').hide();this.scroll_chat(app.current_jid,-1);this.focus_message_input();},show_chat_state_message:function(jid,name){var chat_display=this.chat_displays[jid];if(!chat_display){hipchat.log('warn','Call to add text without chat_display available - doing nothing');return false;}
var state_message=chat_display.find('.chatState');if(state_message){state_message.html('<p>'+name+' is typing...</p>');state_message.show();this.scroll_chat(jid);return true;}
return false;},show_create_room_popup:function(){if(!app.can_create_rooms()){alert('Only admins can create or manage rooms.');return;}
$('#new_chat').dialog('open');$('#new_chat').find(':input[type="text"]').val('').each(function(){removeFormError(this);});if(!app.private_rooms_enabled()){$('#new_chat_privacy_private').hide();}else{$('#new_chat_privacy_private').show();}
$('#new_chat_private_acl').html('Choose who has access...: ');$('#new_chat_public').attr('checked','checked');$('#new_chat_perms_link').hide();$('#new_chat_room_name').focus();},show_invite:function(){if(config.mobile){window.location.href='/invites/send';}else{$('#invite_popup').dialog('open');}},show_file_name_edit:function(){var span=$('#upload_ui').find('span');span.hide();$('#upload_ui').find('input').val(span.text()).show().focus().select();},show_flash:function(msg,delay,jid){if(typeof delay=='undefined'){delay=3000;}
$('#flash .text').html(msg);$('#flash').show();if(delay){setTimeout(function(){$('#flash').hide();},delay);}
if(jid){$('#flash').attr('jid',jid);}else{$('#flash').attr('jid','');}},show_lobby:function(){if(config.is_guest){return false;}
hipchat.log('debug','Focus lobby');util.prefs.set_pref('chatToFocus',app.lobby_jid);if(this.chat_displays[app.current_jid]){this.chats_scroll[app.current_jid]=(this.scroll_at_bottom(app.current_jid)?-1:this.chat_displays[app.current_jid].scrollTop());}
if(config.mobile){$('#tabs, body h2.tabs_header').show();$('#lobby_button').hide();$('#sidebar').show();$('#header a.logo').show();$('#header .chat_name').hide();}
$('#main_chat, #top_bar, #profile, #sidebar .footer .guest_access').hide();$('#lobby, #roster, #sidebar .footer .invite').show();if(!config.vertical_tabs){$('#status_ui').show();}
$('#tabs li').toggleClass('selected',false);$('#tabs li[name="tab_lobby"]').toggleClass('selected',true);app.current_jid=app.lobby_jid;this.update_dimensions();this.update_roster();app.discover_rooms();return false;},show_manage_room_popup:function(jid){if(!app.can_create_rooms()){alert('Only admins can create or manage rooms.');return;}
if(!app.private_rooms_enabled()){alert('Your HipChat subscription does not allow for creating private rooms. You must upgrade your plan to change room permissions.');return;}
$('#manage_room input[name="jid"]').val(jid);var room_data=app.get_room_data(jid);if(room_data.privacy=='private'||room_data.privacy=='secret'){var self=this;var on_members_complete=function(data){var names=[app.get_display_name(data.owner,true)];self.tmp_perms.push(data.owner);if(!data.member){data.member=[];}
if(typeof data.member=='string'){data.member=[data.member];}
for(var i=0;i<data.member.length;i++){names.push(app.get_display_name(data.member[i],true));self.tmp_perms.push(data.member[i]);}
if(!data.admin){data.admin=[];}
if(typeof data.admin=='string'){data.admin=[data.admin];}
for(var j=0;j<data.admin.length;j++){names.push(app.get_display_name(data.admin[j],true));self.tmp_perms.push(data.admin[i]);}
$('#manage_room').dialog('open');$('#manage_room_private_acl').html('The following people will have access: '+helpers.generate_name_list_string(names,10));$('#manage_room_private').attr('checked','checked');$('#manage_room_perms_link').show();};app.make_api_request('get_room_members',{jid:jid},on_members_complete,true);}else{this.tmp_perms=[];$('#manage_room').dialog('open');$('#manage_room_private_acl').html('Choose who has access...: ');$('#manage_room_public').attr('checked','checked');$('#manage_room_perms_link').hide();}},show_next_tab:function(event){var next=$('#tabs li.selected').next();if(!next.length){next=$('#tabs li').first();}
if(next.attr('jid')){this.focus_chat(next.attr('jid'));}
return false;},show_prev_tab:function(event){var prev=$('#tabs li.selected').prev();if(!prev.length){prev=$('#tabs li').last();}
if(prev.attr('jid')){this.focus_chat(prev.attr('jid'));}
return false;},show_reconnect_spinner:function(){$('#flash .spinner').show();},show_room_archive_popup:function(room_jid){var room_name=app.get_display_name(room_jid);var room_data=app.get_room_data(room_jid);var action=room_data.is_archived?'unarchive':'archive';var msg='Are you sure you want to '+action+' the room "'+room_name+'"?';if(!room_data.is_archived){msg+='\n\nUsers will not be able to chat in the room but its history will still be searchable. It can be unarchived at any time.';}
if(confirm(msg)){if(room_data.is_archived){app.set_room_archived(room_jid,false);}else{app.set_room_archived(room_jid,true);}}},show_room_invite_popup:function(){if(!util.jid.is_room(app.current_jid)){return;}
$('#send_room_invites').dialog('open');$('#invite_input, #invite_message').val('').height(14);var names=[];for(var i in app.roster){if(app.roster[i].role=="visitor"){continue;}
names.push(app.roster[i].name);}
$('#invite_input').flushCache().autocomplete(names,{multiple:true});setTimeout(function(){$('#invite_input').focus();},0);},show_room_rename_popup:function(room_jid){var room_name=app.get_display_name(room_jid);var new_name=prompt('Rename the room "'+room_name+'":',room_name);if(new_name&&new_name!=room_name){app.rename_room(room_jid,new_name);}},show_search_ui:function(){$('#search_ui').show();$('#search_ui input.text').val('').focus();},show_settings_popup:function(){$('#settings').dialog('open');var pref_datas=[{pref_name:'notifyForRoom',node_name:'settings_notify_open_room',reverse_checked:false,default_val:true},{pref_name:'notifyForPrivateRoom',node_name:'settings_notify_private_room',reverse_checked:false,default_val:true},{pref_name:'notifyForTag',node_name:'settings_notify_mention',reverse_checked:false,default_val:true},{pref_name:'notifyForPrivate',node_name:'settings_notify_oto_message',reverse_checked:false,default_val:true},{pref_name:'disableSounds',node_name:'settings_sound',reverse_checked:true,default_val:false},{pref_name:'hidePresenceMessages',node_name:'settings_presence',reverse_checked:true,default_val:false},{pref_name:'timeFormat24Hour',node_name:'settings_24_hour',reverse_checked:false,default_val:false},{pref_name:'showToasters',node_name:'settings_toaster',reverse_checked:false,default_val:true},{pref_name:'exitWarn',node_name:'settings_exitwarn',reverse_checked:false,default_val:true}];for(var i in pref_datas){var pref_info=pref_datas[i];var val=util.prefs.get_bool_pref(pref_info['pref_name'],pref_info['default_val']);if((!val&&!pref_info['reverse_checked'])||(val&&pref_info['reverse_checked'])){$('#'+pref_info['node_name']).removeAttr('checked');}else{$('#'+pref_info['node_name']).attr('checked','checked');}}
if(typeof window.webkitNotifications!='undefined'){$('#browser_notifs').show();var perm=window.webkitNotifications.checkPermission();if(perm!==0){$('#settings_toaster').attr('checked',false);}
var self=this;$('#settings_toaster').click(function(e){if($('#settings_toaster').is(':checked')){if(perm==2){alert("You have previously denied permission to show notifications. Please remove this exception in your browser preferences and try again.");$('#settings_toaster').attr('checked',false);}else{self.request_webkit_notification_permission();}}});}else{$('#browser_notifs').hide();}},toaster:{add:function(id,title,content){var self=this;var toasters=self.all();var toaster=self.get(id);if(toaster){toaster.close();}
var $toaster=$('#templates > .toaster').clone();$('body').append($toaster);$toaster.attr('id',id);$('.title',$toaster).text(title);$('.content',$toaster).append(content);toaster={$el:$toaster,on:function(){$toaster.on.apply($toaster,arguments);},trigger:function(){$toaster.trigger.apply($toaster,arguments);},close:function(){delete toasters[id];return $toaster.remove();}};toasters[id]=toaster;$('.close',$toaster).click(function(){$toaster.trigger('closed');toaster.close();});return toaster;},all:function(){return this.toasters=this.toasters||{};},get:function(id){return this.all()[id];},call:{notify:function(from){var id='video_'+from.jid;var toaster=chat.toaster.add(id,from.name,$('#templates > .incoming_call').clone());$('.name',toaster.$el).text(from.display_name);$('.decline',toaster.$el).click(function(){toaster.trigger('declined');toaster.close();});$('.accept',toaster.$el).click(function(){toaster.trigger('accepted');toaster.close();});return toaster;},retract:function(from_jid){var id='video_'+from_jid;var toaster=chat.toaster.get(id);if(toaster){toaster.trigger('missed');toaster.close();}}}},show_tab_num:function(num){var tabs=$('#tabs li');if(num>tabs.length){num=tabs.length;}
var jid=$(tabs[num-1]).attr('jid');chat.focus_chat(jid);},show_topic:function(topic,show_help){if(typeof show_help=='undefined'){show_help=true;}
topic=jQuery.trim(topic);if(!topic||topic.length==0){if(show_help&&!config.is_guest){topic='<em>This is the room topic. Double click to change it.</em>';}}else{topic=helpers.escape_and_linkify(topic,{escape_whitespace:true,do_emoticons:false,do_word_breaks:false});}
$('#topic').html(topic).show();$('#topic_input, .topic_container button').hide();},toggle_archived:function(){var elem=$('#lobby_archived');var arrow_elem=$('h2.archived span.arrow');var arrow='&#9656;';elem.toggle(0,function(){if(elem.is(":visible")){arrow='&#9662;';}
arrow_elem.html(arrow);});},toggle_guest_access:function(){if(!app.can_guest_access()){this.show_flash('Guess access has been disabled by a group administrator.');return false;}
var room_data=app.get_room_data(app.current_jid);var enabled=0;var confirm_msg='';if(!app.is_room_admin(app.current_jid,app.current_user_jid)){alert('There was an error trying to enable guest access. '+'Please make sure you are the room owner or a group admin.');return false;}else if(config.guest_access_enabled=='0'){alert('There was an error trying to enable guest access. '+'Upgrade to a higher plan to enable this feature.');return false;}
if(room_data.guest_url){confirm_msg='The room URL will be disabled and current guests will be kicked from the room';enabled=0;}else{confirm_msg="Anyone with the room's URL will be able to join the room. "+"They won't have access to existing chat history.";enabled=1;}
if(confirm(confirm_msg)){app.send_guest_iq(app.current_jid,enabled);}else{return false;}
return true;},update_dimensions:function(){this.check_tab_scroll();var sidebar_width=(config.mobile||config.minimal?0:220);var top_bar_height=$('#top_bar').outerHeight();var height_without_bar=$(window).height()-$('#header').outerHeight();var height_with_bar=height_without_bar-(top_bar_height-1);var width=$(window).width()-sidebar_width-parseInt($('#main_chat').css('margin-left'),10);var roster_height=($('#top_bar').is(':visible')?height_with_bar:height_without_bar);if($('#status_ui').is(':visible')&&!config.vertical_tabs){roster_height-=$('#status_ui').outerHeight();}
if($('#sidebar .footer').is(':visible')){roster_height-=$('#sidebar .footer').outerHeight();}
if(config.vertical_tabs){var tabs_top_margin=parseInt($('#tabs').css('margin-top'),10);var status_ui_height=($('#status_ui').is(':visible')?$('#status_ui').outerHeight():0);$('#tabs').height(height_without_bar-status_ui_height-tabs_top_margin);}
if(config.mobile){$('#main_chat').width(width);$('#lobby').width(width);if(config.mobile=='iphone'||config.mobile=='ipod'){$('#main_chat').height(height_without_bar+60).css('margin-top','0');}else{$('#main_chat').height(height_without_bar).css('margin-top','0');}
window.scrollTo(0,1);return;}
$('#main_chat').width(width);$('#lobby').width(width);$('#top_bar').width(width+sidebar_width);if($('#top_bar').is(':visible')){$('#lobby').height(height_with_bar).css('margin-top',(top_bar_height-1)+'px');$('#roster .list').height(roster_height);$('#main_chat').height(height_with_bar).css('margin-top',(top_bar_height-1)+'px');$('#sidebar').height(height_with_bar).css('margin-top',(top_bar_height-1)+'px');}else{$('#lobby').height(height_without_bar).css('margin-top','0');$('#roster .list').height(roster_height).css('margin-top','0');$('#main_chat').height(height_without_bar).css('margin-top','0');$('#sidebar').height(height_without_bar).css('margin-top','0');}},update_lobby:function(rooms){if(app.current_jid==app.lobby_jid){$('#loading').hide();}
$('#lobby .private, #lobby_private').hide();$('#lobby .archived, #lobby_archived').hide();$('#lobby div.lobby_display').remove();$('#lobby hr').remove();for(var i=0;i<rooms.length;i++){var room=rooms[i];var section=$('#lobby_open');if(room.is_archived){section=$('#lobby_archived');$('#lobby .archived').show();}else if(room.privacy=='secret'||room.privacy=='private'){section=$('#lobby_private');$('#lobby .private').show();$('#lobby_private').show();}
if(!section.is(':empty')){section.append('<hr />');}
var active_date=new Date();active_date.setTime(room.last_active*1000);var active_data=(room.last_active?'<td class="active">&nbsp;- Active '+helpers.format_time_ago(active_date,true)+'</td>':'');section.append('<div class="lobby_display" jid="'+room.jid+'">'+'<table cellspacing="0"><tr>'+'<td class="name""><div><a class="clean" href="javascript:;" onclick="return false;"">'+util.htmlentities(room.name)+'</a></div></td>'+'<td class="members">'+room.num_participants+' '+(room.num_participants==1?'member':'members')+'</td>'+
active_data+'</tr></table>'+'<table cellspacing="0" class="right"><tr>'+'<td class="owner">Owned by: '+app.get_display_name(room.owner)+'</td>'+
((config.is_admin||room.owner==app.current_user_jid)!=false?('<td><a class="admin_gear" name="'+room.jid+'"><img src="/img/gear_icon.png" alt="admin" /></a></td>'):'')+'</tr></table>'+'</div>');}
$('#lobby .lobby_display').click($.proxy(this,'handle_lobby_row_click'));$('#lobby a.admin_gear').click($.proxy(this,'handle_gear_click')).mouseover(function(){$(this).fadeTo(0,1);}).mouseout(function(){$(this).fadeTo(0,0.7);});},update_nav:function(jid){if(!util.jid.is_room(jid)){return;}
var privacy=(app.is_private_room(jid)?'private':'public');var privacy_node=$('#tabs li[name="tab_'+util.jid.sanitize(jid)+'"]').find('span.private, span.public, span.secret');privacy_node.removeClass().addClass(privacy);},update_nav_text:function(jid,text){var tab=$('#tabs li[name="tab_'+jid+'"]');tab.find('a.open span').html(util.htmlentities(helpers.truncate(text,this.current_tab_truncate_len)));if(config.mobile&&app.current_jid==jid){$('#header .chat_name').html(text);}},update_profile:function(user_jid){hipchat.log('info','Showing profile for user: '+user_jid);app.get_profile(user_jid,$.proxy(this,'set_profile_with_data'));},update_roster:function(room_jid){if(room_jid&&room_jid!=app.current_jid){return;}
var roster=(room_jid?app.room_rosters[room_jid]:app.roster);if(!roster){return;}
$('#roster div.member').remove();for(var i=0;i<roster.length;i++){var status_info=this.get_status_info(roster[i]);var member=roster[i];if(!room_jid&&member.role&&member.role==app.ROLE_VISITOR){continue;}
$('#roster div.list').append('<div jid="'+roster[i].jid+'" class="member '+member.role+' '+status_info.show+'">'+member.name+'<span class="idle">'+status_info.idle+'</span><span class="status">'+helpers.escape(status_info.status)+'</span></div>');}
$('#roster div.member').dblclick($.proxy(this,'handle_roster_dblclick')).mouseover(function(event){$(this).css('background-color','#F0F0F0');}).mouseout(function(event){$(this).css('background-color','#FFFFFF');}).tooltip({bodyHandler:chat.generate_roster_tooltip});if(config.mobile){$('#roster div.member').click($.proxy(this,'handle_roster_dblclick'));}},update_roster_member:function(room_jid,member){var status_info=this.get_status_info(member);if(member.jid==app.current_jid){$('#profile').find(".name").text(member.name);var status_elem=$('#profile').find('.status');status_elem.attr('class','status '+status_info.show);status_elem.find('span').html(status_info.text);}
var tab=$('#tabs li[name="tab_'+member.jid+'"] a.open span').removeClass().addClass(status_info.show);if(member.jid==app.current_user_jid){this.refresh_status_ui();}
if(room_jid!=app.current_jid){return;}
var self=this;var bare_jid=util.jid.bare_jid(member.jid);$('#roster div.member').each(function(idx,node){node=$(node);if(util.jid.bare_jid(node.attr('jid'))!=bare_jid){return;}
node.attr('class','member '+status_info.show);if(status_info.show==app.PRESENCE_TYPE_UNAVAILABLE){node.find('span.idle').html('');node.find('span.status').html('');}else{var num_status_chars=(chat.MAX_ROSTER_CHARS-member.name.length);node.find('span.idle').html(status_info.idle);node.find('span.status').html(helpers.escape(status_info.status));}});},update_status_text:function(){var status_input=$('#status_input');app.set_presence(app.PRESENCE_TYPE_AVAILABLE,app.current_presence.show,status_input.val(),0);if(status_input.val().length>0){$('#status_dropdown span').html(helpers.escape(status_input.val())).css('color','');}else{var displayText='';switch(app.current_presence.show){case null:case'':displayText=this.PRESENCE_LABEL_AVAILABLE;break;case app.PRESENCE_SHOW_AWAY:displayText=this.PRESENCE_LABEL_AWAY;break;case app.PRESENCE_SHOW_DND:displayText=this.PRESENCE_LABEL_DND;break;}
$('#status_dropdown span').html(displayText).css('color',this.STATUS_PLACEHOLDER_TEXT_COLOR);}
$('#status_message_ui').hide();$('#status_ui .border').hide();},update_tab_text:function(room_list){for(var i in room_list){var r=room_list[i];this.update_nav_text(r.jid,r.name);}},validate_new_chat:function(){var name=$('#new_chat_room_name').val();var new_jid=helpers.get_jid_from_chat_name(name);if(!new_jid){addFormError($('#new_chat_room_name'),'Invalid room name');return false;}
if(app.room_exists(new_jid)){addFormError($('#new_chat_room_name'),'That room already exists.  Please choose a different name');return false;}
return true;},window_focus_gained:function(e){if(this.is_focused){return;}
this.is_focused=true;if(this.last_notif){try{this.last_notif.cancel();}catch(err){}
this.last_notif=null;}
if(this.unread_count>0){clearInterval(this.window_blink_timeout);document.title=this.page_title;this.unread_count=0;if(window.fluid){window.fluid.dockBadge=null;}}
Tinycon.setBubble(0);this.focus_message_input();},window_focus_lost:function(){this.is_focused=false;},get_display_name:function(config,args){var anon=config.anonymous;var name=args.display_name;return anon&&name.indexOf('Guest')===0&&name===config.user_name?'You':name;}};var resizeTimer=null;$(window).on('resize',$.proxy(chat,'update_dimensions'));$(window).unload(function(){if(chat.video_session&&chat.video_session.window){chat.video_session.window.close();}});;var helpers={DEFAULT_FILE_TYPE_ICON:'file.png',MS_PER_MINUTE:60000,MS_PER_HOUR:3600000,MS_PER_DAY:86400000,MS_PER_WEEK:604800000,MS_PER_MONTH:2592000000,MS_PER_YEAR:31536000000,TRUNCATE_CHARS:800,TRUNCATE_LINES:6,file_type_icons:{'(png|jpg|jpeg|gif)':'image.png','php':'php.png','(py|c|cpp|as|vb|pl|pm|java|jsp|asp)':'code.png','css':'style.png','html|xml':'html.png','(mp3|ogg|aiff|wma|ra|wav|mid|midi)':'audio.png','(avi|wmv|mp4|mpg|mpeg|mkv|asf|divx|flv|mov|qt|rm|xvid)':'video.png','fla|swf':'flash.png','swf':'flash.png','ai':'illustrator.png','pdf':'pdf.png','psd':'photoshop.png','zip|tgz|7z|tar|rar':'zip.png','xls':'excel.png','doc':'word.png','txt|rtf':'text.png'},day_names:['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],month_names:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],mention_regex:/(\s)(@[-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+|@"[-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+ [-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+")/gi,mention_regex_line_start:/^(@[-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+|@"[-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+ [-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+")/gi,all_mentions_regex:/(?:^(@[-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+|@"[-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+ [-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+")|(\s)(@[-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+|@"[-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+ [-\.\wâáàäåąčćçêéèëęîíìïłñńôóòöøþšśûúùüžżźĄĘĆŁŃÓŚŻŹĄĘĆŁŃÓŚŻŹ]+"))/gi,use_24h:false,escape:function(str){if(!str){return str;}
if(str.indexOf('&')!=-1)str=str.replace(/&/g,'&amp;');if(str.indexOf('<')!=-1)str=str.replace(/</g,'&lt;');if(str.indexOf('>')!=-1)str=str.replace(/>/g,'&gt;');return str;},escape_and_linkify:function(str,args){if(typeof args=='undefined'||args==null){args={};}
var name_regex=(args.hasOwnProperty("name_tag_regex")?args.name_tag_regex:null);var mention_regex=(args.hasOwnProperty("mention_regex")?args.mention_regex:null);var escape_whitespace=(args.hasOwnProperty("escape_whitespace")?args.escape_whitespace:false);var matches=(args.hasOwnProperty("matches")?args.matches:null);var do_escape=(args.hasOwnProperty("do_escape")?args.do_escape:true);var do_linkify=(args.hasOwnProperty("do_linkify")?args.do_linkify:true);var do_emoticons=(args.hasOwnProperty("do_emoticons")?args.do_emoticons:true);var do_word_breaks=(args.hasOwnProperty("do_word_breaks")?args.do_word_breaks:true);var do_mentions=(args.hasOwnProperty("do_mentions")?args.do_mentions:true);if(do_escape){str=helpers.escape(str,escape_whitespace);}
if(do_linkify){str=str.replace(/(?:^|\b)(#[\da-fA-F]{6})\b/gm,"$1 <span class='hexPreview' style='background-color: $1'>&nbsp;</span>");str=linkify.linkify(str,matches,{truncate_length:100,add_wbrs:do_word_breaks});str=emoticons.emoticonify(str);}
if(escape_whitespace){str=str.replace(/\r\n/g,'\n').replace(/[\r\n\u2028]/g,'<br />');}
if(do_mentions){if(name_regex){str=str.replace(name_regex,"<span class='atTag atTagMe'>@$1</span>");}
if(mention_regex){str=str.replace(mention_regex,"<span class='atTag'>@$1</span>");}}
if(matches&&matches.length==0&&do_word_breaks&&!(/[<>]/.test(str))){str=str.replace(/(,)/g,'$1<wbr>');str=str.replace(/([^<>\s]{70})/g,'$1<wbr>');}
if(escape_whitespace){if(str.indexOf('  ')!=-1)str=str.replace(/  /g,'&ensp;&ensp;');if(str.indexOf('\t')!=-1)str=str.replace(/\t/g,'&ensp;&ensp;');}
return str;},escape_file_url:function(url){return url.substr(0,url.lastIndexOf('/')+1)+encodeURIComponent(url.substr(url.lastIndexOf('/')+1));},format_idle:function(idle_seconds){var time_string='';if(!idle_seconds){return time_string;}
if(Math.floor(idle_seconds/86400)>0){time_string+=Math.floor(idle_seconds/86400)+'d ';idle_seconds%=86400;}
if(Math.floor(idle_seconds/3600)>0){time_string+=Math.floor(idle_seconds/3600)+'h ';idle_seconds%=3600;}
if(Math.floor(idle_seconds/60)>0){time_string+=Math.floor(idle_seconds/60)+'m';}
return time_string;},format_multiline_block:function(text){var matches=text.match(/\n.+/gm);if(!matches){return text;}
var numLines=matches.length+1;if(numLines>1){matches=text.match(/^(  |\t)/gm);while(matches&&matches.length==(numLines)){text=text.replace(/^(  |\t)/gm,'');matches=text.match(/^(  |\t)/gm);}}
return text;},format_number:function(nStr){nStr+='';x=nStr.split('.');x1=x[0];x2=x.length>1?'.'+x[1]:'';var rgx=/(\d+)(\d{3})/;while(rgx.test(x1)){x1=x1.replace(rgx,'$1'+','+'$2');}
return x1+x2;},format_time:function(time,time_ago,use_now){var now=new Date();var t=(time?new Date(time):now);var meridiem=(t.getHours()>11?'PM':'AM');var hours=(this.use_24h)?t.getHours():(t.getHours()>12?t.getHours()-12:t.getHours());var minutes=t.getMinutes();if(minutes<10){minutes='0'+minutes;}
if(t.getDate()!=now.getDate()||t.getMonth()!=now.getMonth()){var month=this.month_names[t.getMonth()];return this.use_24h?(month+'-'+t.getDate()+' '+hours+':'+minutes):(month+'-'+t.getDate()+' '+hours+':'+minutes+' '+meridiem);}else{return this.use_24h?hours+':'+minutes:hours+':'+minutes+' '+meridiem;}},format_time_ago:function(time,use_now){var now=new Date();var t=(time?new Date(time):now);var diff=(now.getTime()-t.getTime());var unit='';var count=1;if(diff>this.MS_PER_YEAR){count=Math.round(diff/this.MS_PER_YEAR);unit='year';}else if(diff>this.MS_PER_MONTH){count=Math.round(diff/this.MS_PER_MONTH);unit='month';}else if(diff>this.MS_PER_WEEK){count=Math.round(diff/this.MS_PER_WEEK);unit='week';}else if(diff>this.MS_PER_DAY){count=Math.round(diff/this.MS_PER_DAY);unit='day';}else if(diff>this.MS_PER_HOUR){count=Math.round(diff/this.MS_PER_HOUR);unit='hour';}else if(diff>this.MS_PER_MINUTE){count=Math.round(diff/this.MS_PER_MINUTE);if(use_now&&count<=1){return'now';}
unit='minute';}else{count=Math.round(Math.max(1,diff/1000));unit='second';}
if(count>1){unit+='s';}
return(count+' '+unit+' ago');},generate_name_list_string:function(names,truncate_at){if(typeof truncate_at=='undefined'){truncate_at=10;}
if(names.length>10){var first_n=names.slice(0,truncate_at).join(', ');var others=names.slice(truncate_at).join(', ');return(first_n+' and <span title="'+others+'">'+(names.length-truncate_at)+' others...</span>');}else{return names.join(', ');}},get_abbreviated_name:function(name){var parts=name.split(' ');if(parts.length>1){var last_name=String(parts[parts.length-1]);return(parts[0]+' '+last_name.charAt(0)+'.');}else{return parts[0];}},get_browser_name:function(){var browser;if($.browser.mozilla){browser="firefox";}else if($.browser.msie){browser="ie";}else if(/chrome/.test(navigator.userAgent.toLowerCase())){browser="chrome";}else if($.browser.opera){browser="opera";}else if($.browser.safari){browser="safari";}else{browser="unknown";}
return browser;},get_date_string:function(){var d=new Date();var year=String(d.getFullYear());var month=String(d.getMonth()+1);if(month.length==1){month='0'+month;}
var day=String(d.getDate());if(day.length==1){day='0'+day;}
var hours=String(d.getHours());if(hours.length==1){hours='0'+hours;}
var minutes=String(d.getMinutes());if(minutes.length==1){minutes='0'+minutes;}
var seconds=String(d.getSeconds());if(seconds.length==1){seconds='0'+seconds;}
return year+'-'+month+'-'+day+' '+hours+':'+minutes+':'+seconds;},get_default_mention_name:function(name){return name.replace(/[-. _()\\\/]/g,'');},get_file_size_string:function(size){if(!size){return'';}
var precision=(size>1024?0:2);var sizeString=Number(size/1024).toFixed(precision);var magnitude='K';if(size>1048576){precision=1;sizeString=Number(size/1048576).toFixed(precision);magnitude='MB';}
return sizeString+magnitude;},get_file_type_icon:function(filename){var type=filename.substr(filename.lastIndexOf('.')+1);var source_icon=this.DEFAULT_FILE_TYPE_ICON;for(var ext in this.file_type_icons){var re=new RegExp(ext+'$','i');if(type.match(re)){source_icon=this.file_type_icons[ext];break;}}
return source_icon;},get_idle_seconds:function(pres){pres=$(pres);var idle_node=pres.find('query[xmlns="jabber:iq:last"]:first');var idle_seconds=0;if(idle_node){idle_seconds=parseInt(idle_node.attr('seconds'),10);}
var delay_nodes=pres.find('delay[xmlns="urn:xmpp:delay"]');if(delay_nodes.length>0){var now=new Date();var utc_now=Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate(),now.getUTCHours(),now.getUTCMinutes(),now.getUTCSeconds(),now.getUTCMilliseconds());var delay=this.parse_date($(delay_nodes[0]).attr('stamp'));idle_seconds+=((utc_now/1000)-(delay.getTime()/1000));}
return idle_seconds;},get_jid_from_chat_name:function(chat_name){var node=this.trim(chat_name);node=node.replace(/ /g,'_').replace(/[ '"&\/:<>@]/g,'').toLowerCase();if(node.length==0)
return null;return(config.group_id+'_'+node+'@'+config.conference_server);},get_jid_group_id:function(jid){return parseInt(util.jid.node(jid).substr(0,util.jid.node(jid).indexOf('_')),10);},get_jid_user_id:function(jid){return parseInt(util.jid.node(jid).substring(util.jid.node(jid).indexOf('_')+1),10);},get_jid_room_name:function(jid){return util.jid.node(jid).substring(util.jid.node(jid).indexOf('_')+1);},handle_truncated_link:function(event){var link=$(event.currentTarget);var truncatedElement=link.parent().parent().find('div:first');truncatedElement.toggleClass('truncated');if(truncatedElement.hasClass('truncated')){link.html('Show full text');}else{link.html('Hide full text');}},is_block_chat_type:function(type){switch(type){case'info':case'system':case'welcome':case'file':return true;default:return false;}
return false;},is_image_file:function(filename){var type=filename.substr(filename.lastIndexOf('.'));if(type.match(/(gif|jpg|jpeg|png)$/i)){return true;}
return false;},parse_date:function(stamp){var t=new Date();t.setUTCFullYear(stamp.slice(0,4));t.setUTCMonth(Number(stamp.slice(5,7))-1);t.setUTCDate(stamp.slice(8,10));t.setUTCHours(stamp.slice(11,13));t.setUTCMinutes(stamp.slice(14,16));t.setUTCSeconds(stamp.slice(17,19));return t;},get_file_name_from_path:function(filename){return filename.substr(filename.lastIndexOf('/')+1);},sort_members:function(a,b){return(a.name.toLowerCase()>b.name.toLowerCase()?1:-1);},sort_messages:function(a,b){var aArgs=a.args;var bArgs=b.args;if(!aArgs.time&&!bArgs.time)return 0;else if(aArgs.time&&!bArgs.time)return-1;else if(!aArgs.time&&bArgs.time)return 1;else if(aArgs.time&&bArgs.time){if(aArgs.time<bArgs.time)return-1;else if(aArgs.time>bArgs.time)return 1;}
return 0;},sort_messages_reverse:function(a,b){var aArgs=a.args;var bArgs=b.args;if(!aArgs.time&&!bArgs.time)return 0;else if(aArgs.time&&!bArgs.time)return 1;else if(!aArgs.time&&bArgs.time)return-1;else if(aArgs.time&&bArgs.time){if(aArgs.time<bArgs.time)return 1;else if(aArgs.time>bArgs.time)return-1;}
return 0;},sort_rooms:function(a,b){return(a.name.toLowerCase()>b.name.toLowerCase()?1:-1);},trim:function(str){return str.replace(/^\s*/,"").replace(/\s*$/,"");},truncate:function(str,truncateLength,truncateMiddle){if(!str)
return str;if(truncateLength==0||(str.length-1)<=truncateLength)
return str;if(truncateMiddle)
return(str.substr(0,truncateLength/2)+'...'+str.substr(-1*(truncateLength/2)));else
return str.substr(0,truncateLength)+'...';},truncate_paste:function(body){var matches=body.match(/<br \/>/);if(!matches||matches.length==0){var matches=body.match(/[\n\r\u2028]+.+/g);}
var num_lines=(matches?matches.length+1:1);if(num_lines<this.TRUNCATE_LINES&&body.length<this.TRUNCATE_CHARS){return body;}
body='<span><div class="truncated">'+body+'</div>'+'<div class="showHideLinkContainer nocode"><a onclick="return false;" name="truncate" href="javascript:;">Show full text</a></div></span>';return body;}};;linkify={RE_EMAIL_PATTERN:'(?:\\s|\\A|^)[\\w.-]+\\+*[\\w.-]+@(?:(?:[\\w-]+\\.)+[A-Za-z]{2,6}|(?:\\d{1,3}\\.){3}\\d{1,3})',RE_URL_SCHEME:'(?:[\\w-]{2,}):/{1,3}',RE_TLD:'(?:aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|travel|ac|ad|ae|af|ag|ai|al|am|an|ao|aq|ar|as|at|au|aw|az|ba|bb|bd|be|bf|bg|bh|bi|bj|bm|bn|bo|br|bs|bt|bv|bw|by|bz|ca|cc|cd|cf|cg|ch|ci|ck|cl|cm|cn|co|cr|cu|cv|cx|cy|cz|de|dj|dk|dm|do|dz|ec|ee|eg|eh|er|es|et|fi|fj|fk|fm|fo|fr|ga|gd|ge|gf|gg|gh|gi|gl|gm|gn|gp|gq|gr|gs|gt|gu|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|io|iq|ir|is|it|je|jm|jo|jp|ke|kg|kh|ki|km|kn|kp|kr|kw|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|mg|mh|mk|ml|mm|mn|mo|mp|mq|mr|ms|mt|mu|mv|mw|mx|my|mz|na|nc|ne|nf|ng|ni|nl|no|np|nr|nu|nz|om|pa|pe|pf|pg|ph|pk|pl|pm|pn|pr|ps|pt|pw|qa|re|ro|ru|rw|sa|sb|sc|sd|se|sg|si|sj|sk|sl|sm|sn|so|sr|st|sv|sy|sz|tc|td|tf|tg|th|tj|tk|tm|tn|to|tp|tr|tt|tv|tw|tz|ua|ug|uk|um|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|ye|yt|yu|za|zm|zw)',RE_URL_MIDCHAR:'(?:'+'[^\\s()]+'+'|'+'\\((\\S+)\\)'+')',RE_URL_ENDCHAR:'(?:'+'\\((\\S+)\\)'+'|'+'[^\\s`!()\\[\\]{};:\'".,<>?«»“”‘’]'+')',init:function(){if(this.RE_URL_ENDING){return;}
this.RE_URL_ENDING='(?:'+this.RE_URL_MIDCHAR+'*'+this.RE_URL_ENDCHAR+')?';this.RE_FULL_URL=this.RE_URL_SCHEME+'\\w+(?:.\\w+)'+this.RE_URL_ENDING;this.RE_OTHER_URL='\\w[\\w_-]*(?:\\.\\w[\\w_-]*)*\\.'+this.RE_TLD+'(?:[\\/\\?#]'+this.RE_URL_ENDING+'|\\b)';},linkify:function(text,matched_links,config){this.init();text=this.match_and_replace(this.RE_EMAIL_PATTERN,text,true,false,matched_links,config);text=this.match_and_replace(this.RE_FULL_URL,text,false,false,matched_links,config);text=this.match_and_replace(this.RE_OTHER_URL,text,false,true,matched_links,config);return text;},match_and_replace:function(pattern,input,is_email,add_http,matched_links,config){var start=0;var offset=0;var match_length=0;var end_tag_pos=0;var close_anchor_re=/<\/[aA]>/;var re=new RegExp(pattern,"g");var add_wbrs=(config.hasOwnProperty("add_wbrs")?config.add_wbrs:null);var truncate_length=(config.hasOwnProperty("truncate_length")?config.truncate_length:100);var link_target=(config.hasOwnProperty("link_target")?config.link_target:"_blank");var link_titles=(config.hasOwnProperty("link_titles")?config.link_titles:null);var match={};var max_iter=20;var cur_iter=0;while(match=re.exec(input)){cur_iter++;if(cur_iter>max_iter)
break;start=match.index;match_length=match[0].length;var substr=input.substring(offset,start);if(substr.search(/<[aA]/)>=0){close_anchor_re.lastIndex=offset;var close_anchor_pos=input.substring(offset,input.length).search(close_anchor_re);if(close_anchor_pos<0)
return input;end_tag_pos=close_anchor_pos+offset;re.lastIndex=end_tag_pos+4;offset=end_tag_pos+4;continue;}
var address=input.substr(start,match_length);var escaped_char_match_pos=address.search(/&(amp|gt|lt)$/);if(escaped_char_match_pos>0&&input.length>start+match_length&&input[start+match_length]==';'){var num_chars_matched=address.length-escaped_char_match_pos;match_length-=num_chars_matched;address=input.substr(start,match_length);while(!address.match(this.RE_URL_ENDCHAR+"$")&&match_length>0){match_length--;address=input.substr(start,match_length);}}
var actual=address;if(add_http){actual='http://'+actual;}
var replacement='<a';if(link_target){replacement+=' target="'+link_target+'"';}
replacement+=' href="';if(is_email){replacement+='mailto:';}
actual=actual.replace(/"/g,'%22');replacement+=actual+'"';if(link_titles){var title=is_email?'Email '+actual:actual;replacement+=' title="'+title+'"';}
if(truncate_length&&address.length>truncate_length){address=address.substr(0,truncate_length)+'...';}
if(add_wbrs){address=address.replace(new RegExp("([/=])",'g'),"<wbr>$1");}
replacement+='>'+address+'</a>';if(matched_links){matched_links.push(actual);}
input=input.slice(0,start)+replacement+input.slice(start+match_length,input.length);re.lastIndex=start+replacement.length;offset=start+replacement.length;}
return input;}};;emoticons={path_prefix:'http://www.hipchat.com/img/emoticons',initialized:false,emoticons:[{regex:':D',shortcut:':D',width:18,height:18,image:'bigsmile.png'},{regex:':-D',shortcut:':-D',width:18,height:18,image:'bigsmile.png'},{regex:':o',shortcut:':o',width:18,height:18,image:'gasp.png'},{regex:':Z',shortcut:':Z',width:18,height:18,image:'sealed.png'},{regex:':p',shortcut:':p',width:18,height:18,image:'tongue.png'},{regex:';p',shortcut:';p',width:18,height:18,image:'winktongue.gif'},{regex:'&gt;:-\\(',shortcut:'&gt;:-(',width:18,height:18,image:'angry.png'},{regex:'8\\)',shortcut:'8)',width:18,height:18,image:'cool.png'},{regex:'8-\\)',shortcut:'8-)',width:18,height:18,image:'cool.png'},{regex:':\'\\(',shortcut:':\'(',width:18,height:18,image:'cry.png'},{regex:':\\(',shortcut:':(',width:18,height:18,image:'frown.png'},{regex:':#',shortcut:':#',width:18,height:18,image:'footinmouth.png'},{regex:'\\(embarrassed\\)',shortcut:'(embarrassed)',width:18,height:18,image:'embarrassed.png'},{regex:':\'\\)',shortcut:':\')',width:18,height:18,image:'happytear.gif'},{regex:'O:\\)',shortcut:'O:)',width:18,height:22,image:'innocent.png'},{regex:':-\\*',shortcut:':-*',width:18,height:18,image:'kiss.png'},{regex:':\\$',shortcut:':$',width:18,height:18,image:'moneymouth.png'},{regex:'\\(oops\\)',shortcut:'(oops)',width:18,height:18,image:'oops.png'},{regex:'(:\\\\|:/)',shortcut:':\\',width:18,height:18,image:'slant.png'},{regex:':\\)',shortcut:':)',width:18,height:18,image:'smile.png'},{regex:':-\\)',shortcut:':-)',width:18,height:18,image:'smile.png'},{regex:'=\\)',shortcut:'=)',width:18,height:18,image:'smile.png'},{regex:':-?\\|',shortcut:':|',width:18,height:18,image:'straightface.png'},{regex:'\\(thumbsdown\\)',shortcut:'(thumbsdown)',width:16,height:16,image:'thumbs_down.png'},{regex:'\\(thumbsup\\)',shortcut:'(thumbsup)',width:16,height:16,image:'thumbs_up.png'},{regex:';\\)',shortcut:';)',width:18,height:18,image:'wink.png'},{regex:';-\\)',shortcut:';-)',width:18,height:18,image:'wink.png'}],init:function(){if(this.initialized){return;}
var len=this.emoticons.length;for(var i=0;i<len;i++){var eData=this.emoticons[i];eData.regex=new RegExp('(\\s|\\W|^)'+eData.regex+'(?!\\w)','gim');}
this.initialized=true;},add_emoticon:function(filename,shortcut,height,width){this.init();for(var edata in this.emoticons){if(this.emoticons[edata].shortcut==("("+shortcut+")")){return;}}
var regex_str='\\('+shortcut+'\\)';var emoticon_data={image:filename,height:height,width:width,regex:new RegExp("(\\s|\\W|^)"+regex_str+"(?!\\w|')",'gim'),shortcut:'('+shortcut+')'};this.emoticons.push(emoticon_data);},emoticonify:function(text){this.init();for(var idx in this.emoticons){var e_data=this.emoticons[idx];var regex=e_data.regex;var src=this.path_prefix+'/'+e_data.image;text=text.replace(regex,'$1<img name="emoticon" title="'+e_data.shortcut+'" alt="'+e_data.shortcut+'" height="'+e_data.height+'" width="'+e_data.width+'" src="'+src+'" />');}
return text;}};;util={center_window:function(width,height){var w=window,s=w.screen,floor=Math.floor;var screenLeft=w.screenLeft!=null?w.screenLeft:s.left;var screenTop=w.screenTop!=null?w.screenTop:s.top;return{left:floor((s.availWidth-width)/2)+screenLeft,top:floor((s.availHeight-height)/3)+screenTop};},debounce:function(fn,wait){var timeout;return function(){var ctx=this,args=[].slice.call(arguments);function later(){timeout=null;fn.apply(ctx,args);}
if(timeout){clearTimeout(timeout);}
timeout=setTimeout(later,wait||50);};},htmlentities:function(text){var d=$('<div/>');d.text(text);return d.html();},keys:function(obj){return obj?$.map(obj,function(v,k){return k;}):[];},size_window:function(target_w,target_h,min_w,min_h){var s=window.screen,floor=Math.floor,min=Math.min,max=Math.max;var max_ratio=0.9;return{w:max(min(floor(s.availWidth*max_ratio),target_w),min_w||100),h:max(min(floor(s.availHeight*max_ratio),target_h),min_h||100)};},strip_tags:function(input,allowed){allowed=(((allowed||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join('');var tags=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,commentsAndPhpTags=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return input.replace(commentsAndPhpTags,'').replace(tags,function($0,$1){return allowed.indexOf('<'+$1.toLowerCase()+'>')>-1?$0:'';});},jid:{bare_jid:function(val){if(!val)return false;return val.split('/')[0];},domain:function(val){if(!val)return false;return val.split('@')[1].split('/')[0];},group_id:function(val){var node=this.node(val);var id=node.substr(0,node.indexOf('_'));return parseInt(id,10);},is_private_chat:function(val){return(this.domain(val)==config.chat_server);},is_room:function(val){return(this.domain(val)==config.conference_server);},node:function(val){if(!val)return false;return val.split('@')[0];},resource:function(val){var i=val.indexOf('/');if(i==-1){return null;}
return val.substr(i+1);},room_name:function(val){var node=this.node(val);var name=node.substr(node.indexOf('_')+1);return name;},sanitize:function(val){return val.replace('\\','\\\\');},user_id:function(val){var node=this.node(val);var id=node.substr(node.indexOf('_')+1);if(id.match(/[0123456789]+/)){return parseInt(id,10);}
return null;}},prefs:{changed:false,get_bool_pref:function(name,default_val){if(name in config.prefs){var val=config.prefs[name];var ret=false;if(val==='true'||val===true){ret=true;}else if(val==='false'||val===false){ret=false;}else{ret=val;}
return ret;}
return default_val;},get_pref:function(name,default_val){if(config.prefs[name]){return config.prefs[name];}
return default_val;},save_preferences:function(){if(this.changed){hipchat.log('debug','Saving preferences');app.make_api_request('save_preferences',{pref_data:config.prefs},null,true);this.changed=false;}},set_pref:function(name,val,save_now){config.prefs[name]=val;this.changed=true;if(save_now){this.save_preferences();}}}};;app={HISTORY_STANZAS_TO_REQUEST:50,JOIN_STANZAS_TO_REQUEST:50,IDLE_DELAY_MS:300000,PRESENCE_TYPE_AVAILABLE:'available',PRESENCE_TYPE_UNAVAILABLE:'unavailable',PRESENCE_SHOW_AWAY:'away',PRESENCE_SHOW_DND:'dnd',PRESENCE_SHOW_CHAT:'chat',PRESENCE_SHOW_XA:'xa',ROLE_PARTICIPANT:'participant',ROLE_VISITOR:'visitor',chat_is_loading:{},connection:null,current_presence:{show:null,status:null,type:'available'},current_user_jid:'',current_user_nickname_jid:'',current_jid:'',departure_timers:{},display_names:[],do_reconnect:false,guest_list:{},idle_timeout:null,is_idle:false,lobby_jid:'lobby@'+config.conference_server,mention_regexes:{},nickname_maps:{},previous_jid:null,previous_presence:{show:null,status:null,type:'available'},profiles:[],reconnect_timer:null,room_rosters:[],room_history_loaded:{},room_list:[],room_loaded:{},roster:[],roster_loaded:false,token_info:{},user_idle_times:{},add_room_occupant:function(pres,item,room_jid,user_jid,nickname){var type=pres.attr('type')||'available';var member_info=this.get_user_info(user_jid,true);var mobile=(util.jid.resource(user_jid)=='iphone'?'iphone':false);var occupant={affiliation:item.attr('affiliation'),name:nickname,mention_name:member_info.mention_name,jid:user_jid,role:item.attr('role'),show:member_info.show,status:member_info.status,mobile:mobile,type:type,idle:helpers.get_idle_seconds(pres)};this.room_rosters[room_jid].push(occupant);if(this.room_loaded[room_jid]){if(this.departure_timers[room_jid]&&this.departure_timers[room_jid][user_jid]){clearTimeout(this.departure_timers[room_jid][user_jid]);}else if(this.room_history_loaded[room_jid]){if(type==this.PRESENCE_TYPE_UNAVAILABLE){chat.add_chat_text(room_jid,nickname+' was added to the room.','info',{from:user_jid,type:'presence'});}else if(type==this.PRESENCE_TYPE_AVAILABLE&&!util.prefs.get_bool_pref('hidePresenceMessages')){chat.remove_last_presence(room_jid,user_jid);chat.add_chat_text(room_jid,nickname+' joined the room.','info',{from:user_jid,type:'presence'});}}
chat.update_roster(room_jid);}
return occupant;},add_to_auto_join:function(jid,name){if(config.is_guest){return false;}
var auto_join=util.prefs.get_pref('autoJoin',[]);for(var i in auto_join){if(auto_join[i].jid==jid){return false;}}
auto_join.push({jid:jid,name:name});util.prefs.set_pref('autoJoin',auto_join,true);return true;},auto_join_chats:function(){hipchat.log('info','Auto joining rooms');chat.leave_chats_not_in_auto_join();var auto_join=util.prefs.get_pref('autoJoin',[]);for(var i=0;i<auto_join.length;i++){var jid=auto_join[i].jid;var name=auto_join[i].name;this.join_chat(jid,name);}
var chat_to_focus=util.prefs.get_pref('chatToFocus');if(chat_to_focus){chat.focus_chat(chat_to_focus);}else{chat.show_lobby();}},can_create_rooms:function(){return this.is_perm_enabled('create_rooms');},can_edit_history:function(){return this.is_perm_enabled('history_edit_perm');},can_edit_profile:function(){return this.is_perm_enabled('profile_edit');},can_guest_access:function(){return this.is_perm_enabled('guest_access');},can_private_chat:function(){return this.is_perm_enabled('oto_chat');},can_send_invites:function(){return this.is_perm_enabled('send_invites');},can_share_files:function(){return this.is_perm_enabled('file_sharing');},clear_data:function(){this.room_rosters=[];this.room_history_loaded={};this.room_loaded={};this.roster=[];this.roster_loaded=false;},connect:function(){this.connection.attach(config.jid,config.sid,config.rid,$.proxy(this,'on_connect_change'));this.on_connect();},create_room:function(room_jid,room_name,privacy,members,topic,send_invites){hipchat.log('info','Creating room '+room_jid);this.join_room(room_jid,room_name,privacy,members,topic,send_invites);},destroy_room:function(room_jid){var iq=$iq({type:'set',to:room_jid}).c('query',{xmlns:'http://jabber.org/protocol/muc#owner'}).c('destroy').c('reason').t('Admin is deleting the room');this.connection.sendIQ(iq.tree(),function(data){if(data&&data.error){alert('There was a problem deleting the room. Please try again later.');}else{chat.show_flash('Room successfully deleted');app.discover_rooms();}},$.proxy(this,'handle_iq_err'));},disconnect:function(){this.connection.disconnect();},discover_rooms:function(){hipchat.log('info','Getting room list');var disco=$iq({type:'get',to:config.conference_server}).c('query',{xmlns:'http://jabber.org/protocol/disco#items'});this.connection.sendIQ(disco.tree(),$.proxy(this,'handle_disco_rooms'),$.proxy(this,'handle_iq_err'));},fetch_roster:function(){if(config.is_guest){return;}
hipchat.log('info','Fetching roster');var iq=$iq({type:'get'}).c('query',{xmlns:'jabber:iq:roster'});this.connection.sendIQ(iq.tree(),$.proxy(this,'handle_roster_fetch'),$.proxy(this,'handle_iq_err'));},get_api_auth_token:function(){var d=new Date();if(this.token_info&&this.token_info.expiration<d.getTime()){return this.token_info.token;}
var iq=$iq({type:'get',to:config.chat_server}).c('query',{xmlns:'http://hipchat.com/protocol/auth'});var self=this;this.connection.sendIQ(iq.tree(),$.proxy(this,'handle_auth_token'),$.proxy(this,'handle_iq_err'));return null;},get_display_name:function(jid,abbrev,default_name){abbrev=false;if(typeof default_name=='undefined'){default_name='Unknown';}
if(!jid||typeof jid=='undefined'){return default_name;}
jid=util.jid.bare_jid(jid);var member=this.display_names[jid];if(member){if(abbrev&&!member.abbreviated_name){member.abbreviated_name=helpers.get_abbreviated_name(member.name);return member.abbreviated_name;}
return(abbrev?member.abbreviated_name:member.name);}
return default_name;},get_emoticons:function(){var iq=$iq({type:'get'}).c('query',{xmlns:'http://hipchat.com/protocol/emoticons'});this.connection.sendIQ(iq.tree());},get_guest_info:function(jid){return this.guest_list[util.jid.bare_jid(jid)];},get_jid_by_name:function(name){for(var i in this.display_names){if(this.display_names[i].name==name){return i;}}
return null;},get_mention_real_name:function(mention){if(mention.charAt(0)=='@'){mention=mention.substring(1);}
mention=mention.toLowerCase();for(var i=0;i<this.roster.length;i++){var member=this.roster[i];if(member.mention_name&&member.mention_name.toLowerCase()==mention){return member.name;}}
return mention;},get_mention_regex:function(jid){jid=util.jid.bare_jid(jid);var is_private_room=this.is_private_room(jid);var is_private_chat=util.jid.is_private_chat(jid);if(!jid||typeof jid=='undefined'||!is_private_room){jid="all";}
if(this.mention_regexes[jid]){return this.mention_regexes[jid];}
this.update_mention_regex(jid=="all"?null:jid);return this.mention_regexes[jid];},get_profile:function(user_jid,callback){user_jid=util.jid.bare_jid(user_jid);if(this.profiles[user_jid]){callback(this.profiles[user_jid]);return;}
hipchat.log('info','Fetching profile for '+user_jid);var user_id=util.jid.user_id(user_jid);var args={jid:user_jid,profile_id:user_id};var self=this;var iq=$iq({type:'get',to:user_jid}).c('query',{xmlns:'http://hipchat.com/protocol/profile'});this.connection.sendIQ(iq.tree(),function(response){response=$(response);var data={'jid':user_jid,'name':response.find('name').text(),'title':response.find('title').text(),'email':response.find('email').text(),'photo':response.find('photo_large').text(),'photo_small':response.find('photo_small').text(),'skype_name':response.find('skype_name').text()};self.profiles[user_jid]=data;callback(data);},function(err){hipchat.log('error','Error while getting profile info: '+err);callback(null);});},get_reason_for_departure:function(status){switch(status){case'hc-disconnect':return'user disconnected';case'hc-leave':return null;case'hc-timeout':return'lost connection';case'hc-conflict':return'user disconnected';}
return status;},get_room_data:function(room_jid){for(var i in this.room_list){var room=this.room_list[i];if(room.jid==room_jid){return room;}}
return null;},get_room_occupant:function(room_jid,user_jid){if(!this.room_rosters[room_jid]){return null;}
var bare_jid=util.jid.bare_jid(user_jid);for(var i=0;i<this.room_rosters[room_jid].length;i++){var occ=this.room_rosters[room_jid][i];if(util.jid.bare_jid(occ.jid)==bare_jid){return occ;}}
return null;},get_user_info:function(user_jid,return_placeholder){return_placeholder=(typeof return_placeholder=='undefined'?false:return_placeholder);var bare_jid=util.jid.bare_jid(user_jid);for(var i=0;i<this.roster.length;i++){var member=this.roster[i];if(util.jid.bare_jid(member.jid)==bare_jid){return member;}}
return(return_placeholder?{name:''}:null);},handle_auth_token:function(iq){var token_data=$(iq).find('token');this.token_info={token:token_data.text(),expiration:(parseInt(token_data.attr('expiration'),10)*1000)};var d=new Date();setTimeout($.proxy(this,'get_api_auth_token'),(this.token_info.expiration-d.getTime())+5000);$(window).triggerHandler('load.auth_token');},handle_disco_rooms:function(data){this.room_list=[];var self=this;$(data).find('query > item').each(function(idx,elem){elem=$(elem);var room={jid:elem.attr('jid'),name:elem.attr('name'),topic:elem.find('topic').text(),privacy:elem.find('privacy').text(),owner:elem.find('owner').text(),last_active:elem.find('last_active').text(),num_participants:elem.find('num_participants').text(),guest_url:elem.find('guest_url').text(),is_archived:(elem.find('is_archived').length==1)};self.room_list.push(room);self.display_names[room.jid]=room;});this.room_list=this.room_list.sort(helpers.sort_rooms);chat.update_lobby(this.room_list);chat.update_tab_text(this.room_list);$(window).triggerHandler('hipchat.disco_rooms');},handle_emoticons:function(iq){iq=$(iq);path_prefix=iq.find('path_prefix').text();if(path_prefix){emoticons.path_prefix=path_prefix;}
iq.find('item').each(function(idx,elem){var shortcut=$(elem).find('shortcut').text();var path=$(elem).find('path').text();var width=$(elem).find('w').text();var height=$(elem).find('h').text();emoticons.add_emoticon(path,shortcut,height,width);});},handle_history_error:function(iq,jid){if($(iq).find('resource-constraint').length>0){var msg='We are temporarily unable to load chat history. Please try again in a few moments.';chat.add_chat_text(jid,msg,'system',{display_name:'HipChat'});}else{this.handle_iq_err(iq);}},handle_iq:function(iq){iq=$(iq);var query=iq.find('query[xmlns="http://hipchat.com/protocol/emoticons"]');if(query.length>0){this.handle_emoticons(iq);}
var item=iq.find('query[xmlns="jabber:iq:roster"] item');if(item.length>0){var jid=item.attr('jid');var name=item.attr('name');var member=this.get_user_info(jid);if(member){if(item.attr('subscription')=='remove'){this.remove_user_info(jid);}else{member.name=name;member.mention_name=(item.attr('mention_name')||'');member.display_name=(item.attr('display_name')||name);this.set_display_name(jid,member.name,member.display_name,true);}}else{member={roster_push:true,jid:jid,name:name,mention_name:(item.attr('mention_name')||''),display_name:(item.attr('display_name')||name),role:'participant'};this.roster.push(member);this.set_display_name(jid,name);}
this.roster=this.roster.sort(helpers.sort_members);chat.update_roster_member(this.current_jid,jid);}
return true;},handle_iq_err:function(iq){hipchat.log('error','IQ error: '+$(iq).find('error >:first-child').get(0).nodeName);},handle_presence:function(pres){pres=$(pres);if(pres.attr('type')=='error'){chat.on_stanza_error(pres);return true;}
var from=pres.attr('from');if(util.jid.is_room(from)){this.handle_room_presence(pres);}else{this.handle_user_presence(pres);}
return true;},handle_room_presence:function(pres){var from=pres.attr('from');var room_jid=util.jid.bare_jid(from);var nickname=util.jid.resource(from);var status;if(!this.nickname_maps[room_jid]){this.nickname_maps[room_jid]={};}
var hc_nodes=pres.find('x[xmlns="http://hipchat.com/protocol/muc#room"]');if(hc_nodes.length>0){var hc_node=$(hc_nodes[0]);this.update_room_with_extension(room_jid,hc_node);}
var muc_nodes=pres.find('x[xmlns="http://jabber.org/protocol/muc#user"]');if(muc_nodes.length>0){var muc_node=$(muc_nodes[0]);var item=muc_node.find('item:first');var destroy=muc_node.find('destroy');if(destroy.length>0){this.on_destroy_room(destroy.attr('jid'));return;}
var user_jid=null;if(item.attr('jid')){var display_name=item.attr('display_name');var mention_name=item.attr('mention_name');var role=(item.attr('role')||'participant');user_jid=item.attr('jid');this.nickname_maps[room_jid][nickname]=user_jid;var occupant=this.get_room_occupant(room_jid,user_jid);var member_info=this.get_user_info(user_jid);if(!member_info){member_info={jid:user_jid,name:nickname,mention_name:(mention_name||helpers.get_default_mention_name(nickname)),display_name:nickname,abbreviated_name:(display_name||nickname),role:role};this.roster.push(member_info);}
if(config.is_guest){var show=pres.find('show:first').text();var status=pres.find('status:first').text();member_info.show=show;member_info.status=status;member_info.idle=helpers.get_idle_seconds(pres);}
if(role==app.ROLE_VISITOR){var guest_info=this.get_guest_info(user_jid);if(!guest_info){this.guest_list[util.jid.bare_jid(user_jid)]=member_info;this.update_mention_regex(room_jid);}else{guest_info.mention_name=mention_name;}}
this.set_display_name(user_jid,nickname,display_name);if(!occupant){occupant=this.add_room_occupant(pres,item,room_jid,user_jid,nickname);}else{this.update_room_occupant(occupant,pres,item,room_jid,user_jid,nickname);}}
var status=muc_node.find('status:first');if(status&&status.attr('code')==110&&(pres.attr('type')||'available')=='available'){if(this.room_loaded[room_jid]){this.chat_is_loading[room_jid]=false;this.room_history_loaded[room_jid]=true;chat.on_room_loaded(room_jid);}
this.room_loaded[room_jid]=true;this.room_rosters[room_jid]=this.room_rosters[room_jid].sort(helpers.sort_members);if(this.current_jid==room_jid){chat.update_roster(room_jid);}}else if(status&&status.attr('code')==307){user_jid=this.jid_from_nickname(room_jid,util.jid.resource(from));var actor_jid=muc_node.find('actor').attr('jid');this.remove_room_occupant(room_jid,user_jid);chat.update_roster(room_jid);chat.handle_user_kicked(room_jid,user_jid,actor_jid);}}},handle_roster_fetch:function(data){this.roster=[];var self=this;$(data).find('query item').each(function(idx,elem){elem=$(elem);var display_name=elem.attr('display_name');var mention_name=elem.attr('mention_name');var roster_item={jid:elem.attr('jid'),name:elem.attr('name'),type:'unavailable',role:'participant',mobile:elem.attr('mobile'),display_name:elem.attr('name'),abbreviated_name:(display_name||helpers.get_abbreviated_name(elem.attr('name'))),mention_name:mention_name};self.display_names[util.jid.bare_jid(elem.attr('jid'))]=roster_item;self.roster.push(roster_item);});this.roster=this.roster.sort(helpers.sort_members);this.roster_loaded=true;if(this.current_jid==this.lobby_jid){chat.update_roster();}
this.set_presence('available',null,null,null,true);this.get_api_auth_token();this.get_emoticons();this.discover_rooms();var profile_args={jid:this.current_user_jid,profile_id:util.jid.user_id(this.current_user_jid),photo_size:'small'};this.get_profile(this.current_user_jid,$.proxy(chat,'handle_user_profile'));$(window).one('hipchat.disco_rooms',function(){self.auto_join_chats();});},handle_stream_error:function(node){hipchat.log('info','Stream error~~~~');},handle_user_action:function(event){clearTimeout(this.idle_timeout);if(this.is_idle){this.on_user_active();}
this.idle_timeout=setTimeout($.proxy(this,'on_user_idle'),this.IDLE_DELAY_MS);},handle_user_presence:function(pres){var user_jid=pres.attr('from');var member=this.get_user_info(user_jid);var idle_seconds=helpers.get_idle_seconds(pres);var show=pres.find('show:first').text();var status=pres.find('status:first').text();var type=pres.attr('type');var mobile=(util.jid.resource(user_jid)=='iphone'?'iphone':false);if(pres.find('mobile').length>0){mobile=pres.find('mobile').attr('type')||'sms';}
if(!member){hipchat.log('error','Got presence from user with no info: '+user_jid);return;}else{member.type=type;member.show=show;member.status=status;member.presence=pres;if(mobile){member.mobile=mobile;}
member.idle=idle_seconds;chat.update_roster_member(this.lobby_jid,member);}
for(var room_jid in this.room_loaded){if(this.room_loaded[room_jid]==true){var occupant=this.get_room_occupant(room_jid,user_jid);if(!occupant){continue;}
if(this.is_private_room(room_jid)&&occupant.type==this.PRESENCE_TYPE_UNAVAILABLE){continue;}
occupant.type=type;occupant.show=show;occupant.status=status;occupant.idle=idle_seconds;if(mobile){occupant.mobile=mobile;}
chat.update_roster_member(room_jid,occupant);}}},init:function(){this.setup_connection();this.setup_idle_events();setInterval($.proxy(this,'update_idle_times'),60000);if(!config.is_guest){setInterval($.proxy(util.prefs,'save_preferences'),60000);}},invite_to_room:function(room_jid,jids,message){var msg=$msg({from:this.current_user_jid,to:room_jid}).c('x',{xmlns:'http://jabber.org/protocol/muc#user'});for(var i in jids){msg.c('invite',{to:jids[i]});if(message){msg.c('reason').t(message).up();}
msg.up();}
this.connection.send(msg.tree());},is_private_room:function(room_jid){var room_data=this.get_room_data(room_jid);if(!room_data){return false;}
return(room_data.privacy=='private'||room_data.privacy=='secret');},is_room_admin:function(room_jid,user_jid){if(config.is_admin){return true;}
var occupant=this.get_room_occupant(room_jid,user_jid);if(occupant.affiliation=='admin'||occupant.affiliation=='owner'){return true;}
return false;},is_perm_enabled:function(perm_name){if(typeof config.perms[perm_name]=='undefined'||config.perms[perm_name]=='none'||(config.perms[perm_name]=='admins'&&!config.is_admin)){return false;}
return true;},jid_from_nickname:function(room_jid,nickname){if(this.nickname_maps[room_jid]&&this.nickname_maps[room_jid][nickname]){return this.nickname_maps[room_jid][nickname];}
return null;},join_chat:function(jid,name){if(util.jid.is_private_chat(jid)&&!this.can_private_chat()){hipchat.log('info','Private chats are disabled. Not joining chat: '+jid);return false;}
var is_room=util.jid.is_room(jid);if(!name||name=='null'){if(is_room){var room_data=this.get_room_data(jid);name=room_data.name;}else{name=this.get_display_name(jid,true);}}
if(is_room){this.join_room(jid,name);}else if(util.jid.is_private_chat(jid)){if(chat.add_chat_display(jid,name)){this.request_history(jid,null,null);}}
return true;},join_room:function(room_jid,room_name,privacy,members,topic,send_invites){hipchat.log('info','Joining room '+room_jid);if(this.room_loaded[room_jid]){hipchat.log('warn','Room is already open: '+room_jid);return;}
room_name=(typeof room_name=='undefined'?null:room_name);privacy=(typeof privacy=='undefined'?null:privacy);members=(typeof members=='undefined'?null:members);topic=(typeof topic=='undefined'?null:topic);send_invites=(typeof send_invites=='undefined'?null:send_invites);if(!room_name){var room_data=this.get_room_data(room_jid);if(room_data){room_name=room_data.name;}
if(!room_name){var node=util.jid.node(room_jid);room_name=node.substr(node.indexOf('_')+1);}}
var jid=room_jid+'/'+config.user_name;var pres=$pres({to:jid}).c('x',{xmlns:'http://jabber.org/protocol/muc'}).up().c('x',{xmlns:'http://hipchat.com/protocol/muc#room'});if(room_name){pres.c('name').t(room_name).up();}
if(privacy){pres.c('privacy').t(privacy).up();}
if(send_invites){pres.c('send_invites').t((send_invites?'1':'0')).up();}
if(members){pres.c('members');for(var i=0;i<members.length;i++){pres.c('jid').t(members[i]).up();}
pres.up();}
if(topic){pres.c('topic').t(topic).up();}
pres.c('history',{maxstanzas:this.JOIN_STANZAS_TO_REQUEST}).up().up();this.connection.send(pres.tree());this.setup_room_vars(room_jid,room_name);chat.add_chat_display(room_jid,room_name);},keep_alive:function(){var ping=$iq({type:'get',to:config.chat_server}).c('ping',{xmlns:'urn:xmpp:ping'});this.connection.send(ping);return true;},leave_room:function(room_jid,leave_message,send_presence){if(typeof send_presence=='undefined'){send_presence=true;}
if(send_presence){var jid=util.jid.bare_jid(room_jid)+'/'+config.user_name;var pres=$pres({to:jid,type:'unavailable'});if(leave_message){pres.c('status').t(leave_message);}
this.connection.send(pres.tree());}
this.room_rosters[room_jid]=[];this.room_loaded[room_jid]=false;this.room_history_loaded[room_jid]=false;this.chat_is_loading[room_jid]=null;this.departure_timers[room_jid]={};},make_api_request:function(func,args,callback,token_required){var self=this;if(!this.token_info.token&&token_required){$(window).one('load.auth_token',function(){self.make_api_request(func,args,callback,token_required);});return;}
$.ajax({type:"POST",dataType:'json',url:"/api/"+func,data:$.extend(args,{user_id:util.jid.user_id(this.current_user_jid),group_id:util.jid.group_id(this.current_user_jid),token:this.token_info.token,format:'json'}),async:true,success:callback});},on_connect:function(){this.connection.rawInput=this.on_incoming_data;this.connection.rawOutput=this.on_outgoing_data;this.connection.addHandler($.proxy(this,'handle_presence'),null,'presence',null,null,null);this.connection.addHandler($.proxy(chat,'handle_message'),null,'message',null,null,null);this.connection.addHandler($.proxy(this,'handle_iq'),null,'iq',null,null,null);this.connection.addTimedHandler(30000,$.proxy(this,'keep_alive'));this.current_jid=this.lobby_jid;this.current_user_jid=config.user_jid;this.current_user_nickname_jid=config.user_name+'@'+config.chat_server;chat.close_chats();this.fetch_roster();chat.hide_flash();this.do_reconnect=true;if(this.reconnect_timer){clearTimeout(this.reconnect_timer);}
this.is_connected=true;if(config.is_guest){this.set_presence('available',null,null,null,true);this.get_api_auth_token();this.get_emoticons();if(this.join_chat(config.room_jid,config.room_name)){chat.focus_chat(config.room_jid);}}},on_connect_change:function(status,condition){if(status!=Strophe.Status.CONNECTING){chat.hide_reconnect_spinner();}
if(status==Strophe.Status.CONNECTING){this.connection_failed=false;hipchat.log('debug','Strophe is connecting.');}else if(status==Strophe.Status.CONNFAIL){hipchat.log('debug','Strophe failed to connect. Condition: '+condition);this.connection_failed=true;this.on_connection_fail(condition);}else if(status==Strophe.Status.DISCONNECTING){hipchat.log('debug','Strophe is disconnecting. Condition: '+condition);}else if(status==Strophe.Status.DISCONNECTED){hipchat.log('debug','Strophe is disconnected.');this.on_disconnect();}else if(status==Strophe.Status.CONNECTED){this.connection_failed=false;hipchat.log('debug','Strophe is connected.');this.on_connect();}},on_connection_fail:function(condition){this.is_connected=false;var msg='HipChat is having trouble connecting to the network.';switch(condition){case'conflict':this.do_reconnect=false;msg='Your account was disconnected. <a href="javascript:;" onclick="chat.hide_flash(); app.reconnect(); return false;">Click here to reconnect</a>.';break;case'not-allowed':location.reload(true);break;case'plan-change':msg='You have been disconnected. An administrator is changing your HipChat subscription.';break;case'system-shutdown':case'see-other-host':msg='The HipChat server you\'re connected to is being upgraded.';break;}
if(this.do_reconnect){msg+=" Trying to reconnect...";}
chat.show_flash(msg,0);},on_destroy_room:function(room_jid){var room_info=this.get_room_data(room_jid);chat.show_flash('The room '+room_info.name+' is being deleted by an admin.');chat.close_chat(room_jid,null,true,false);},on_disconnect:function(){this.is_connected=false;if(!this.connection_failed){var msg='HipChat is having trouble connecting to the network.\nTrying to reconnect...';chat.show_flash(msg,0);}
if(this.do_reconnect&&!this.reconnect_timer){var delay=(10+Math.random()*20)*1000;this.reconnect_timer=setTimeout($.proxy(this,'refresh_reconnect_timer'),delay);}
this.clear_data();this.connection=null;},on_incoming_data:function(data){if(app.debug&&app.debug.test(data)){hipchat.log('debug','RECV: '+data);}},on_outgoing_data:function(data){if(app.debug&&app.debug.test(data)){hipchat.log('debug','SENT: '+data);}},on_user_active:function(){hipchat.log('info','Returning from idle');this.is_idle=false;this.set_presence(this.previous_presence.type,this.previous_presence.show,this.previous_presence.status);},on_user_idle:function(){hipchat.log('info','Going idle');this.is_idle=true;this.set_presence('available','away',this.current_presence.status,(this.IDLE_DELAY_MS/1000));},private_rooms_enabled:function(){return config.private_rooms_enabled;},open_private_chat:function(jid,name){this.request_history(jid,null,null);},queue_departure:function(room_jid,user_jid,msg){if(util.prefs.get_bool_pref('hidePresenceMessages')){return;}
var self=this;this.departure_timers[room_jid][user_jid]=setTimeout(function(){chat.remove_last_presence(room_jid,user_jid);chat.add_chat_text(room_jid,msg,'info',{from:user_jid,type:'presence'});self.departure_timers[room_jid][user_jid]=0;},15000);},reconnect:function(){chat.show_reconnect_spinner();if(this.connection){hipchat.log('error','Removing existing connection');this.connection.connect_callback=null;if(this.connection.connected){this.connection.disconnect();}}
var self=this;var args={is_guest:config.is_guest,guest_key:config.guest_key,uid:config.user_id};var success_callback=function(data){if(data&&!data.error){clearTimeout(self.reconnect_timer);self.reconnect_timer=null;config=data;self.clear_data();self.setup_connection();self.connect();}else if(data&&data.error){clearTimeout(self.reconnect_timer);self.reconnect_timer=null;var msg='HipChat was unable to reconnect to the server.\n'+'<a href="'+location.pathname+'">Click here to refresh the page</a>.';chat.show_flash(msg,0);if(data.refresh_page==true){window.location.reload();}}};var error_callback=function(jqXHR,textStatus,errorThrown){hipchat.log('error','Error trying to reconnect. Status: '+textStatus+' -- error: '+errorThrown);chat.hide_reconnect_spinner();};$.ajax({url:'/chat/session',dataType:'json',data:args,success:success_callback,error:error_callback});},refresh_reconnect_timer:function(){hipchat.log('info','Reconnecting...');this.reconnect();var delay=(10+Math.random()*20)*1000;this.reconnect_timer=setTimeout($.proxy(this,'refresh_reconnect_timer'),delay);},remove_from_auto_join:function(jid){var auto_join=util.prefs.get_pref('autoJoin',[]);for(var i in auto_join){if(auto_join[i].jid==jid){auto_join.splice(i,1);util.prefs.set_pref('autoJoin',auto_join,true);return true;}}
return false;},remove_room_occupant:function(room_jid,user_jid){var roster=this.room_rosters[room_jid];for(var i=0;i<roster.length;i++){if(roster[i].jid==user_jid){roster.splice(i,1);return true;}}
return false;},remove_user_info:function(user_jid){var bare_jid=util.jid.bare_jid(user_jid);for(var i=0;i<this.roster.length;i++){var member=this.roster[i];if(util.jid.bare_jid(member.jid)==bare_jid){this.roster.splice(i,1);return true;}}
return false;},rename_room:function(room_jid,new_name){var iq=$iq({type:'set',to:room_jid}).c('query',{xmlns:'http://hipchat.com'}).c('rename').t(new_name);this.connection.sendIQ(iq.tree(),function(data){if(data&&data.error){alert('There was a problem renaming the room. Please try again later.');}else{chat.show_flash('Room renamed.');app.discover_rooms();}},$.proxy(this,'handle_iq_err'));},request_addlive_credentials:function(jid){var self=this;var stanza=$iq({type:'get',to:jid}).c('query',{xmlns:'http://hipchat.com/protocol/addlive'});var dfd=$.Deferred();function iq2json(iq){var json={};$('query *, error *',iq).each(function(){json[this.nodeName]=$(this).text();});return json;}
function done(iqCreds){dfd.resolve(iq2json(iqCreds));}
function fail(iqErr){dfd.resolve(iq2json(iqErr));}
self.connection.sendIQ(stanza.tree(),done,fail);return dfd.promise();},request_history:function(jid,count,before,callback){jid=util.jid.bare_jid(jid);var query_args={xmlns:'http://hipchat.com/protocol/history'};query_args.type=(util.jid.is_room(jid)?'groupchat':'chat');if(typeof count=='undefined'||!count){count=this.HISTORY_STANZAS_TO_REQUEST;}
query_args.maxstanzas=count;var is_previous_history=false;if(typeof before!='undefined'&&before){is_previous_history=true;query_args.before=dateFormat(before,"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'");}
var history=$iq({type:'get',to:jid}).c('query',query_args);var self=this;this.connection.sendIQ(history.tree(),function(iq){self.chat_is_loading[jid]=false;chat.on_history_done(jid,is_previous_history);if(typeof callback=='function'){callback(iq);}},function(iq){self.chat_is_loading[jid]=false;self.handle_history_error(iq,jid);chat.on_history_done(jid,is_previous_history);if(typeof callback=='function'){callback(iq);}});this.chat_is_loading[jid]=true;},room_exists:function(room_jid){var room_data=this.get_room_data(room_jid);if(room_data){return true;}
return false;},save_room_data:function(room_jid,privacy,members,send_invites){var args={jid:room_jid,privacy:privacy,members:members.join(','),send_invites:(send_invites?'1':'0')};var self=this;this.make_api_request('manage_room',args,function(){if(privacy=='public'){var roster=self.room_rosters[room_jid];for(var i=0;i<roster.length;i++){if(roster[i].type=='unavailable'){self.remove_room_occupant(room_jid,roster[i].jid);i--;}}
chat.update_roster(room_jid);}
self.set_room_data(room_jid,'privacy',privacy);chat.update_nav(room_jid);chat.show_flash('Saved room permissions.');},true);},send_announcement:function(message){if(!this.is_connected){return false;}
var attrs={to:config.chat_server,type:'headline',from:this.current_user_jid};var xml=$msg(attrs).c('body').t(message).tree();this.connection.send(xml);return xml;},send_chat_state_message:function(to_jid,state){if(!this.is_connected){return false;}
var is_room=util.jid.is_room(to_jid);var msg_type=(is_room?'groupchat':'chat');var attrs={to:to_jid,type:msg_type};var node=$msg(attrs).c(state,{xmlns:'http://jabber.org/protocol/chatstates'}).up();this.connection.send(node.tree());return true;},send_file_upload_message:function(to_jid,file_id){if(!this.is_connected){return false;}
var is_room=util.jid.is_room(to_jid);var msg_type=(is_room?'groupchat':'chat');var attrs={to:to_jid,type:msg_type};var msg=$msg(attrs).c('x',{xmlns:'http://hipchat.com/protocol/muc#room'}).c('file',{'id':file_id}).up().up();if(!is_room){msg.c('x',{xmlns:'http://hipchat.com'}).c('echo').up().up();}
var xml=msg.tree();this.connection.send(xml);return xml;},send_guest_iq:function(room_jid,enabled){var guest_iq=$iq({type:'set',to:room_jid}).c('query',{xmlns:'http://hipchat.com'}).c('guest_access').t((enabled?'1':'0'));var self=this;this.connection.sendIQ(guest_iq.tree(),null,function(iq){chat.on_guest_access_error(iq);});},send_invites:function(jids){},send_message:function(msg,to_jid,args){if(!this.is_connected){return false;}
var is_room=util.jid.is_room(to_jid);var msg_type=(is_room?'groupchat':'chat');var attrs={to:to_jid,type:msg_type};if(args.message_id){attrs['id']=args.message_id;}
var node=$msg(attrs).c('body').t(msg).up();node.c(chat.INACTIVE_STATE,{xmlns:'http://jabber.org/protocol/chatstates'}).up();if(!is_room){attrs.from=this.current_user_jid;node.c('x',{xmlns:'http://hipchat.com'}).c('echo').up().up();}
var xml=node.tree();this.connection.send(xml);return xml;},send_raw_message:function(message){if(!this.is_connected){return false;}
try{var $xml=$($.parseXML('<x>'+message+'</x>'));var elem=$xml.find('x').children()[0];this.connection.send(elem);}catch(err){hipchat.log('error','Invalid XML: '+message);}
return true;},send_video_message:function(to_jid,args){if(!this.is_connected){return false;}
var is_room=util.jid.is_room(to_jid);var msg_type=(is_room?'groupchat':'chat');var attrs={to:to_jid,type:msg_type};if(args.message_id){attrs.id=args.message_id;}
attrs.from=this.current_user_jid;var node=$msg(attrs).c('x',{xmlns:'http://hipchat.com/protocol/addlive'});if(args.type==='join'){vtype=(chat.video_session&&chat.video_session.type)||'call';node.c(vtype);}else if(args.type==='decline'){node.c('decline');}else if(args.type==='hangup'){node.c('hangup');}
else{hipchat.log('ERROR','Unknown video message type: '+args.type);return false;}
node.up();var xml=node.tree();this.connection.send(xml);return xml;},cancel_delayed_video_message:function(message_id){var self=this;var messages=self.delayed_video_messages=self.delayed_video_messages||{};var message=messages[message_id]
if(message){message.cancel();return true;}
return false;},send_delayed_video_message:function(to_jid,args){var self=this;var messages=self.delayed_video_messages=self.delayed_video_messages||{};var message_id='msg-'+args.message_id;messages[message_id]={cancel:function(){delete messages[message_id];clearTimeout(this.timeout);},timeout:setTimeout(function(){delete messages[message_id];self.send_video_message(to_jid,args);},args.timeout||5000)};return message_id;},set_auto_join_name:function(jid,name){var auto_join=util.prefs.get_pref('autoJoin',[]);for(var i in auto_join){if(auto_join[i].jid==jid){auto_join[i].name=name;}}
util.prefs.set_pref('autoJoin',auto_join);return true;},set_display_name:function(jid,name,chat_display_name,force_update){if(typeof force_update=='undefined'){force_update=false;}
if(!force_update&&this.display_names[jid]){return;}
var display_name_data={jid:jid,name:name,display_name:name};if(typeof chat_display_name!='undefined'&&chat_display_name){display_name_data['abbreviated_name']=chat_display_name;}else{display_name_data['abbreviated_name']=helpers.get_abbreviated_name(name);}
this.display_names[util.jid.bare_jid(jid)]=display_name_data;},set_presence:function(type,show,status,idle,send_caps){hipchat.log('info','Setting presence: '+type+' - '+show+' - '+idle);this.previous_presence=this.current_presence;this.current_presence={type:type,show:show,status:status};var pres=$pres({type:type,from:this.current_user_jid});if(show){pres.c('show').t(show).up();}
if(typeof status=='string'){pres.c('status').t(status).up();}
if(idle){pres.c('query',{xmlns:'jabber:iq:last',seconds:idle}).up();}
if(send_caps){pres.c('c',{xmlns:'http://jabber.org/protocol/caps',node:'http://hipchat.com/client/web/'+helpers.get_browser_name(),ver:$.browser.version}).up();}
this.connection.send(pres.tree());this.handle_user_presence($(pres.tree()));},set_room_archived:function(room_jid,state){var iq=$iq({type:'set',to:room_jid}).c('query',{xmlns:'http://hipchat.com'}).c('is_archived').t(state?'1':'0');this.connection.sendIQ(iq.tree(),function(data){var action;if(data&&data.error){action=state?'archiving':'unarchiving';alert('There was a problem '+action+' the room. Please try again later.');}else{action=state?'archived':'unarchived';chat.show_flash('Room successfully '+action+'.');app.discover_rooms();}},$.proxy(this,'handle_iq_err'));},set_room_data:function(room_jid,key,value){for(var i in this.room_list){var room=this.room_list[i];if(room.jid==room_jid){room[key]=value;}}},set_topic:function(topic,room_jid){if(!this.is_connected){return false;}
var attrs={to:room_jid,type:'groupchat'};this.connection.send($msg(attrs).c('subject').t(topic).tree());return true;},setup_connection:function(){hipchat.log('info','Creating connection to '+config.bind_url);this.connection=new Strophe.Connection(config.bind_url);},setup_idle_events:function(){$(document).on('mousemove.idle keydown.idle DOMMouseScroll.idle mousewheel.idle mousedown.idle',$.proxy(this,'handle_user_action'));this.idle_timeout=setTimeout($.proxy(this,'on_user_idle'),this.IDLE_DELAY_MS);},setup_room_vars:function(room_jid,room_name){this.room_rosters[room_jid]=[];this.room_loaded[room_jid]=false;this.room_history_loaded[room_jid]=false;this.chat_is_loading[room_jid]=true;this.departure_timers[room_jid]={};},update_idle_times:function(){for(var room_jid in this.room_rosters){var roster=this.room_rosters[room_jid];for(var i in roster){if(roster[i].idle>0){roster[i].idle+=60;chat.update_roster_member(room_jid,roster[i]);}}}
for(var j in this.roster){var member=this.roster[j];if(member.idle>0){member.idle+=60;chat.update_roster_member(this.lobby_jid,member);}}},update_mention_regex:function(jid){jid=util.jid.bare_jid(jid);var is_private_room=this.is_private_room(jid);var is_private_chat=util.jid.is_private_chat(jid);if(!jid||typeof jid=='undefined'||!is_private_room){jid="all";}
if(is_private_chat){var user_info=this.get_user_info(jid);var mention_name=(user_info.mention_name?user_info.mention_name:helpers.get_default_mention_name(user_info.name));this.mention_regexes[jid]=new RegExp("(?=[^\\w>]|^)@("+mention_name+")(?=[^\\w<]|$)","gi");}else{var users=(is_private_room?this.room_rosters[jid]:this.roster);var mention_names=[];for(var uidx=0;uidx<users.length;uidx++){var user=users[uidx];mention_names.push(user.mention_name?user.mention_name:helpers.get_default_mention_name(user.name));}
for(var gidx=0;gidx<this.guest_list.length;gidx++){var guest=this.guest_list[gidx];mention_names.push(guest.mention_name?guest.mention_name:helpers.get_default_mention_name(guest.name));}
this.mention_regexes[jid]=new RegExp("(?=[^\\w>]|^)@("+mention_names.join('|')+")(?=[^\\w<]|$)","gi");}},update_room_occupant:function(occupant,pres,item,room_jid,user_jid,nickname){var old_type=occupant.type;var member_info=this.get_user_info(user_jid,true);var mobile=(util.jid.resource(user_jid)=='iphone'?'iphone':false);if(pres.find('mobile').length>0){mobile=pres.find('mobile').attr('type')||'sms';}
occupant.affiliation=item.attr('affiliation');occupant.name=nickname;occupant.jid=user_jid;occupant.role=item.attr('role');occupant.status=helpers.escape(member_info.status);occupant.mobile=mobile;occupant.show=pres.find('show:first').text();occupant.type=pres.attr('type')||'available';occupant.idle=helpers.get_idle_seconds(pres);if(this.room_loaded[room_jid]){if(pres.attr('type')==this.PRESENCE_TYPE_UNAVAILABLE){var msg=nickname+' left the room.';var reason=this.get_reason_for_departure(status);if(reason)msg+=" ("+reason+")";this.queue_departure(room_jid,user_jid,msg);if(!this.is_private_room(room_jid)){this.remove_room_occupant(room_jid,user_jid);chat.update_roster(room_jid);}else{chat.update_roster_member(room_jid,occupant);}}else{if(old_type=='unavailable'&&occupant.type=='available'){if(this.departure_timers[room_jid]&&this.departure_timers[room_jid][user_jid]){clearTimeout(this.departure_timers[room_jid][user_jid]);}else if(this.room_history_loaded[room_jid]){if(!util.prefs.get_bool_pref('hidePresenceMessages')){chat.remove_last_presence(room_jid,user_jid);chat.add_chat_text(room_jid,nickname+' joined the room.','info',{from:user_jid,type:'presence'});}}}
chat.update_roster_member(room_jid,occupant);}}},update_room_with_extension:function(room_jid,hc_node){var room_data=this.get_room_data(room_jid);var save_room_data=false;if(!room_data){room_data={jid:room_jid,name:''};save_room_data=true;}
var name=hc_node.find('name:first').text();if(name){room_data.name=name;this.set_display_name(room_jid,name);chat.update_nav_text(room_jid,name);this.set_auto_join_name(room_jid,name);}
var topic=hc_node.find('topic:first').text();if(topic){if(room_jid==this.current_jid){chat.show_topic(topic);}
room_data.topic=topic;}
var privacy=hc_node.find('privacy:first').text();if(privacy){room_data.privacy=privacy;}
if(save_room_data){this.room_list.push(room_data);this.room_list=this.room_list.sort(helpers.sort_rooms);}}};;var Base64=(function(){var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var obj={encode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;do{chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=((chr1&3)<<4)|(chr2>>4);enc3=((chr2&15)<<2)|(chr3>>6);enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64;}else if(isNaN(chr3)){enc4=64;}
output=output+keyStr.charAt(enc1)+keyStr.charAt(enc2)+
keyStr.charAt(enc3)+keyStr.charAt(enc4);}while(i<input.length);return output;},decode:function(input){var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{enc1=keyStr.indexOf(input.charAt(i++));enc2=keyStr.indexOf(input.charAt(i++));enc3=keyStr.indexOf(input.charAt(i++));enc4=keyStr.indexOf(input.charAt(i++));chr1=(enc1<<2)|(enc2>>4);chr2=((enc2&15)<<4)|(enc3>>2);chr3=((enc3&3)<<6)|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2);}
if(enc4!=64){output=output+String.fromCharCode(chr3);}}while(i<input.length);return output;}};return obj;})();var hexcase=0;var b64pad="=";var chrsz=8;function hex_sha1(s){return binb2hex(core_sha1(str2binb(s),s.length*chrsz));}
function b64_sha1(s){return binb2b64(core_sha1(str2binb(s),s.length*chrsz));}
function str_sha1(s){return binb2str(core_sha1(str2binb(s),s.length*chrsz));}
function hex_hmac_sha1(key,data){return binb2hex(core_hmac_sha1(key,data));}
function b64_hmac_sha1(key,data){return binb2b64(core_hmac_sha1(key,data));}
function str_hmac_sha1(key,data){return binb2str(core_hmac_sha1(key,data));}
function sha1_vm_test()
{return hex_sha1("abc")=="a9993e364706816aba3e25717850c26c9cd0d89d";}
function core_sha1(x,len)
{x[len>>5]|=0x80<<(24-len%32);x[((len+64>>9)<<4)+15]=len;var w=new Array(80);var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;var e=-1009589776;var i,j,t,olda,oldb,oldc,oldd,olde;for(i=0;i<x.length;i+=16)
{olda=a;oldb=b;oldc=c;oldd=d;olde=e;for(j=0;j<80;j++)
{if(j<16){w[j]=x[i+j];}
else{w[j]=rol(w[j-3]^w[j-8]^w[j-14]^w[j-16],1);}
t=safe_add(safe_add(rol(a,5),sha1_ft(j,b,c,d)),safe_add(safe_add(e,w[j]),sha1_kt(j)));e=d;d=c;c=rol(b,30);b=a;a=t;}
a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd);e=safe_add(e,olde);}
return[a,b,c,d,e];}
function sha1_ft(t,b,c,d)
{if(t<20){return(b&c)|((~b)&d);}
if(t<40){return b^c^d;}
if(t<60){return(b&c)|(b&d)|(c&d);}
return b^c^d;}
function sha1_kt(t)
{return(t<20)?1518500249:(t<40)?1859775393:(t<60)?-1894007588:-899497514;}
function core_hmac_sha1(key,data)
{var bkey=str2binb(key);if(bkey.length>16){bkey=core_sha1(bkey,key.length*chrsz);}
var ipad=new Array(16),opad=new Array(16);for(var i=0;i<16;i++)
{ipad[i]=bkey[i]^0x36363636;opad[i]=bkey[i]^0x5C5C5C5C;}
var hash=core_sha1(ipad.concat(str2binb(data)),512+data.length*chrsz);return core_sha1(opad.concat(hash),512+160);}
function safe_add(x,y)
{var lsw=(x&0xFFFF)+(y&0xFFFF);var msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&0xFFFF);}
function rol(num,cnt)
{return(num<<cnt)|(num>>>(32-cnt));}
function str2binb(str)
{var bin=[];var mask=(1<<chrsz)-1;for(var i=0;i<str.length*chrsz;i+=chrsz)
{bin[i>>5]|=(str.charCodeAt(i/chrsz)&mask)<<(32-chrsz-i%32);}
return bin;}
function binb2str(bin)
{var str="";var mask=(1<<chrsz)-1;for(var i=0;i<bin.length*32;i+=chrsz)
{str+=String.fromCharCode((bin[i>>5]>>>(32-chrsz-i%32))&mask);}
return str;}
function binb2hex(binarray)
{var hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef";var str="";for(var i=0;i<binarray.length*4;i++)
{str+=hex_tab.charAt((binarray[i>>2]>>((3-i%4)*8+4))&0xF)+
hex_tab.charAt((binarray[i>>2]>>((3-i%4)*8))&0xF);}
return str;}
function binb2b64(binarray)
{var tab="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var str="";var triplet,j;for(var i=0;i<binarray.length*4;i+=3)
{triplet=(((binarray[i>>2]>>8*(3-i%4))&0xFF)<<16)|(((binarray[i+1>>2]>>8*(3-(i+1)%4))&0xFF)<<8)|((binarray[i+2>>2]>>8*(3-(i+2)%4))&0xFF);for(j=0;j<4;j++)
{if(i*8+j*6>binarray.length*32){str+=b64pad;}
else{str+=tab.charAt((triplet>>6*(3-j))&0x3F);}}}
return str;}
var MD5=(function(){var hexcase=0;var b64pad="";var chrsz=8;var safe_add=function(x,y){var lsw=(x&0xFFFF)+(y&0xFFFF);var msw=(x>>16)+(y>>16)+(lsw>>16);return(msw<<16)|(lsw&0xFFFF);};var bit_rol=function(num,cnt){return(num<<cnt)|(num>>>(32-cnt));};var str2binl=function(str){var bin=[];var mask=(1<<chrsz)-1;for(var i=0;i<str.length*chrsz;i+=chrsz)
{bin[i>>5]|=(str.charCodeAt(i/chrsz)&mask)<<(i%32);}
return bin;};var binl2str=function(bin){var str="";var mask=(1<<chrsz)-1;for(var i=0;i<bin.length*32;i+=chrsz)
{str+=String.fromCharCode((bin[i>>5]>>>(i%32))&mask);}
return str;};var binl2hex=function(binarray){var hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef";var str="";for(var i=0;i<binarray.length*4;i++)
{str+=hex_tab.charAt((binarray[i>>2]>>((i%4)*8+4))&0xF)+
hex_tab.charAt((binarray[i>>2]>>((i%4)*8))&0xF);}
return str;};var binl2b64=function(binarray){var tab="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var str="";var triplet,j;for(var i=0;i<binarray.length*4;i+=3)
{triplet=(((binarray[i>>2]>>8*(i%4))&0xFF)<<16)|(((binarray[i+1>>2]>>8*((i+1)%4))&0xFF)<<8)|((binarray[i+2>>2]>>8*((i+2)%4))&0xFF);for(j=0;j<4;j++)
{if(i*8+j*6>binarray.length*32){str+=b64pad;}
else{str+=tab.charAt((triplet>>6*(3-j))&0x3F);}}}
return str;};var md5_cmn=function(q,a,b,x,s,t){return safe_add(bit_rol(safe_add(safe_add(a,q),safe_add(x,t)),s),b);};var md5_ff=function(a,b,c,d,x,s,t){return md5_cmn((b&c)|((~b)&d),a,b,x,s,t);};var md5_gg=function(a,b,c,d,x,s,t){return md5_cmn((b&d)|(c&(~d)),a,b,x,s,t);};var md5_hh=function(a,b,c,d,x,s,t){return md5_cmn(b^c^d,a,b,x,s,t);};var md5_ii=function(a,b,c,d,x,s,t){return md5_cmn(c^(b|(~d)),a,b,x,s,t);};var core_md5=function(x,len){x[len>>5]|=0x80<<((len)%32);x[(((len+64)>>>9)<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;var olda,oldb,oldc,oldd;for(var i=0;i<x.length;i+=16)
{olda=a;oldb=b;oldc=c;oldd=d;a=md5_ff(a,b,c,d,x[i+0],7,-680876936);d=md5_ff(d,a,b,c,x[i+1],12,-389564586);c=md5_ff(c,d,a,b,x[i+2],17,606105819);b=md5_ff(b,c,d,a,x[i+3],22,-1044525330);a=md5_ff(a,b,c,d,x[i+4],7,-176418897);d=md5_ff(d,a,b,c,x[i+5],12,1200080426);c=md5_ff(c,d,a,b,x[i+6],17,-1473231341);b=md5_ff(b,c,d,a,x[i+7],22,-45705983);a=md5_ff(a,b,c,d,x[i+8],7,1770035416);d=md5_ff(d,a,b,c,x[i+9],12,-1958414417);c=md5_ff(c,d,a,b,x[i+10],17,-42063);b=md5_ff(b,c,d,a,x[i+11],22,-1990404162);a=md5_ff(a,b,c,d,x[i+12],7,1804603682);d=md5_ff(d,a,b,c,x[i+13],12,-40341101);c=md5_ff(c,d,a,b,x[i+14],17,-1502002290);b=md5_ff(b,c,d,a,x[i+15],22,1236535329);a=md5_gg(a,b,c,d,x[i+1],5,-165796510);d=md5_gg(d,a,b,c,x[i+6],9,-1069501632);c=md5_gg(c,d,a,b,x[i+11],14,643717713);b=md5_gg(b,c,d,a,x[i+0],20,-373897302);a=md5_gg(a,b,c,d,x[i+5],5,-701558691);d=md5_gg(d,a,b,c,x[i+10],9,38016083);c=md5_gg(c,d,a,b,x[i+15],14,-660478335);b=md5_gg(b,c,d,a,x[i+4],20,-405537848);a=md5_gg(a,b,c,d,x[i+9],5,568446438);d=md5_gg(d,a,b,c,x[i+14],9,-1019803690);c=md5_gg(c,d,a,b,x[i+3],14,-187363961);b=md5_gg(b,c,d,a,x[i+8],20,1163531501);a=md5_gg(a,b,c,d,x[i+13],5,-1444681467);d=md5_gg(d,a,b,c,x[i+2],9,-51403784);c=md5_gg(c,d,a,b,x[i+7],14,1735328473);b=md5_gg(b,c,d,a,x[i+12],20,-1926607734);a=md5_hh(a,b,c,d,x[i+5],4,-378558);d=md5_hh(d,a,b,c,x[i+8],11,-2022574463);c=md5_hh(c,d,a,b,x[i+11],16,1839030562);b=md5_hh(b,c,d,a,x[i+14],23,-35309556);a=md5_hh(a,b,c,d,x[i+1],4,-1530992060);d=md5_hh(d,a,b,c,x[i+4],11,1272893353);c=md5_hh(c,d,a,b,x[i+7],16,-155497632);b=md5_hh(b,c,d,a,x[i+10],23,-1094730640);a=md5_hh(a,b,c,d,x[i+13],4,681279174);d=md5_hh(d,a,b,c,x[i+0],11,-358537222);c=md5_hh(c,d,a,b,x[i+3],16,-722521979);b=md5_hh(b,c,d,a,x[i+6],23,76029189);a=md5_hh(a,b,c,d,x[i+9],4,-640364487);d=md5_hh(d,a,b,c,x[i+12],11,-421815835);c=md5_hh(c,d,a,b,x[i+15],16,530742520);b=md5_hh(b,c,d,a,x[i+2],23,-995338651);a=md5_ii(a,b,c,d,x[i+0],6,-198630844);d=md5_ii(d,a,b,c,x[i+7],10,1126891415);c=md5_ii(c,d,a,b,x[i+14],15,-1416354905);b=md5_ii(b,c,d,a,x[i+5],21,-57434055);a=md5_ii(a,b,c,d,x[i+12],6,1700485571);d=md5_ii(d,a,b,c,x[i+3],10,-1894986606);c=md5_ii(c,d,a,b,x[i+10],15,-1051523);b=md5_ii(b,c,d,a,x[i+1],21,-2054922799);a=md5_ii(a,b,c,d,x[i+8],6,1873313359);d=md5_ii(d,a,b,c,x[i+15],10,-30611744);c=md5_ii(c,d,a,b,x[i+6],15,-1560198380);b=md5_ii(b,c,d,a,x[i+13],21,1309151649);a=md5_ii(a,b,c,d,x[i+4],6,-145523070);d=md5_ii(d,a,b,c,x[i+11],10,-1120210379);c=md5_ii(c,d,a,b,x[i+2],15,718787259);b=md5_ii(b,c,d,a,x[i+9],21,-343485551);a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd);}
return[a,b,c,d];};var core_hmac_md5=function(key,data){var bkey=str2binl(key);if(bkey.length>16){bkey=core_md5(bkey,key.length*chrsz);}
var ipad=new Array(16),opad=new Array(16);for(var i=0;i<16;i++)
{ipad[i]=bkey[i]^0x36363636;opad[i]=bkey[i]^0x5C5C5C5C;}
var hash=core_md5(ipad.concat(str2binl(data)),512+data.length*chrsz);return core_md5(opad.concat(hash),512+128);};var obj={hexdigest:function(s){return binl2hex(core_md5(str2binl(s),s.length*chrsz));},b64digest:function(s){return binl2b64(core_md5(str2binl(s),s.length*chrsz));},hash:function(s){return binl2str(core_md5(str2binl(s),s.length*chrsz));},hmac_hexdigest:function(key,data){return binl2hex(core_hmac_md5(key,data));},hmac_b64digest:function(key,data){return binl2b64(core_hmac_md5(key,data));},hmac_hash:function(key,data){return binl2str(core_hmac_md5(key,data));},test:function(){return MD5.hexdigest("abc")==="900150983cd24fb0d6963f7d28e17f72";}};return obj;})();if(!Function.prototype.bind){Function.prototype.bind=function(obj)
{var func=this;var _slice=Array.prototype.slice;var _concat=Array.prototype.concat;var _args=_slice.call(arguments,1);return function(){return func.apply(obj?obj:this,_concat.call(_args,_slice.call(arguments,0)));};};}
if(!Array.prototype.indexOf)
{Array.prototype.indexOf=function(elt)
{var len=this.length;var from=Number(arguments[1])||0;from=(from<0)?Math.ceil(from):Math.floor(from);if(from<0){from+=len;}
for(;from<len;from++){if(from in this&&this[from]===elt){return from;}}
return-1;};}
(function(callback){var Strophe;function $build(name,attrs){return new Strophe.Builder(name,attrs);}
function $msg(attrs){return new Strophe.Builder("message",attrs);}
function $iq(attrs){return new Strophe.Builder("iq",attrs);}
function $pres(attrs){return new Strophe.Builder("presence",attrs);}
Strophe={VERSION:"8e14efd",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:['a','blockquote','br','cite','em','img','li','ol','p','span','strong','ul','body'],attributes:{'a':['href'],'blockquote':['style'],'br':[],'cite':['style'],'em':[],'img':['src','alt','style','height','width'],'li':['style'],'ol':['style'],'p':['style'],'span':['style'],'strong':[],'ul':['style'],'body':[]},css:['background-color','color','font-family','font-size','font-style','font-weight','margin-left','margin-right','text-align','text-decoration'],validTag:function(tag)
{for(var i=0;i<Strophe.XHTML.tags.length;i++){if(tag==Strophe.XHTML.tags[i]){return true;}}
return false;},validAttribute:function(tag,attribute)
{if(typeof Strophe.XHTML.attributes[tag]!=='undefined'&&Strophe.XHTML.attributes[tag].length>0){for(var i=0;i<Strophe.XHTML.attributes[tag].length;i++){if(attribute==Strophe.XHTML.attributes[tag][i]){return true;}}}
return false;},validCSS:function(style)
{for(var i=0;i<Strophe.XHTML.css.length;i++){if(style==Strophe.XHTML.css[i]){return true;}}
return false;}},addNamespace:function(name,value)
{Strophe.NS[name]=value;},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,forEachChild:function(elem,elemName,func)
{var i,childNode;for(i=0;i<elem.childNodes.length;i++){childNode=elem.childNodes[i];if(childNode.nodeType==Strophe.ElementType.NORMAL&&(!elemName||this.isTagEqual(childNode,elemName))){func(childNode);}}},isTagEqual:function(el,name)
{return el.tagName.toLowerCase()==name.toLowerCase();},_xmlGenerator:null,_makeGenerator:function(){var doc;if(document.implementation.createDocument===undefined||document.implementation.createDocument&&document.documentMode&&document.documentMode<10){doc=this._getIEXmlDom();doc.appendChild(doc.createElement('strophe'));}else{doc=document.implementation.createDocument('jabber:client','strophe',null);}
return doc;},xmlGenerator:function(){if(!Strophe._xmlGenerator){Strophe._xmlGenerator=Strophe._makeGenerator();}
return Strophe._xmlGenerator;},_getIEXmlDom:function(){var doc=null;var docStrings=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"];for(var d=0;d<docStrings.length;d++){if(doc===null){try{doc=new ActiveXObject(docStrings[d]);}catch(e){doc=null;}}else{break;}}
return doc;},xmlElement:function(name)
{if(!name){return null;}
var node=Strophe.xmlGenerator().createElement(name);var a,i,k;for(a=1;a<arguments.length;a++){if(!arguments[a]){continue;}
if(typeof(arguments[a])=="string"||typeof(arguments[a])=="number"){node.appendChild(Strophe.xmlTextNode(arguments[a]));}else if(typeof(arguments[a])=="object"&&typeof(arguments[a].sort)=="function"){for(i=0;i<arguments[a].length;i++){if(typeof(arguments[a][i])=="object"&&typeof(arguments[a][i].sort)=="function"){node.setAttribute(arguments[a][i][0],arguments[a][i][1]);}}}else if(typeof(arguments[a])=="object"){for(k in arguments[a]){if(arguments[a].hasOwnProperty(k)){node.setAttribute(k,arguments[a][k]);}}}}
return node;},xmlescape:function(text)
{text=text.replace(/\&/g,"&amp;");text=text.replace(/</g,"&lt;");text=text.replace(/>/g,"&gt;");text=text.replace(/'/g,"&apos;");text=text.replace(/"/g,"&quot;");return text;},xmlTextNode:function(text)
{return Strophe.xmlGenerator().createTextNode(text);},xmlHtmlNode:function(html)
{if(window.DOMParser){parser=new DOMParser();node=parser.parseFromString(html,"text/xml");}else{node=new ActiveXObject("Microsoft.XMLDOM");node.async="false";node.loadXML(html);}
return node;},getText:function(elem)
{if(!elem){return null;}
var str="";if(elem.childNodes.length===0&&elem.nodeType==Strophe.ElementType.TEXT){str+=elem.nodeValue;}
for(var i=0;i<elem.childNodes.length;i++){if(elem.childNodes[i].nodeType==Strophe.ElementType.TEXT){str+=elem.childNodes[i].nodeValue;}}
return Strophe.xmlescape(str);},copyElement:function(elem)
{var i,el;if(elem.nodeType==Strophe.ElementType.NORMAL){el=Strophe.xmlElement(elem.tagName);for(i=0;i<elem.attributes.length;i++){el.setAttribute(elem.attributes[i].nodeName.toLowerCase(),elem.attributes[i].value);}
for(i=0;i<elem.childNodes.length;i++){el.appendChild(Strophe.copyElement(elem.childNodes[i]));}}else if(elem.nodeType==Strophe.ElementType.TEXT){el=Strophe.xmlGenerator().createTextNode(elem.nodeValue);}
return el;},createHtml:function(elem)
{var i,el,j,tag,attribute,value,css,cssAttrs,attr,cssName,cssValue,children,child;if(elem.nodeType==Strophe.ElementType.NORMAL){tag=elem.nodeName.toLowerCase();if(Strophe.XHTML.validTag(tag)){try{el=Strophe.xmlElement(tag);for(i=0;i<Strophe.XHTML.attributes[tag].length;i++){attribute=Strophe.XHTML.attributes[tag][i];value=elem.getAttribute(attribute);if(typeof value=='undefined'||value===null||value===''||value===false||value===0){continue;}
if(attribute=='style'&&typeof value=='object'){if(typeof value.cssText!='undefined'){value=value.cssText;}}
if(attribute=='style'){css=[];cssAttrs=value.split(';');for(j=0;j<cssAttrs.length;j++){attr=cssAttrs[j].split(':');cssName=attr[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(Strophe.XHTML.validCSS(cssName)){cssValue=attr[1].replace(/^\s*/,"").replace(/\s*$/,"");css.push(cssName+': '+cssValue);}}
if(css.length>0){value=css.join('; ');el.setAttribute(attribute,value);}}else{el.setAttribute(attribute,value);}}
for(i=0;i<elem.childNodes.length;i++){el.appendChild(Strophe.createHtml(elem.childNodes[i]));}}catch(e){el=Strophe.xmlTextNode('');}}else{el=Strophe.xmlGenerator().createDocumentFragment();for(i=0;i<elem.childNodes.length;i++){el.appendChild(Strophe.createHtml(elem.childNodes[i]));}}}else if(elem.nodeType==Strophe.ElementType.FRAGMENT){el=Strophe.xmlGenerator().createDocumentFragment();for(i=0;i<elem.childNodes.length;i++){el.appendChild(Strophe.createHtml(elem.childNodes[i]));}}else if(elem.nodeType==Strophe.ElementType.TEXT){el=Strophe.xmlTextNode(elem.nodeValue);}
return el;},escapeNode:function(node)
{return node.replace(/^\s+|\s+$/g,'').replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40");},unescapeNode:function(node)
{return node.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\");},getNodeFromJid:function(jid)
{if(jid.indexOf("@")<0){return null;}
return jid.split("@")[0];},getDomainFromJid:function(jid)
{var bare=Strophe.getBareJidFromJid(jid);if(bare.indexOf("@")<0){return bare;}else{var parts=bare.split("@");parts.splice(0,1);return parts.join('@');}},getResourceFromJid:function(jid)
{var s=jid.split("/");if(s.length<2){return null;}
s.splice(0,1);return s.join('/');},getBareJidFromJid:function(jid)
{return jid?jid.split("/")[0]:null;},log:function(level,msg)
{return;},debug:function(msg)
{this.log(this.LogLevel.DEBUG,msg);},info:function(msg)
{this.log(this.LogLevel.INFO,msg);},warn:function(msg)
{this.log(this.LogLevel.WARN,msg);},error:function(msg)
{this.log(this.LogLevel.ERROR,msg);},fatal:function(msg)
{this.log(this.LogLevel.FATAL,msg);},serialize:function(elem)
{var result;if(!elem){return null;}
if(typeof(elem.tree)==="function"){elem=elem.tree();}
var nodeName=elem.nodeName;var i,child;if(elem.getAttribute("_realname")){nodeName=elem.getAttribute("_realname");}
result="<"+nodeName;for(i=0;i<elem.attributes.length;i++){if(elem.attributes[i].nodeName!="_realname"){result+=" "+elem.attributes[i].nodeName.toLowerCase()+"='"+elem.attributes[i].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/>/g,"&gt;").replace(/</g,"&lt;")+"'";}}
if(elem.childNodes.length>0){result+=">";for(i=0;i<elem.childNodes.length;i++){child=elem.childNodes[i];switch(child.nodeType){case Strophe.ElementType.NORMAL:result+=Strophe.serialize(child);break;case Strophe.ElementType.TEXT:result+=Strophe.xmlescape(child.nodeValue);break;case Strophe.ElementType.CDATA:result+="<![CDATA["+child.nodeValue+"]]>";}}
result+="</"+nodeName+">";}else{result+="/>";}
return result;},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(name,ptype)
{Strophe._connectionPlugins[name]=ptype;}};Strophe.Builder=function(name,attrs)
{if(name=="presence"||name=="message"||name=="iq"){if(attrs&&!attrs.xmlns){attrs.xmlns=Strophe.NS.CLIENT;}else if(!attrs){attrs={xmlns:Strophe.NS.CLIENT};}}
this.nodeTree=Strophe.xmlElement(name,attrs);this.node=this.nodeTree;};Strophe.Builder.prototype={tree:function()
{return this.nodeTree;},toString:function()
{return Strophe.serialize(this.nodeTree);},up:function()
{this.node=this.node.parentNode;return this;},attrs:function(moreattrs)
{for(var k in moreattrs){if(moreattrs.hasOwnProperty(k)){this.node.setAttribute(k,moreattrs[k]);}}
return this;},c:function(name,attrs,text)
{var child=Strophe.xmlElement(name,attrs,text);this.node.appendChild(child);if(!text){this.node=child;}
return this;},cnode:function(elem)
{var xmlGen=Strophe.xmlGenerator();try{var impNode=(xmlGen.importNode!==undefined);}
catch(e){var impNode=false;}
var newElem=impNode?xmlGen.importNode(elem,true):Strophe.copyElement(elem);this.node.appendChild(newElem);this.node=newElem;return this;},t:function(text)
{var child=Strophe.xmlTextNode(text);this.node.appendChild(child);return this;},h:function(html)
{var fragment=document.createElement('body');fragment.innerHTML=html;var xhtml=Strophe.createHtml(fragment);while(xhtml.childNodes.length>0){this.node.appendChild(xhtml.childNodes[0]);}
return this;}};Strophe.Handler=function(handler,ns,name,type,id,from,options)
{this.handler=handler;this.ns=ns;this.name=name;this.type=type;this.id=id;this.options=options||{matchBare:false};if(!this.options.matchBare){this.options.matchBare=false;}
if(this.options.matchBare){this.from=from?Strophe.getBareJidFromJid(from):null;}else{this.from=from;}
this.user=true;};Strophe.Handler.prototype={isMatch:function(elem)
{var nsMatch;var from=null;if(this.options.matchBare){from=Strophe.getBareJidFromJid(elem.getAttribute('from'));}else{from=elem.getAttribute('from');}
nsMatch=false;if(!this.ns){nsMatch=true;}else{var that=this;Strophe.forEachChild(elem,null,function(elem){if(elem.getAttribute("xmlns")==that.ns){nsMatch=true;}});nsMatch=nsMatch||elem.getAttribute("xmlns")==this.ns;}
if(nsMatch&&(!this.name||Strophe.isTagEqual(elem,this.name))&&(!this.type||elem.getAttribute("type")==this.type)&&(!this.id||elem.getAttribute("id")==this.id)&&(!this.from||from==this.from)){return true;}
return false;},run:function(elem)
{var result=null;try{result=this.handler(elem);}catch(e){if(e.sourceURL){Strophe.fatal("error: "+this.handler+" "+e.sourceURL+":"+
e.line+" - "+e.name+": "+e.message);}else if(e.fileName){if(typeof(console)!="undefined"){console.trace();console.error(this.handler," - error - ",e,e.message);}
Strophe.fatal("error: "+this.handler+" "+
e.fileName+":"+e.lineNumber+" - "+
e.name+": "+e.message);}else{Strophe.fatal("error: "+e.message+"\n"+e.stack);}
throw e;}
return result;},toString:function()
{return"{Handler: "+this.handler+"("+this.name+","+
this.id+","+this.ns+")}";}};Strophe.TimedHandler=function(period,handler)
{this.period=period;this.handler=handler;this.lastCalled=new Date().getTime();this.user=true;};Strophe.TimedHandler.prototype={run:function()
{this.lastCalled=new Date().getTime();return this.handler();},reset:function()
{this.lastCalled=new Date().getTime();},toString:function()
{return"{TimedHandler: "+this.handler+"("+this.period+")}";}};Strophe.Request=function(elem,func,rid,sends)
{this.id=++Strophe._requestId;this.xmlData=elem;this.data=Strophe.serialize(elem);this.origFunc=func;this.func=func;this.rid=rid;this.date=NaN;this.sends=sends||0;this.abort=false;this.dead=null;this.age=function(){if(!this.date){return 0;}
var now=new Date();return(now-this.date)/1000;};this.timeDead=function(){if(!this.dead){return 0;}
var now=new Date();return(now-this.dead)/1000;};this.xhr=this._newXHR();};Strophe.Request.prototype={getResponse:function()
{var node=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){node=this.xhr.responseXML.documentElement;if(node.tagName=="parsererror"){Strophe.error("invalid response received");Strophe.error("responseText: "+this.xhr.responseText);Strophe.error("responseXML: "+
Strophe.serialize(this.xhr.responseXML));throw"parsererror";}}else if(this.xhr.responseText){Strophe.error("invalid response received");Strophe.error("responseText: "+this.xhr.responseText);Strophe.error("responseXML: "+
Strophe.serialize(this.xhr.responseXML));}
return node;},_newXHR:function()
{var xhr=null;if(window.XMLHttpRequest){xhr=new XMLHttpRequest();if(xhr.overrideMimeType){xhr.overrideMimeType("text/xml");}}else if(window.ActiveXObject){xhr=new ActiveXObject("Microsoft.XMLHTTP");}
xhr.onreadystatechange=this.func.bind(null,this);return xhr;}};Strophe.Connection=function(service)
{this.service=service;this.jid="";this.domain=null;this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.streamId=null;this.features=null;this._sasl_data=[];this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this._idleTimeout=null;this._disconnectTimeout=null;this.do_authentication=true;this.authenticated=false;this.disconnecting=false;this.connected=false;this.errors=0;this.paused=false;this.hold=1;this.wait=60;this.window=5;this._data=[];this._requests=[];this._uniqueId=Math.round(Math.random()*10000);this._sasl_success_handler=null;this._sasl_failure_handler=null;this._sasl_challenge_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(var k in Strophe._connectionPlugins){if(Strophe._connectionPlugins.hasOwnProperty(k)){var ptype=Strophe._connectionPlugins[k];var F=function(){};F.prototype=ptype;this[k]=new F();this[k].init(this);}}};Strophe.Connection.prototype={reset:function()
{this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.streamId=null;this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this.authenticated=false;this.disconnecting=false;this.connected=false;this.errors=0;this._requests=[];this._uniqueId=Math.round(Math.random()*10000);},pause:function()
{this.paused=true;},resume:function()
{this.paused=false;},getUniqueId:function(suffix)
{if(typeof(suffix)=="string"||typeof(suffix)=="number"){return++this._uniqueId+":"+suffix;}else{return++this._uniqueId+"";}},connect:function(jid,pass,callback,wait,hold,route)
{this.jid=jid;this.pass=pass;this.connect_callback=callback;this.disconnecting=false;this.connected=false;this.authenticated=false;this.errors=0;this.wait=wait||this.wait;this.hold=hold||this.hold;this.domain=this.domain||Strophe.getDomainFromJid(this.jid);var body=this._buildBody().attrs({to:this.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":Strophe.NS.BOSH});if(route){body.attrs({route:route});}
this._changeConnectStatus(Strophe.Status.CONNECTING,null);var _connect_cb=this._connect_callback||this._connect_cb;this._connect_callback=null;this._requests.push(new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,_connect_cb.bind(this)),body.tree().getAttribute("rid")));this._throttledRequestHandler();},attach:function(jid,sid,rid,callback,wait,hold,wind)
{this.jid=jid;this.sid=sid;this.rid=rid;this.connect_callback=callback;this.domain=Strophe.getDomainFromJid(this.jid);this.authenticated=true;this.connected=true;this.wait=wait||this.wait;this.hold=hold||this.hold;this.window=wind||this.window;this._changeConnectStatus(Strophe.Status.ATTACHED,null);},xmlInput:function(elem)
{return;},xmlOutput:function(elem)
{return;},rawInput:function(data)
{return;},rawOutput:function(data)
{return;},send:function(elem)
{if(elem===null){return;}
if(typeof(elem.sort)==="function"){for(var i=0;i<elem.length;i++){this._queueData(elem[i]);}}else if(typeof(elem.tree)==="function"){this._queueData(elem.tree());}else{this._queueData(elem);}
this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100);},flush:function()
{clearTimeout(this._idleTimeout);this._onIdle();},sendIQ:function(elem,callback,errback,timeout){var timeoutHandler=null;var that=this;if(typeof(elem.tree)==="function"){elem=elem.tree();}
var id=elem.getAttribute('id');if(!id){id=this.getUniqueId("sendIQ");elem.setAttribute("id",id);}
var handler=this.addHandler(function(stanza){if(timeoutHandler){that.deleteTimedHandler(timeoutHandler);}
var iqtype=stanza.getAttribute('type');if(iqtype=='result'){if(callback){callback(stanza);}}else if(iqtype=='error'){if(errback){errback(stanza);}}else{throw{name:"StropheError",message:"Got bad IQ type of "+iqtype};}},null,'iq',null,id);if(timeout){timeoutHandler=this.addTimedHandler(timeout,function(){that.deleteHandler(handler);if(errback){errback(null);}
return false;});}
this.send(elem);return id;},_queueData:function(element){if(element===null||!element.tagName||!element.childNodes){throw{name:"StropheError",message:"Cannot queue non-DOMElement."};}
this._data.push(element);},_sendRestart:function()
{this._data.push("restart");this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100);},addTimedHandler:function(period,handler)
{var thand=new Strophe.TimedHandler(period,handler);this.addTimeds.push(thand);return thand;},deleteTimedHandler:function(handRef)
{this.removeTimeds.push(handRef);},addHandler:function(handler,ns,name,type,id,from,options)
{var hand=new Strophe.Handler(handler,ns,name,type,id,from,options);this.addHandlers.push(hand);return hand;},deleteHandler:function(handRef)
{this.removeHandlers.push(handRef);},disconnect:function(reason)
{this._changeConnectStatus(Strophe.Status.DISCONNECTING,reason);Strophe.info("Disconnect was called because: "+reason);if(this.connected){this._disconnectTimeout=this._addSysTimedHandler(3000,this._onDisconnectTimeout.bind(this));this._sendTerminate();}},_changeConnectStatus:function(status,condition)
{for(var k in Strophe._connectionPlugins){if(Strophe._connectionPlugins.hasOwnProperty(k)){var plugin=this[k];if(plugin.statusChanged){try{plugin.statusChanged(status,condition);}catch(err){Strophe.error(""+k+" plugin caused an exception "+"changing status: "+err);}}}}
if(this.connect_callback){try{this.connect_callback(status,condition);}catch(e){Strophe.error("User connection callback caused an "+"exception: "+e);}}},_buildBody:function()
{var bodyWrap=$build('body',{rid:this.rid++,xmlns:Strophe.NS.HTTPBIND});if(this.sid!==null){bodyWrap.attrs({sid:this.sid});}
return bodyWrap;},_removeRequest:function(req)
{Strophe.debug("removing request");var i;for(i=this._requests.length-1;i>=0;i--){if(req==this._requests[i]){this._requests.splice(i,1);}}
req.xhr.onreadystatechange=function(){};this._throttledRequestHandler();},_restartRequest:function(i)
{var req=this._requests[i];if(req.dead===null){req.dead=new Date();}
this._processRequest(i);},_processRequest:function(i)
{var req=this._requests[i];var reqStatus=-1;try{if(req.xhr.readyState==4){reqStatus=req.xhr.status;}}catch(e){Strophe.error("caught an error in _requests["+i+"], reqStatus: "+reqStatus);}
if(typeof(reqStatus)=="undefined"){reqStatus=-1;}
if(req.sends>this.maxRetries){this._onDisconnectTimeout();return;}
var time_elapsed=req.age();var primaryTimeout=(!isNaN(time_elapsed)&&time_elapsed>Math.floor(Strophe.TIMEOUT*this.wait));var secondaryTimeout=(req.dead!==null&&req.timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait));var requestCompletedWithServerError=(req.xhr.readyState==4&&(reqStatus<1||reqStatus>=500));if(primaryTimeout||secondaryTimeout||requestCompletedWithServerError){if(secondaryTimeout){Strophe.error("Request "+
this._requests[i].id+" timed out (secondary), restarting");}
req.abort=true;req.xhr.abort();req.xhr.onreadystatechange=function(){};this._requests[i]=new Strophe.Request(req.xmlData,req.origFunc,req.rid,req.sends);req=this._requests[i];}
if(req.xhr.readyState===0){Strophe.debug("request id "+req.id+"."+req.sends+" posting");try{req.xhr.open("POST",this.service,true);}catch(e2){Strophe.error("XHR open failed.");if(!this.connected){this._changeConnectStatus(Strophe.Status.CONNFAIL,"bad-service");}
this.disconnect();return;}
var sendFunc=function(){req.date=new Date();req.xhr.send(req.data);};if(req.sends>1){var backoff=Math.min(Math.floor(Strophe.TIMEOUT*this.wait),Math.pow(req.sends,3))*1000;setTimeout(sendFunc,backoff);}else{sendFunc();}
req.sends++;if(this.xmlOutput!==Strophe.Connection.prototype.xmlOutput){this.xmlOutput(req.xmlData);}
if(this.rawOutput!==Strophe.Connection.prototype.rawOutput){this.rawOutput(req.data);}}else{Strophe.debug("_processRequest: "+
(i===0?"first":"second")+" request has readyState of "+
req.xhr.readyState);}},_throttledRequestHandler:function()
{if(!this._requests){Strophe.debug("_throttledRequestHandler called with "+"undefined requests");}else{Strophe.debug("_throttledRequestHandler called with "+
this._requests.length+" requests");}
if(!this._requests||this._requests.length===0){return;}
if(this._requests.length>0){this._processRequest(0);}
if(this._requests.length>1&&Math.abs(this._requests[0].rid-
this._requests[1].rid)<this.window){this._processRequest(1);}},_onRequestStateChange:function(func,req)
{Strophe.debug("request id "+req.id+"."+req.sends+" state changed to "+
req.xhr.readyState);if(req.abort){req.abort=false;return;}
var reqStatus;if(req.xhr.readyState==4){reqStatus=0;try{reqStatus=req.xhr.status;}catch(e){}
if(typeof(reqStatus)=="undefined"){reqStatus=0;}
if(this.disconnecting){if(reqStatus>=400){this._hitError(reqStatus);return;}}
var reqIs0=(this._requests[0]==req);var reqIs1=(this._requests[1]==req);if((reqStatus>0&&reqStatus<500)||req.sends>5){this._removeRequest(req);Strophe.debug("request id "+
req.id+" should now be removed");}
if(reqStatus==200){if(reqIs1||(reqIs0&&this._requests.length>0&&this._requests[0].age()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait))){this._restartRequest(0);}
Strophe.debug("request id "+
req.id+"."+
req.sends+" got 200");func(req);this.errors=0;}else{Strophe.error("request id "+
req.id+"."+
req.sends+" error "+reqStatus+" happened");if(reqStatus===0||(reqStatus>=400&&reqStatus<600)||reqStatus>=12000){this._hitError(reqStatus);if(reqStatus>=400&&reqStatus<500){this._changeConnectStatus(Strophe.Status.DISCONNECTING,null);this._doDisconnect();}}}
if(!((reqStatus>0&&reqStatus<500)||req.sends>5)){this._throttledRequestHandler();}}},_hitError:function(reqStatus)
{this.errors++;Strophe.warn("request errored, status: "+reqStatus+", number of errors: "+this.errors);if(this.errors>4){this._onDisconnectTimeout();}},_doDisconnect:function()
{Strophe.info("_doDisconnect was called");this.authenticated=false;this.disconnecting=false;this.sid=null;this.streamId=null;this.rid=Math.floor(Math.random()*4294967295);if(this.connected){this._changeConnectStatus(Strophe.Status.DISCONNECTED,null);this.connected=false;}
this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];},_dataRecv:function(req)
{try{var elem=req.getResponse();}catch(e){if(e!="parsererror"){throw e;}
this.disconnect("strophe-parsererror");}
if(elem===null){return;}
if(this.xmlInput!==Strophe.Connection.prototype.xmlInput){this.xmlInput(elem);}
if(this.rawInput!==Strophe.Connection.prototype.rawInput){this.rawInput(Strophe.serialize(elem));}
var i,hand;while(this.removeHandlers.length>0){hand=this.removeHandlers.pop();i=this.handlers.indexOf(hand);if(i>=0){this.handlers.splice(i,1);}}
while(this.addHandlers.length>0){this.handlers.push(this.addHandlers.pop());}
if(this.disconnecting&&this._requests.length===0){this.deleteTimedHandler(this._disconnectTimeout);this._disconnectTimeout=null;this._doDisconnect();return;}
var typ=elem.getAttribute("type");var cond,conflict;if(typ!==null&&typ=="terminate"){if(this.disconnecting){return;}
cond=elem.getAttribute("condition");conflict=elem.getElementsByTagName("conflict");if(cond!==null){if(cond=="remote-stream-error"&&conflict.length>0){cond="conflict";}
this._changeConnectStatus(Strophe.Status.CONNFAIL,cond);}else{this._changeConnectStatus(Strophe.Status.CONNFAIL,"unknown");}
this.disconnect();return;}
var that=this;Strophe.forEachChild(elem,null,function(child){var i,newList;newList=that.handlers;that.handlers=[];for(i=0;i<newList.length;i++){var hand=newList[i];try{if(hand.isMatch(child)&&(that.authenticated||!hand.user)){if(hand.run(child)){that.handlers.push(hand);}}else{that.handlers.push(hand);}}catch(e){}}});},_sendTerminate:function()
{Strophe.info("_sendTerminate was called");var body=this._buildBody().attrs({type:"terminate"});if(this.authenticated){body.c('presence',{xmlns:Strophe.NS.CLIENT,type:'unavailable'});}
this.disconnecting=true;var req=new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),body.tree().getAttribute("rid"));this._requests.push(req);this._throttledRequestHandler();},_connect_cb:function(req,_callback)
{Strophe.info("_connect_cb was called");this.connected=true;var bodyWrap=req.getResponse();if(!bodyWrap){return;}
if(this.xmlInput!==Strophe.Connection.prototype.xmlInput){this.xmlInput(bodyWrap);}
if(this.rawInput!==Strophe.Connection.prototype.rawInput){this.rawInput(Strophe.serialize(bodyWrap));}
var typ=bodyWrap.getAttribute("type");var cond,conflict;if(typ!==null&&typ=="terminate"){cond=bodyWrap.getAttribute("condition");conflict=bodyWrap.getElementsByTagName("conflict");if(cond!==null){if(cond=="remote-stream-error"&&conflict.length>0){cond="conflict";}
this._changeConnectStatus(Strophe.Status.CONNFAIL,cond);}else{this._changeConnectStatus(Strophe.Status.CONNFAIL,"unknown");}
return;}
if(!this.sid){this.sid=bodyWrap.getAttribute("sid");}
if(!this.stream_id){this.stream_id=bodyWrap.getAttribute("authid");}
var wind=bodyWrap.getAttribute('requests');if(wind){this.window=parseInt(wind,10);}
var hold=bodyWrap.getAttribute('hold');if(hold){this.hold=parseInt(hold,10);}
var wait=bodyWrap.getAttribute('wait');if(wait){this.wait=parseInt(wait,10);}
this._authentication.sasl_scram_sha1=false;this._authentication.sasl_plain=false;this._authentication.sasl_digest_md5=false;this._authentication.sasl_anonymous=false;this._authentication.legacy_auth=false;var hasFeatures=bodyWrap.getElementsByTagName("stream:features").length>0;if(!hasFeatures){hasFeatures=bodyWrap.getElementsByTagName("features").length>0;}
var mechanisms=bodyWrap.getElementsByTagName("mechanism");var i,mech,auth_str,hashed_auth_str,found_authentication=false;if(hasFeatures&&mechanisms.length>0){var missmatchedmechs=0;for(i=0;i<mechanisms.length;i++){mech=Strophe.getText(mechanisms[i]);if(mech=='SCRAM-SHA-1'){this._authentication.sasl_scram_sha1=true;}else if(mech=='DIGEST-MD5'){this._authentication.sasl_digest_md5=true;}else if(mech=='PLAIN'){this._authentication.sasl_plain=true;}else if(mech=='ANONYMOUS'){this._authentication.sasl_anonymous=true;}else missmatchedmechs++;}
this._authentication.legacy_auth=bodyWrap.getElementsByTagName("auth").length>0;found_authentication=this._authentication.legacy_auth||missmatchedmechs<mechanisms.length;}
if(!found_authentication){_callback=_callback||this._connect_cb;var body=this._buildBody();this._requests.push(new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,_callback.bind(this)),body.tree().getAttribute("rid")));this._throttledRequestHandler();return;}
if(this.do_authentication!==false)
this.authenticate();},authenticate:function()
{if(Strophe.getNodeFromJid(this.jid)===null&&this._authentication.sasl_anonymous){this._changeConnectStatus(Strophe.Status.AUTHENTICATING,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send($build("auth",{xmlns:Strophe.NS.SASL,mechanism:"ANONYMOUS"}).tree());}else if(Strophe.getNodeFromJid(this.jid)===null){this._changeConnectStatus(Strophe.Status.CONNFAIL,'x-strophe-bad-non-anon-jid');this.disconnect();}else if(this._authentication.sasl_scram_sha1){var cnonce=MD5.hexdigest(Math.random()*1234567890);var auth_str="n="+Strophe.getNodeFromJid(this.jid);auth_str+=",r=";auth_str+=cnonce;this._sasl_data["cnonce"]=cnonce;this._sasl_data["client-first-message-bare"]=auth_str;auth_str="n,,"+auth_str;this._changeConnectStatus(Strophe.Status.AUTHENTICATING,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_scram_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send($build("auth",{xmlns:Strophe.NS.SASL,mechanism:"SCRAM-SHA-1"}).t(Base64.encode(auth_str)).tree());}else if(this._authentication.sasl_digest_md5){this._changeConnectStatus(Strophe.Status.AUTHENTICATING,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_digest_challenge1_cb.bind(this),null,"challenge",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send($build("auth",{xmlns:Strophe.NS.SASL,mechanism:"DIGEST-MD5"}).tree());}else if(this._authentication.sasl_plain){auth_str=Strophe.getBareJidFromJid(this.jid);auth_str=auth_str+"\u0000";auth_str=auth_str+Strophe.getNodeFromJid(this.jid);auth_str=auth_str+"\u0000";auth_str=auth_str+this.pass;this._changeConnectStatus(Strophe.Status.AUTHENTICATING,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);hashed_auth_str=Base64.encode(auth_str);this.send($build("auth",{xmlns:Strophe.NS.SASL,mechanism:"PLAIN"}).t(hashed_auth_str).tree());}else{this._changeConnectStatus(Strophe.Status.AUTHENTICATING,null);this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1");this.send($iq({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:Strophe.NS.AUTH}).c("username",{}).t(Strophe.getNodeFromJid(this.jid)).tree());}},_sasl_digest_challenge1_cb:function(elem)
{var attribMatch=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;var challenge=Base64.decode(Strophe.getText(elem));var cnonce=MD5.hexdigest(""+(Math.random()*1234567890));var realm="";var host=null;var nonce="";var qop="";var matches;this.deleteHandler(this._sasl_failure_handler);while(challenge.match(attribMatch)){matches=challenge.match(attribMatch);challenge=challenge.replace(matches[0],"");matches[2]=matches[2].replace(/^"(.+)"$/,"$1");switch(matches[1]){case"realm":realm=matches[2];break;case"nonce":nonce=matches[2];break;case"qop":qop=matches[2];break;case"host":host=matches[2];break;}}
var digest_uri="xmpp/"+this.domain;if(host!==null){digest_uri=digest_uri+"/"+host;}
var A1=MD5.hash(Strophe.getNodeFromJid(this.jid)+":"+realm+":"+this.pass)+":"+nonce+":"+cnonce;var A2='AUTHENTICATE:'+digest_uri;var responseText="";responseText+='username='+
this._quote(Strophe.getNodeFromJid(this.jid))+',';responseText+='realm='+this._quote(realm)+',';responseText+='nonce='+this._quote(nonce)+',';responseText+='cnonce='+this._quote(cnonce)+',';responseText+='nc="00000001",';responseText+='qop="auth",';responseText+='digest-uri='+this._quote(digest_uri)+',';responseText+='response='+this._quote(MD5.hexdigest(MD5.hexdigest(A1)+":"+
nonce+":00000001:"+
cnonce+":auth:"+
MD5.hexdigest(A2)))+',';responseText+='charset="utf-8"';this._sasl_challenge_handler=this._addSysHandler(this._sasl_digest_challenge2_cb.bind(this),null,"challenge",null,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send($build('response',{xmlns:Strophe.NS.SASL}).t(Base64.encode(responseText)).tree());return false;},_quote:function(str)
{return'"'+str.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"';},_sasl_digest_challenge2_cb:function(elem)
{this.deleteHandler(this._sasl_success_handler);this.deleteHandler(this._sasl_failure_handler);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send($build('response',{xmlns:Strophe.NS.SASL}).tree());return false;},_sasl_scram_challenge_cb:function(elem)
{var nonce,salt,iter,Hi,U,U_old;var clientKey,serverKey,clientSignature;var responseText="c=biws,";var challenge=Base64.decode(Strophe.getText(elem));var authMessage=this._sasl_data["client-first-message-bare"]+","+
challenge+",";var cnonce=this._sasl_data["cnonce"]
var attribMatch=/([a-z]+)=([^,]+)(,|$)/;this.deleteHandler(this._sasl_failure_handler);while(challenge.match(attribMatch)){matches=challenge.match(attribMatch);challenge=challenge.replace(matches[0],"");switch(matches[1]){case"r":nonce=matches[2];break;case"s":salt=matches[2];break;case"i":iter=matches[2];break;}}
if(!(nonce.substr(0,cnonce.length)===cnonce)){this._sasl_data=[];return this._sasl_failure_cb(null);}
responseText+="r="+nonce;authMessage+=responseText;salt=Base64.decode(salt);salt+="\0\0\0\1";Hi=U_old=core_hmac_sha1(this.pass,salt);for(i=1;i<iter;i++){U=core_hmac_sha1(this.pass,binb2str(U_old));for(k=0;k<5;k++){Hi[k]^=U[k];}
U_old=U;}
Hi=binb2str(Hi);clientKey=core_hmac_sha1(Hi,"Client Key");serverKey=str_hmac_sha1(Hi,"Server Key");clientSignature=core_hmac_sha1(str_sha1(binb2str(clientKey)),authMessage);this._sasl_data["server-signature"]=b64_hmac_sha1(serverKey,authMessage);for(k=0;k<5;k++){clientKey[k]^=clientSignature[k];}
responseText+=",p="+Base64.encode(binb2str(clientKey));this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send($build('response',{xmlns:Strophe.NS.SASL}).t(Base64.encode(responseText)).tree());return false;},_auth1_cb:function(elem)
{var iq=$iq({type:"set",id:"_auth_2"}).c('query',{xmlns:Strophe.NS.AUTH}).c('username',{}).t(Strophe.getNodeFromJid(this.jid)).up().c('password').t(this.pass);if(!Strophe.getResourceFromJid(this.jid)){this.jid=Strophe.getBareJidFromJid(this.jid)+'/strophe';}
iq.up().c('resource',{}).t(Strophe.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(iq.tree());return false;},_sasl_success_cb:function(elem)
{if(this._sasl_data["server-signature"]){var serverSignature;var success=Base64.decode(Strophe.getText(elem));var attribMatch=/([a-z]+)=([^,]+)(,|$)/;matches=success.match(attribMatch);if(matches[1]=="v"){serverSignature=matches[2];}
if(serverSignature!=this._sasl_data["server-signature"]){this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null;}
this._sasl_data=[];return this._sasl_failure_cb(null);}}
Strophe.info("SASL authentication succeeded.");this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null;}
this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null);this._sendRestart();return false;},_sasl_auth1_cb:function(elem)
{this.features=elem;var i,child;for(i=0;i<elem.childNodes.length;i++){child=elem.childNodes[i];if(child.nodeName=='bind'){this.do_bind=true;}
if(child.nodeName=='session'){this.do_session=true;}}
if(!this.do_bind){this._changeConnectStatus(Strophe.Status.AUTHFAIL,null);return false;}else{this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var resource=Strophe.getResourceFromJid(this.jid);if(resource){this.send($iq({type:"set",id:"_bind_auth_2"}).c('bind',{xmlns:Strophe.NS.BIND}).c('resource',{}).t(resource).tree());}else{this.send($iq({type:"set",id:"_bind_auth_2"}).c('bind',{xmlns:Strophe.NS.BIND}).tree());}}
return false;},_sasl_bind_cb:function(elem)
{if(elem.getAttribute("type")=="error"){Strophe.info("SASL binding failed.");var conflict=elem.getElementsByTagName("conflict"),condition;if(conflict.length>0){condition='conflict';}
this._changeConnectStatus(Strophe.Status.AUTHFAIL,condition);return false;}
var bind=elem.getElementsByTagName("bind");var jidNode;if(bind.length>0){jidNode=bind[0].getElementsByTagName("jid");if(jidNode.length>0){this.jid=Strophe.getText(jidNode[0]);if(this.do_session){this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2");this.send($iq({type:"set",id:"_session_auth_2"}).c('session',{xmlns:Strophe.NS.SESSION}).tree());}else{this.authenticated=true;this._changeConnectStatus(Strophe.Status.CONNECTED,null);}}}else{Strophe.info("SASL binding failed.");this._changeConnectStatus(Strophe.Status.AUTHFAIL,null);return false;}},_sasl_session_cb:function(elem)
{if(elem.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(Strophe.Status.CONNECTED,null);}else if(elem.getAttribute("type")=="error"){Strophe.info("Session creation failed.");this._changeConnectStatus(Strophe.Status.AUTHFAIL,null);return false;}
return false;},_sasl_failure_cb:function(elem)
{if(this._sasl_success_handler){this.deleteHandler(this._sasl_success_handler);this._sasl_success_handler=null;}
if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null;}
this._changeConnectStatus(Strophe.Status.AUTHFAIL,null);return false;},_auth2_cb:function(elem)
{if(elem.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(Strophe.Status.CONNECTED,null);}else if(elem.getAttribute("type")=="error"){this._changeConnectStatus(Strophe.Status.AUTHFAIL,null);this.disconnect();}
return false;},_addSysTimedHandler:function(period,handler)
{var thand=new Strophe.TimedHandler(period,handler);thand.user=false;this.addTimeds.push(thand);return thand;},_addSysHandler:function(handler,ns,name,type,id)
{var hand=new Strophe.Handler(handler,ns,name,type,id);hand.user=false;this.addHandlers.push(hand);return hand;},_onDisconnectTimeout:function()
{Strophe.info("_onDisconnectTimeout was called");var req;while(this._requests.length>0){req=this._requests.pop();req.abort=true;req.xhr.abort();req.xhr.onreadystatechange=function(){};}
this._doDisconnect();return false;},_onIdle:function()
{var i,thand,since,newList;while(this.addTimeds.length>0){this.timedHandlers.push(this.addTimeds.pop());}
while(this.removeTimeds.length>0){thand=this.removeTimeds.pop();i=this.timedHandlers.indexOf(thand);if(i>=0){this.timedHandlers.splice(i,1);}}
var now=new Date().getTime();newList=[];for(i=0;i<this.timedHandlers.length;i++){thand=this.timedHandlers[i];if(this.authenticated||!thand.user){since=thand.lastCalled+thand.period;if(since-now<=0){if(thand.run()){newList.push(thand);}}else{newList.push(thand);}}}
this.timedHandlers=newList;var body,time_elapsed;if(this.authenticated&&this._requests.length===0&&this._data.length===0&&!this.disconnecting){Strophe.info("no requests during idle cycle, sending "+"blank request");this._data.push(null);}
if(this._requests.length<2&&this._data.length>0&&!this.paused){body=this._buildBody();for(i=0;i<this._data.length;i++){if(this._data[i]!==null){if(this._data[i]==="restart"){body.attrs({to:this.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":Strophe.NS.BOSH});}else{body.cnode(this._data[i]).up();}}}
delete this._data;this._data=[];this._requests.push(new Strophe.Request(body.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),body.tree().getAttribute("rid")));this._processRequest(this._requests.length-1);}
if(this._requests.length>0){time_elapsed=this._requests[0].age();if(this._requests[0].dead!==null){if(this._requests[0].timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait)){this._throttledRequestHandler();}}
if(time_elapsed>Math.floor(Strophe.TIMEOUT*this.wait)){Strophe.warn("Request "+
this._requests[0].id+" timed out, over "+Math.floor(Strophe.TIMEOUT*this.wait)+" seconds since last activity");this._throttledRequestHandler();}}
clearTimeout(this._idleTimeout);if(this.connected){this._idleTimeout=setTimeout(this._onIdle.bind(this),100);}}};if(callback){callback(Strophe,$build,$msg,$iq,$pres);}})(function(){window.Strophe=arguments[0];window.$build=arguments[1];window.$msg=arguments[2];window.$iq=arguments[3];window.$pres=arguments[4];});;(function(jQuery){jQuery.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",191:"/",224:"meta",91:"windows",92:"windows",219:"[",221:"]"},shiftNums:{"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":": ","'":"\"",",":"<",".":">","/":"?","\\":"|"}};function keyHandler(handleObj){if(typeof handleObj.data!=="string"){return;}
var origHandler=handleObj.handler,keys=handleObj.data.toLowerCase().split(" ");handleObj.handler=function(event){if(this!==event.target&&(/textarea|select/i.test(event.target.nodeName)||event.target.type==="text")){return;}
var special=event.type!=="keypress"&&jQuery.hotkeys.specialKeys[event.which],character=String.fromCharCode(event.which).toLowerCase(),key,modif="",possible={};if(event.altKey&&special!=="alt"){modif+="alt+";}
if(event.ctrlKey&&special!=="ctrl"){modif+="ctrl+";}
if(event.metaKey&&!event.ctrlKey&&special!=="meta"){modif+="meta+";}
if(event.shiftKey&&special!=="shift"){modif+="shift+";}
if(special){possible[modif+special]=true;}else{possible[modif+character]=true;possible[modif+jQuery.hotkeys.shiftNums[character]]=true;if(modif==="shift+"){possible[jQuery.hotkeys.shiftNums[character]]=true;}}
for(var i=0,l=keys.length;i<l;i++){if(possible[keys[i]]){return origHandler.apply(this,arguments);}}};}
jQuery.each(["keydown","keyup","keypress"],function(){jQuery.event.special[this]={add:keyHandler};});})(jQuery);;var mention_autocomplete={input:null,position_node:null,autocomplete:null,search_str:'',choose_selected:function(){var tag=this.autocomplete.find('div.selected:first').attr('tag');if(tag){var selection=this.input.getSelection();var replacement=(tag.indexOf(' ')==-1?('@'+tag+' '):('@"'+tag+'" '));var replaced_message=this.input.val().substr(0,selection.end).replace(/@\w*$/,replacement);this.input.val(replaced_message+this.input.val().substr(selection.end));this.input.setSelection(replaced_message.length,replaced_message.length);}
this.autocomplete.hide();},display_autocomplete:function(){var member_list=[];var users_in_room={};if(util.jid.is_room(app.current_jid)){if(app.is_private_room(app.current_jid)){member_list=app.room_rosters[app.current_jid];}else{member_list=app.roster;}
var room_roster=app.room_rosters[app.current_jid];for(i=0;i<room_roster.length;i++){var member=room_roster[i];if(member.type==app.PRESENCE_TYPE_AVAILABLE){users_in_room[member.jid]=true;}else{users_in_room[member.jid]=false;}}
this.populate(member_list,users_in_room,true);}else{member_list=[app.get_user_info(app.current_jid)];this.populate(member_list,{},false);}
this.autocomplete.show().scrollTop(0).width(this.position_node.outerWidth()-2);},filter:function(str){str=str.toLowerCase();this.search_str=str;this.update_match_state();$("div",this.autocomplete).sort(this.sort).appendTo(this.autocomplete);this.autocomplete.find('div.member').each(function(idx,elem){var elem=$(elem);elem.removeClass('selected');if(str.length==0){elem.html(elem.text()).show();return;}
var matches=false;var highlighted_string=null;if(elem.attr('mention_match')=='true'){matches=true;var label=elem.text();var mention_match_pos=label.search(new RegExp("@"+str,"i"));if(mention_match_pos!=-1){highlighted_string=label.substring(0,mention_match_pos+1);highlighted_string+="<u>"+label.substr(mention_match_pos+1,str.length)+"</u>";highlighted_string+=label.substr(mention_match_pos+1+str.length,label.length);}}else{var words=elem.text().split(' ');for(var i=0;i<words.length;i++){var word=words[i].toLowerCase();if(str==word.substr(0,str.length)){words[i]='<u>'+words[i].substr(0,str.length)+'</u>'+words[i].substr(str.length);matches=true;}}
highlighted_string=words.join(' ');}
if(matches){elem.html(highlighted_string).show();}else{elem.hide();}});this.autocomplete.find('div.member:visible:first').addClass('selected');},handle_input_keydown:function(event){if(event.keyCode==13||event.keyCode==9){if(this.autocomplete.is(':visible')){event.preventDefault();event.stopImmediatePropagation();}}else if(event.keyCode==38){if(this.autocomplete.is(':visible')){event.preventDefault();event.stopImmediatePropagation();this.select_previous();}}else if(event.keyCode==40){if(this.autocomplete.is(':visible')){event.preventDefault();event.stopImmediatePropagation();this.select_next();}}},handle_input_keyup:function(event){var is_cursor_move=false;if(event.keyCode==37||event.keyCode==38||event.keyCode==39||event.keyCode==40){is_cursor_move=true;}
var cur_text=this.input.val();var pos=this.input.getSelection().start;var test=/@(\w*)$/;var matches=cur_text.substr(0,pos).match(test);if(!matches||matches.length==0){this.autocomplete.hide();return;}
if(is_cursor_move){return;}
if(event.keyCode==13||event.keyCode==9){if(this.autocomplete.is(':visible')){this.choose_selected();return;}}else if(event.keyCode==27){if(this.autocomplete.is(':visible')){this.autocomplete.hide();return;}}
if(!this.autocomplete.is(':visible')){this.display_autocomplete();}
this.filter(matches[1]);if(this.autocomplete.find('div:visible').length==0){this.autocomplete.hide();return;}
var self=this;setTimeout(function(){var coords=self.position_node.offset();self.autocomplete.offset({top:(coords.top-self.autocomplete.outerHeight()),left:coords.left});},0);},handle_mousedown:function(event){var target=$(event.target);var member=(target.hasClass('member')?target:target.closest('.member'));if(member.length>0){this.autocomplete.find('div.member').removeClass('selected');member.addClass('selected');this.choose_selected();}},init:function(input,position_node){this.input=$(input);this.position_node=$(position_node);var autocomplete_node=$(document.createElement('div'));autocomplete_node.attr('id','autocomplete');autocomplete_node.hide();$('body').append(autocomplete_node);this.autocomplete=autocomplete_node;this.autocomplete.mousedown($.proxy(this,'handle_mousedown'));this.input.keydown($.proxy(this,'handle_input_keydown')).keyup($.proxy(this,'handle_input_keyup'));},populate:function(member_list,users_in_room,include_room_mentions){this.autocomplete.html('');var html_strings=[];for(var i=0;i<member_list.length;i++){var member=member_list[i];var first_name=String(String(member.name).split(' ')[0]).toLowerCase();var class_name=(i==0?' selected':'');var nick=(member.mention_name?member.mention_name:'');var default_mention_name=helpers.get_default_mention_name(member.name);var mention=(member.mention_name?member.mention_name:default_mention_name);var label=(nick.length>0?member.name+' (@'+nick+')':member.name);var is_in_room=users_in_room[member.jid];html_strings.push('<div class="member'+class_name+'" tag="'+mention+'" nick="'+nick+'" in_room="'+is_in_room+'" mention_match="false" first_name_match="false">'+label+'</div>');}
if(include_room_mentions){html_strings.push('<div class="member" tag="all" nick="all" in_room="false" mention_match="false" first_name_match="false">All room members (@all)</div>');html_strings.push('<div class="member" tag="here" nick="here" in_room="false" mention_match="false" first_name_match="false">Available room members (@here)</div>');}
this.autocomplete.append(html_strings.join(''));},select_next:function(){var selected=this.autocomplete.find('.selected');var next_item=selected.nextAll(':visible:first');if(next_item.length>0){selected.removeClass('selected');next_item.addClass('selected');if(next_item.position().top+next_item.outerHeight()>this.autocomplete.height()){this.autocomplete.scrollTop(this.autocomplete.scrollTop()+next_item.outerHeight());}}},select_previous:function(){var selected=this.autocomplete.find('.selected');var prev_item=selected.prevAll(':visible:first');if(prev_item.length>0){selected.removeClass('selected');prev_item.addClass('selected');if(prev_item.position().top<0){this.autocomplete.scrollTop(this.autocomplete.scrollTop()-prev_item.outerHeight());}}},sort:function(a,b){a=$(a);b=$(b);var aName=a.text();var aIsFirstNameMatch=(a.attr('first_name_match')=='true'?2:0);var aIsInRoom=(a.attr('in_room')=='true'?3:0);var aIsMentionMatch=(!aIsFirstNameMatch&&a.attr('mention_match')=='true'?4:0);var bName=b.text();var bIsFirstNameMatch=(b.attr('first_name_match')=='true'?2:0);var bIsInRoom=(b.attr('in_room')=='true'?3:0);var bIsMentionMatch=(!bIsFirstNameMatch&&b.attr('mention_match')=='true'?4:0);var aMatchRating=(aIsFirstNameMatch+aIsInRoom+aIsMentionMatch);var bMatchRating=(bIsFirstNameMatch+bIsInRoom+bIsMentionMatch);if(aMatchRating>bMatchRating)return-1;else if(bMatchRating>aMatchRating)return 1;else{if(aName.toLowerCase()<bName.toLowerCase())return-1;else if(aName.toLowerCase()>bName.toLowerCase())return 1;return 0;}},update_match_state:function(){var self=this;this.autocomplete.find('div.member').each(function(idx,elem){var elem=$(elem);if(self.search_str.length==0){elem.attr('mention_match',false);elem.attr('first_name_match',false);return;}
if(elem.text()=='All'){return;}
elem.attr('mention_match',(elem.attr('nick').toLowerCase().substring(0,self.search_str.length)==self.search_str));elem.attr('first_name_match',(elem.text().toLowerCase().substring(0,self.search_str.length)==self.search_str));});}};;
/*!
 * Tinycon - A small library for manipulating the Favicon
 * Tom Moor, http://tommoor.com
 * Copyright (c) 2012 Tom Moor
 * MIT Licensed
 * @version 0.2.6
*/
(function(){var Tinycon={};var currentFavicon=null;var originalFavicon=null;var originalTitle=document.title;var faviconImage=null;var canvas=null;var options={};var defaults={width:7,height:9,font:'10px arial',colour:'#ffffff',background:'#F03D25',fallback:true};var ua=(function(){var agent=navigator.userAgent.toLowerCase();return function(browser){return agent.indexOf(browser)!==-1;};}());var browser={chrome:ua('chrome'),webkit:ua('chrome')||ua('safari'),safari:ua('safari')&&!ua('chrome'),mozilla:ua('mozilla')&&!ua('chrome')&&!ua('safari')};var getFaviconTag=function(){var links=document.getElementsByTagName('link');for(var i=0,len=links.length;i<len;i++){if((links[i].getAttribute('rel')||'').match(/\bicon\b/)){return links[i];}}
return false;};var removeFaviconTag=function(){var links=document.getElementsByTagName('link');var head=document.getElementsByTagName('head')[0];for(var i=0,len=links.length;i<len;i++){var exists=(typeof(links[i])!=='undefined');if(exists&&links[i].getAttribute('rel')==='icon'){head.removeChild(links[i]);}}};var getCurrentFavicon=function(){if(!originalFavicon||!currentFavicon){var tag=getFaviconTag();originalFavicon=currentFavicon=tag?tag.getAttribute('href'):'/favicon.ico';}
return currentFavicon;};var getCanvas=function(){if(!canvas){canvas=document.createElement("canvas");canvas.width=16;canvas.height=16;}
return canvas;};var setFaviconTag=function(url){removeFaviconTag();var link=document.createElement('link');link.type='image/x-icon';link.rel='icon';link.href=url;document.getElementsByTagName('head')[0].appendChild(link);};var log=function(message){if(window.console)window.console.log(message);};var drawFavicon=function(num,colour){if(!getCanvas().getContext||browser.safari||options.fallback==='force'){return updateTitle(num);}
var context=getCanvas().getContext("2d");var colour=colour||'#000000';var num=num||0;var src=getCurrentFavicon();faviconImage=new Image();faviconImage.onload=function(){context.clearRect(0,0,16,16);context.drawImage(faviconImage,0,0,faviconImage.width,faviconImage.height,0,0,16,16);if(num>0)drawBubble(context,num,colour);refreshFavicon();};if(!src.match(/^data/)){faviconImage.crossOrigin='anonymous';}
faviconImage.src=src;};var updateTitle=function(num){if(options.fallback){if(num>0){document.title='('+num+') '+originalTitle;}else{document.title=originalTitle;}}};var drawBubble=function(context,num,colour){var len=(num+"").length-1;var width=options.width+(6*len);var w=16-width;var h=16-options.height;context.font=(browser.webkit?'bold ':'')+options.font;context.fillStyle=options.background;context.strokeStyle=options.background;context.lineWidth=1;context.fillRect(w,h,width-1,options.height);context.beginPath();context.moveTo(w-0.5,h+1);context.lineTo(w-0.5,15);context.stroke();context.beginPath();context.moveTo(15.5,h+1);context.lineTo(15.5,15);context.stroke();context.beginPath();context.strokeStyle="rgba(0,0,0,0.3)";context.moveTo(w,16);context.lineTo(15,16);context.stroke();context.fillStyle=options.colour;context.textAlign="right";context.textBaseline="top";context.fillText(num,15,browser.mozilla?7:6);};var refreshFavicon=function(){if(!getCanvas().getContext)return;setFaviconTag(getCanvas().toDataURL());};Tinycon.setOptions=function(custom){options={};for(var key in defaults){options[key]=custom.hasOwnProperty(key)?custom[key]:defaults[key];}
return this;};Tinycon.setImage=function(url){currentFavicon=url;refreshFavicon();return this;};Tinycon.setBubble=function(num,colour){if(isNaN(parseFloat(num))||!isFinite(num))return log('Bubble must be a number');drawFavicon(num,colour);return this;};Tinycon.reset=function(){Tinycon.setImage(originalFavicon);};Tinycon.setOptions(defaults);window.Tinycon=Tinycon;})();;if(typeof deconcept=="undefined"){var deconcept=new Object();}if(typeof deconcept.util=="undefined"){deconcept.util=new Object();}if(typeof deconcept.SWFObjectUtil=="undefined"){deconcept.SWFObjectUtil=new Object();}deconcept.SWFObject=function(_1,id,w,h,_5,c,_7,_8,_9,_a){if(!document.getElementById){return;}this.DETECT_KEY=_a?_a:"detectflash";this.skipDetect=deconcept.util.getRequestParameter(this.DETECT_KEY);this.params=new Object();this.variables=new Object();this.attributes=new Array();if(_1){this.setAttribute("swf",_1);}if(id){this.setAttribute("id",id);}if(w){this.setAttribute("width",w);}if(h){this.setAttribute("height",h);}if(_5){this.setAttribute("version",new deconcept.PlayerVersion(_5.toString().split(".")));}this.installedVer=deconcept.SWFObjectUtil.getPlayerVersion();if(!window.opera&&document.all&&this.installedVer.major>7){deconcept.SWFObject.doPrepUnload=true;}if(c){this.addParam("bgcolor",c);}var q=_7?_7:"high";this.addParam("quality",q);this.setAttribute("useExpressInstall",false);this.setAttribute("doExpressInstall",false);var _c=(_8)?_8:window.location;this.setAttribute("xiRedirectUrl",_c);this.setAttribute("redirectUrl","");if(_9){this.setAttribute("redirectUrl",_9);}};deconcept.SWFObject.prototype={useExpressInstall:function(_d){this.xiSWFPath=!_d?"expressinstall.swf":_d;this.setAttribute("useExpressInstall",true);},setAttribute:function(_e,_f){this.attributes[_e]=_f;},getAttribute:function(_10){return this.attributes[_10];},addParam:function(_11,_12){this.params[_11]=_12;},getParams:function(){return this.params;},addVariable:function(_13,_14){this.variables[_13]=_14;},getVariable:function(_15){return this.variables[_15];},getVariables:function(){return this.variables;},getVariablePairs:function(){var _16=new Array();var key;var _18=this.getVariables();for(key in _18){_16[_16.length]=key+"="+_18[key];}return _16;},getSWFHTML:function(){var _19="";if(navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length){if(this.getAttribute("doExpressInstall")){this.addVariable("MMplayerType","PlugIn");this.setAttribute("swf",this.xiSWFPath);}_19="<embed type=\"application/x-shockwave-flash\" src=\""+this.getAttribute("swf")+"\" width=\""+this.getAttribute("width")+"\" height=\""+this.getAttribute("height")+"\" style=\""+this.getAttribute("style")+"\"";_19+=" id=\""+this.getAttribute("id")+"\" name=\""+this.getAttribute("id")+"\" ";var _1a=this.getParams();for(var key in _1a){_19+=[key]+"=\""+_1a[key]+"\" ";}var _1c=this.getVariablePairs().join("&");if(_1c.length>0){_19+="flashvars=\""+_1c+"\"";}_19+="/>";}else{if(this.getAttribute("doExpressInstall")){this.addVariable("MMplayerType","ActiveX");this.setAttribute("swf",this.xiSWFPath);}_19="<object id=\""+this.getAttribute("id")+"\" classid=\"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000\" width=\""+this.getAttribute("width")+"\" height=\""+this.getAttribute("height")+"\" style=\""+this.getAttribute("style")+"\">";_19+="<param name=\"movie\" value=\""+this.getAttribute("swf")+"\" />";var _1d=this.getParams();for(var key in _1d){_19+="<param name=\""+key+"\" value=\""+_1d[key]+"\" />";}var _1f=this.getVariablePairs().join("&");if(_1f.length>0){_19+="<param name=\"flashvars\" value=\""+_1f+"\" />";}_19+="</object>";}return _19;},write:function(_20){if(this.getAttribute("useExpressInstall")){var _21=new deconcept.PlayerVersion([6,0,65]);if(this.installedVer.versionIsValid(_21)&&!this.installedVer.versionIsValid(this.getAttribute("version"))){this.setAttribute("doExpressInstall",true);this.addVariable("MMredirectURL",escape(this.getAttribute("xiRedirectUrl")));document.title=document.title.slice(0,47)+" - Flash Player Installation";this.addVariable("MMdoctitle",document.title);}}if(this.skipDetect||this.getAttribute("doExpressInstall")||this.installedVer.versionIsValid(this.getAttribute("version"))){var n=(typeof _20=="string")?document.getElementById(_20):_20;n.innerHTML=this.getSWFHTML();return true;}else{if(this.getAttribute("redirectUrl")!=""){document.location.replace(this.getAttribute("redirectUrl"));}}return false;}};deconcept.SWFObjectUtil.getPlayerVersion=function(){var _23=new deconcept.PlayerVersion([0,0,0]);if(navigator.plugins&&navigator.mimeTypes.length){var x=navigator.plugins["Shockwave Flash"];if(x&&x.description){_23=new deconcept.PlayerVersion(x.description.replace(/([a-zA-Z]|\s)+/,"").replace(/(\s+r|\s+b[0-9]+)/,".").split("."));}}else{if(navigator.userAgent&&navigator.userAgent.indexOf("Windows CE")>=0){var axo=1;var _26=3;while(axo){try{_26++;axo=new ActiveXObject("ShockwaveFlash.ShockwaveFlash."+_26);_23=new deconcept.PlayerVersion([_26,0,0]);}catch(e){axo=null;}}}else{try{var axo=new ActiveXObject("ShockwaveFlash.ShockwaveFlash.7");}catch(e){try{var axo=new ActiveXObject("ShockwaveFlash.ShockwaveFlash.6");_23=new deconcept.PlayerVersion([6,0,21]);axo.AllowScriptAccess="always";}catch(e){if(_23.major==6){return _23;}}try{axo=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");}catch(e){}}if(axo!=null){_23=new deconcept.PlayerVersion(axo.GetVariable("$version").split(" ")[1].split(","));}}}return _23;};deconcept.PlayerVersion=function(_29){this.major=_29[0]!=null?parseInt(_29[0]):0;this.minor=_29[1]!=null?parseInt(_29[1]):0;this.rev=_29[2]!=null?parseInt(_29[2]):0;};deconcept.PlayerVersion.prototype.versionIsValid=function(fv){if(this.major<fv.major){return false;}if(this.major>fv.major){return true;}if(this.minor<fv.minor){return false;}if(this.minor>fv.minor){return true;}if(this.rev<fv.rev){return false;}return true;};deconcept.util={getRequestParameter:function(_2b){var q=document.location.search||document.location.hash;if(_2b==null){return q;}if(q){var _2d=q.substring(1).split("&");for(var i=0;i<_2d.length;i++){if(_2d[i].substring(0,_2d[i].indexOf("="))==_2b){return _2d[i].substring((_2d[i].indexOf("=")+1));}}}return"";}};deconcept.SWFObjectUtil.cleanupSWFs=function(){var _2f=document.getElementsByTagName("OBJECT");for(var i=_2f.length-1;i>=0;i--){_2f[i].style.display="none";for(var x in _2f[i]){if(typeof _2f[i][x]=="function"){_2f[i][x]=function(){};}}}};if(deconcept.SWFObject.doPrepUnload){if(!deconcept.unloadSet){deconcept.SWFObjectUtil.prepUnload=function(){__flash_unloadHandler=function(){};__flash_savedUnloadHandler=function(){};window.attachEvent("onunload",deconcept.SWFObjectUtil.cleanupSWFs);};window.attachEvent("onbeforeunload",deconcept.SWFObjectUtil.prepUnload);deconcept.unloadSet=true;}}if(!document.getElementById&&document.all){document.getElementById=function(id){return document.all[id];};}var getQueryParamValue=deconcept.util.getRequestParameter;var FlashObject=deconcept.SWFObject;var SWFObject=deconcept.SWFObject;;if(typeof userEmail!='undefined'&&typeof downloadUrl!='undefined'&&typeof appId!='undefined'){var so=new SWFObject
("/flash/AIRInstallBadge.swf","Badge","215","180","9.0.115","#FFFFFF");so.addParam("allowScriptAccess","always");so.useExpressInstall('/flash/expressInstall.swf');so.addVariable("airversion","1.5");so.addVariable("appname","HipChat");so.addVariable("appurl",downloadUrl);so.addVariable("appid",appId);so.addVariable("pubid","87969878BBF1203EC547B61E69990E8273C4626D.1");so.addVariable("appversion","1.1248970628");var escapedEmail=userEmail.replace(/\./g,'  ').replace(/@/g,'   ').replace(/\+/,'    ').replace(/_/g,'     ');so.addVariable("appinstallarg",escapedEmail);so.addVariable("applauncharg",escapedEmail);so.addVariable("hidehelp","true");so.addVariable("skiptransition","false");so.addVariable("titlecolor","#000000");so.addVariable("buttonlabelcolor","#ffffff");so.addVariable("appnamecolor","#ffffff");so.write("flashcontent");}
;/* HipChat: Temp fix for old jQuery UI */
/* http://help.hipchat.com/forums/138883-suggestions/suggestions/3693343-fix-tab-sorting-in-the-web-interface */
/* We should upgrade to jQuery 1.9 and the latest jQuery UI */
jQuery.curCSS = jQuery.css;

/*!
 * jQuery UI 1.8
 *
 * Copyright (c) 2010 AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://docs.jquery.com/UI
 */
/*
 * jQuery UI 1.8
 *
 * Copyright (c) 2010 AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://docs.jquery.com/UI
 */
jQuery.ui||(function(a){a.ui={version:"1.8",plugin:{add:function(c,d,f){var e=a.ui[c].prototype;for(var b in f){e.plugins[b]=e.plugins[b]||[];e.plugins[b].push([d,f[b]])}},call:function(b,d,c){var f=b.plugins[d];if(!f||!b.element[0].parentNode){return}for(var e=0;e<f.length;e++){if(b.options[f[e][0]]){f[e][1].apply(b.element,c)}}}},contains:function(d,c){return document.compareDocumentPosition?d.compareDocumentPosition(c)&16:d!==c&&d.contains(c)},hasScroll:function(e,c){if(a(e).css("overflow")=="hidden"){return false}var b=(c&&c=="left")?"scrollLeft":"scrollTop",d=false;if(e[b]>0){return true}e[b]=1;d=(e[b]>0);e[b]=0;return d},isOverAxis:function(c,b,d){return(c>b)&&(c<(b+d))},isOver:function(g,c,f,e,b,d){return a.ui.isOverAxis(g,f,b)&&a.ui.isOverAxis(c,e,d)},keyCode:{BACKSPACE:8,CAPS_LOCK:20,COMMA:188,CONTROL:17,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38}};a.fn.extend({_focus:a.fn.focus,focus:function(b,c){return typeof b==="number"?this.each(function(){var d=this;setTimeout(function(){a(d).focus();(c&&c.call(d))},b)}):this._focus.apply(this,arguments)},enableSelection:function(){return this.attr("unselectable","off").css("MozUserSelect","").unbind("selectstart.ui")},disableSelection:function(){return this.attr("unselectable","on").css("MozUserSelect","none").bind("selectstart.ui",function(){return false})},scrollParent:function(){var b;if((a.browser.msie&&(/(static|relative)/).test(this.css("position")))||(/absolute/).test(this.css("position"))){b=this.parents().filter(function(){return(/(relative|absolute|fixed)/).test(a.curCSS(this,"position",1))&&(/(auto|scroll)/).test(a.curCSS(this,"overflow",1)+a.curCSS(this,"overflow-y",1)+a.curCSS(this,"overflow-x",1))}).eq(0)}else{b=this.parents().filter(function(){return(/(auto|scroll)/).test(a.curCSS(this,"overflow",1)+a.curCSS(this,"overflow-y",1)+a.curCSS(this,"overflow-x",1))}).eq(0)}return(/fixed/).test(this.css("position"))||!b.length?a(document):b},zIndex:function(e){if(e!==undefined){return this.css("zIndex",e)}if(this.length){var c=a(this[0]),b,d;while(c.length&&c[0]!==document){b=c.css("position");if(b=="absolute"||b=="relative"||b=="fixed"){d=parseInt(c.css("zIndex"));if(!isNaN(d)&&d!=0){return d}}c=c.parent()}}return 0}});a.extend(a.expr[":"],{data:function(d,c,b){return !!a.data(d,b[3])},focusable:function(c){var d=c.nodeName.toLowerCase(),b=a.attr(c,"tabindex");return(/input|select|textarea|button|object/.test(d)?!c.disabled:"a"==d||"area"==d?c.href||!isNaN(b):!isNaN(b))&&!a(c)["area"==d?"parents":"closest"](":hidden").length},tabbable:function(c){var b=a.attr(c,"tabindex");return(isNaN(b)||b>=0)&&a(c).is(":focusable")}})})(jQuery);;/*!
 * jQuery UI Widget 1.8
 *
 * Copyright (c) 2010 AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://docs.jquery.com/UI/Widget
 */
/*
 * jQuery UI Widget 1.8
 *
 * Copyright (c) 2010 AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://docs.jquery.com/UI/Widget
 */
(function(b){var a=b.fn.remove;b.fn.remove=function(c,d){return this.each(function(){if(!d){if(!c||b.filter(c,[this]).length){b("*",this).add(this).each(function(){b(this).triggerHandler("remove")})}}return a.call(b(this),c,d)})};b.widget=function(d,f,c){var e=d.split(".")[0],h;d=d.split(".")[1];h=e+"-"+d;if(!c){c=f;f=b.Widget}b.expr[":"][h]=function(i){return !!b.data(i,d)};b[e]=b[e]||{};b[e][d]=function(i,j){if(arguments.length){this._createWidget(i,j)}};var g=new f();g.options=b.extend({},g.options);b[e][d].prototype=b.extend(true,g,{namespace:e,widgetName:d,widgetEventPrefix:b[e][d].prototype.widgetEventPrefix||d,widgetBaseClass:h},c);b.widget.bridge(d,b[e][d])};b.widget.bridge=function(d,c){b.fn[d]=function(g){var e=typeof g==="string",f=Array.prototype.slice.call(arguments,1),h=this;g=!e&&f.length?b.extend.apply(null,[true,g].concat(f)):g;if(e&&g.substring(0,1)==="_"){return h}if(e){this.each(function(){var i=b.data(this,d),j=i&&b.isFunction(i[g])?i[g].apply(i,f):i;if(j!==i&&j!==undefined){h=j;return false}})}else{this.each(function(){var i=b.data(this,d);if(i){if(g){i.option(g)}i._init()}else{b.data(this,d,new c(g,this))}})}return h}};b.Widget=function(c,d){if(arguments.length){this._createWidget(c,d)}};b.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",options:{disabled:false},_createWidget:function(d,e){this.element=b(e).data(this.widgetName,this);this.options=b.extend(true,{},this.options,b.metadata&&b.metadata.get(e)[this.widgetName],d);var c=this;this.element.bind("remove."+this.widgetName,function(){c.destroy()});this._create();this._init()},_create:function(){},_init:function(){},destroy:function(){this.element.unbind("."+this.widgetName).removeData(this.widgetName);this.widget().unbind("."+this.widgetName).removeAttr("aria-disabled").removeClass(this.widgetBaseClass+"-disabled "+this.namespace+"-state-disabled")},widget:function(){return this.element},option:function(e,f){var d=e,c=this;if(arguments.length===0){return b.extend({},c.options)}if(typeof e==="string"){if(f===undefined){return this.options[e]}d={};d[e]=f}b.each(d,function(g,h){c._setOption(g,h)});return c},_setOption:function(c,d){this.options[c]=d;if(c==="disabled"){this.widget()[d?"addClass":"removeClass"](this.widgetBaseClass+"-disabled "+this.namespace+"-state-disabled").attr("aria-disabled",d)}return this},enable:function(){return this._setOption("disabled",false)},disable:function(){return this._setOption("disabled",true)},_trigger:function(d,e,f){var h=this.options[d];e=b.Event(e);e.type=(d===this.widgetEventPrefix?d:this.widgetEventPrefix+d).toLowerCase();f=f||{};if(e.originalEvent){for(var c=b.event.props.length,g;c;){g=b.event.props[--c];e[g]=e.originalEvent[g]}}this.element.trigger(e,f);return !(b.isFunction(h)&&h.call(this.element[0],e,f)===false||e.isDefaultPrevented())}}})(jQuery);;/*!
 * jQuery UI Mouse 1.8
 *
 * Copyright (c) 2010 AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://docs.jquery.com/UI/Mouse
 *
 * Depends:
 *	jquery.ui.widget.js
 */
/*
 * jQuery UI Mouse 1.8
 *
 * Copyright (c) 2010 AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://docs.jquery.com/UI/Mouse
 *
 * Depends:
 *	jquery.ui.widget.js
 */
(function(a){a.widget("ui.mouse",{options:{cancel:":input,option",distance:1,delay:0},_mouseInit:function(){var b=this;this.element.bind("mousedown."+this.widgetName,function(c){return b._mouseDown(c)}).bind("click."+this.widgetName,function(c){if(b._preventClickEvent){b._preventClickEvent=false;c.stopImmediatePropagation();return false}});this.started=false},_mouseDestroy:function(){this.element.unbind("."+this.widgetName)},_mouseDown:function(d){d.originalEvent=d.originalEvent||{};if(d.originalEvent.mouseHandled){return}(this._mouseStarted&&this._mouseUp(d));this._mouseDownEvent=d;var c=this,e=(d.which==1),b=(typeof this.options.cancel=="string"?a(d.target).parents().add(d.target).filter(this.options.cancel).length:false);if(!e||b||!this._mouseCapture(d)){return true}this.mouseDelayMet=!this.options.delay;if(!this.mouseDelayMet){this._mouseDelayTimer=setTimeout(function(){c.mouseDelayMet=true},this.options.delay)}if(this._mouseDistanceMet(d)&&this._mouseDelayMet(d)){this._mouseStarted=(this._mouseStart(d)!==false);if(!this._mouseStarted){d.preventDefault();return true}}this._mouseMoveDelegate=function(f){return c._mouseMove(f)};this._mouseUpDelegate=function(f){return c._mouseUp(f)};a(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate);(a.browser.safari||d.preventDefault());d.originalEvent.mouseHandled=true;return true},_mouseMove:function(b){if(a.browser.msie&&!b.button){return this._mouseUp(b)}if(this._mouseStarted){this._mouseDrag(b);return b.preventDefault()}if(this._mouseDistanceMet(b)&&this._mouseDelayMet(b)){this._mouseStarted=(this._mouseStart(this._mouseDownEvent,b)!==false);(this._mouseStarted?this._mouseDrag(b):this._mouseUp(b))}return !this._mouseStarted},_mouseUp:function(b){a(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate);if(this._mouseStarted){this._mouseStarted=false;this._preventClickEvent=(b.target==this._mouseDownEvent.target);this._mouseStop(b)}return false},_mouseDistanceMet:function(b){return(Math.max(Math.abs(this._mouseDownEvent.pageX-b.pageX),Math.abs(this._mouseDownEvent.pageY-b.pageY))>=this.options.distance)},_mouseDelayMet:function(b){return this.mouseDelayMet},_mouseStart:function(b){},_mouseDrag:function(b){},_mouseStop:function(b){},_mouseCapture:function(b){return true}})})(jQuery);;/*
 * jQuery UI Position 1.8
 *
 * Copyright (c) 2010 AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://docs.jquery.com/UI/Position
 */
(function(f){f.ui=f.ui||{};var c=/left|center|right/,e="center",d=/top|center|bottom/,g="center",a=f.fn.position,b=f.fn.offset;f.fn.position=function(i){if(!i||!i.of){return a.apply(this,arguments)}i=f.extend({},i);var l=f(i.of),n=(i.collision||"flip").split(" "),m=i.offset?i.offset.split(" "):[0,0],k,h,j;if(i.of.nodeType===9){k=l.width();h=l.height();j={top:0,left:0}}else{if(i.of.scrollTo&&i.of.document){k=l.width();h=l.height();j={top:l.scrollTop(),left:l.scrollLeft()}}else{if(i.of.preventDefault){i.at="left top";k=h=0;j={top:i.of.pageY,left:i.of.pageX}}else{k=l.outerWidth();h=l.outerHeight();j=l.offset()}}}f.each(["my","at"],function(){var o=(i[this]||"").split(" ");if(o.length===1){o=c.test(o[0])?o.concat([g]):d.test(o[0])?[e].concat(o):[e,g]}o[0]=c.test(o[0])?o[0]:e;o[1]=d.test(o[1])?o[1]:g;i[this]=o});if(n.length===1){n[1]=n[0]}m[0]=parseInt(m[0],10)||0;if(m.length===1){m[1]=m[0]}m[1]=parseInt(m[1],10)||0;if(i.at[0]==="right"){j.left+=k}else{if(i.at[0]===e){j.left+=k/2}}if(i.at[1]==="bottom"){j.top+=h}else{if(i.at[1]===g){j.top+=h/2}}j.left+=m[0];j.top+=m[1];return this.each(function(){var r=f(this),q=r.outerWidth(),p=r.outerHeight(),o=f.extend({},j);if(i.my[0]==="right"){o.left-=q}else{if(i.my[0]===e){o.left-=q/2}}if(i.my[1]==="bottom"){o.top-=p}else{if(i.my[1]===g){o.top-=p/2}}f.each(["left","top"],function(t,s){if(f.ui.position[n[t]]){f.ui.position[n[t]][s](o,{targetWidth:k,targetHeight:h,elemWidth:q,elemHeight:p,offset:m,my:i.my,at:i.at})}});if(f.fn.bgiframe){r.bgiframe()}r.offset(f.extend(o,{using:i.using}))})};f.ui.position={fit:{left:function(h,i){var k=f(window),j=h.left+i.elemWidth-k.width()-k.scrollLeft();h.left=j>0?h.left-j:Math.max(0,h.left)},top:function(h,i){var k=f(window),j=h.top+i.elemHeight-k.height()-k.scrollTop();h.top=j>0?h.top-j:Math.max(0,h.top)}},flip:{left:function(i,j){if(j.at[0]==="center"){return}var l=f(window),k=i.left+j.elemWidth-l.width()-l.scrollLeft(),h=j.my[0]==="left"?-j.elemWidth:j.my[0]==="right"?j.elemWidth:0,m=-2*j.offset[0];i.left+=i.left<0?h+j.targetWidth+m:k>0?h-j.targetWidth+m:0},top:function(i,k){if(k.at[1]==="center"){return}var m=f(window),l=i.top+k.elemHeight-m.height()-m.scrollTop(),h=k.my[1]==="top"?-k.elemHeight:k.my[1]==="bottom"?k.elemHeight:0,j=k.at[1]==="top"?k.targetHeight:-k.targetHeight,n=-2*k.offset[1];i.top+=i.top<0?h+k.targetHeight+n:l>0?h+j+n:0}}};if(!f.offset.setOffset){f.offset.setOffset=function(l,i){if(/static/.test(f.curCSS(l,"position"))){l.style.position="relative"}var k=f(l),n=k.offset(),h=parseInt(f.curCSS(l,"top",true),10)||0,m=parseInt(f.curCSS(l,"left",true),10)||0,j={top:(i.top-n.top)+h,left:(i.left-n.left)+m};if("using" in i){i.using.call(l,j)}else{k.css(j)}};f.fn.offset=function(h){var i=this[0];if(!i||!i.ownerDocument){return null}if(h){return this.each(function(){f.offset.setOffset(this,h)})}return b.call(this)}}}(jQuery));;/*
 * jQuery UI Sortable 1.8
 *
 * Copyright (c) 2010 AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://docs.jquery.com/UI/Sortables
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.mouse.js
 *	jquery.ui.widget.js
 */
(function(a){a.widget("ui.sortable",a.ui.mouse,{widgetEventPrefix:"sort",options:{appendTo:"parent",axis:false,connectWith:false,containment:false,cursor:"auto",cursorAt:false,dropOnEmpty:true,forcePlaceholderSize:false,forceHelperSize:false,grid:false,handle:false,helper:"original",items:"> *",opacity:false,placeholder:false,revert:false,scroll:true,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1000},_create:function(){var b=this.options;this.containerCache={};this.element.addClass("ui-sortable");this.refresh();this.floating=this.items.length?(/left|right/).test(this.items[0].item.css("float")):false;this.offset=this.element.offset();this._mouseInit()},destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled").removeData("sortable").unbind(".sortable");this._mouseDestroy();for(var b=this.items.length-1;b>=0;b--){this.items[b].item.removeData("sortable-item")}return this},_mouseCapture:function(e,f){if(this.reverting){return false}if(this.options.disabled||this.options.type=="static"){return false}this._refreshItems(e);var d=null,c=this,b=a(e.target).parents().each(function(){if(a.data(this,"sortable-item")==c){d=a(this);return false}});if(a.data(e.target,"sortable-item")==c){d=a(e.target)}if(!d){return false}if(this.options.handle&&!f){var g=false;a(this.options.handle,d).find("*").andSelf().each(function(){if(this==e.target){g=true}});if(!g){return false}}this.currentItem=d;this._removeCurrentsFromItems();return true},_mouseStart:function(e,f,b){var g=this.options,c=this;this.currentContainer=this;this.refreshPositions();this.helper=this._createHelper(e);this._cacheHelperProportions();this._cacheMargins();this.scrollParent=this.helper.scrollParent();this.offset=this.currentItem.offset();this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left};this.helper.css("position","absolute");this.cssPosition=this.helper.css("position");a.extend(this.offset,{click:{left:e.pageX-this.offset.left,top:e.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()});this.originalPosition=this._generatePosition(e);this.originalPageX=e.pageX;this.originalPageY=e.pageY;(g.cursorAt&&this._adjustOffsetFromHelper(g.cursorAt));this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]};if(this.helper[0]!=this.currentItem[0]){this.currentItem.hide()}this._createPlaceholder();if(g.containment){this._setContainment()}if(g.cursor){if(a("body").css("cursor")){this._storedCursor=a("body").css("cursor")}a("body").css("cursor",g.cursor)}if(g.opacity){if(this.helper.css("opacity")){this._storedOpacity=this.helper.css("opacity")}this.helper.css("opacity",g.opacity)}if(g.zIndex){if(this.helper.css("zIndex")){this._storedZIndex=this.helper.css("zIndex")}this.helper.css("zIndex",g.zIndex)}if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){this.overflowOffset=this.scrollParent.offset()}this._trigger("start",e,this._uiHash());if(!this._preserveHelperProportions){this._cacheHelperProportions()}if(!b){for(var d=this.containers.length-1;d>=0;d--){this.containers[d]._trigger("activate",e,c._uiHash(this))}}if(a.ui.ddmanager){a.ui.ddmanager.current=this}if(a.ui.ddmanager&&!g.dropBehaviour){a.ui.ddmanager.prepareOffsets(this,e)}this.dragging=true;this.helper.addClass("ui-sortable-helper");this._mouseDrag(e);return true},_mouseDrag:function(f){this.position=this._generatePosition(f);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){var g=this.options,b=false;if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-f.pageY<g.scrollSensitivity){this.scrollParent[0].scrollTop=b=this.scrollParent[0].scrollTop+g.scrollSpeed}else{if(f.pageY-this.overflowOffset.top<g.scrollSensitivity){this.scrollParent[0].scrollTop=b=this.scrollParent[0].scrollTop-g.scrollSpeed}}if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-f.pageX<g.scrollSensitivity){this.scrollParent[0].scrollLeft=b=this.scrollParent[0].scrollLeft+g.scrollSpeed}else{if(f.pageX-this.overflowOffset.left<g.scrollSensitivity){this.scrollParent[0].scrollLeft=b=this.scrollParent[0].scrollLeft-g.scrollSpeed}}}else{if(f.pageY-a(document).scrollTop()<g.scrollSensitivity){b=a(document).scrollTop(a(document).scrollTop()-g.scrollSpeed)}else{if(a(window).height()-(f.pageY-a(document).scrollTop())<g.scrollSensitivity){b=a(document).scrollTop(a(document).scrollTop()+g.scrollSpeed)}}if(f.pageX-a(document).scrollLeft()<g.scrollSensitivity){b=a(document).scrollLeft(a(document).scrollLeft()-g.scrollSpeed)}else{if(a(window).width()-(f.pageX-a(document).scrollLeft())<g.scrollSensitivity){b=a(document).scrollLeft(a(document).scrollLeft()+g.scrollSpeed)}}}if(b!==false&&a.ui.ddmanager&&!g.dropBehaviour){a.ui.ddmanager.prepareOffsets(this,f)}}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!="x"){this.helper[0].style.top=this.position.top+"px"}for(var d=this.items.length-1;d>=0;d--){var e=this.items[d],c=e.item[0],h=this._intersectsWithPointer(e);if(!h){continue}if(c!=this.currentItem[0]&&this.placeholder[h==1?"next":"prev"]()[0]!=c&&!a.ui.contains(this.placeholder[0],c)&&(this.options.type=="semi-dynamic"?!a.ui.contains(this.element[0],c):true)){this.direction=h==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(e)){this._rearrange(f,e)}else{break}this._trigger("change",f,this._uiHash());break}}this._contactContainers(f);if(a.ui.ddmanager){a.ui.ddmanager.drag(this,f)}this._trigger("sort",f,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(c,d){if(!c){return}if(a.ui.ddmanager&&!this.options.dropBehaviour){a.ui.ddmanager.drop(this,c)}if(this.options.revert){var b=this;var e=b.placeholder.offset();b.reverting=true;a(this.helper).animate({left:e.left-this.offset.parent.left-b.margins.left+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollLeft),top:e.top-this.offset.parent.top-b.margins.top+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollTop)},parseInt(this.options.revert,10)||500,function(){b._clear(c)})}else{this._clear(c,d)}return false},cancel:function(){var b=this;if(this.dragging){this._mouseUp();if(this.options.helper=="original"){this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else{this.currentItem.show()}for(var c=this.containers.length-1;c>=0;c--){this.containers[c]._trigger("deactivate",null,b._uiHash(this));if(this.containers[c].containerCache.over){this.containers[c]._trigger("out",null,b._uiHash(this));this.containers[c].containerCache.over=0}}}if(this.placeholder[0].parentNode){this.placeholder[0].parentNode.removeChild(this.placeholder[0])}if(this.options.helper!="original"&&this.helper&&this.helper[0].parentNode){this.helper.remove()}a.extend(this,{helper:null,dragging:false,reverting:false,_noFinalSort:null});if(this.domPosition.prev){a(this.domPosition.prev).after(this.currentItem)}else{a(this.domPosition.parent).prepend(this.currentItem)}return this},serialize:function(d){var b=this._getItemsAsjQuery(d&&d.connected);var c=[];d=d||{};a(b).each(function(){var e=(a(d.item||this).attr(d.attribute||"id")||"").match(d.expression||(/(.+)[-=_](.+)/));if(e){c.push((d.key||e[1]+"[]")+"="+(d.key&&d.expression?e[1]:e[2]))}});return c.join("&")},toArray:function(d){var b=this._getItemsAsjQuery(d&&d.connected);var c=[];d=d||{};b.each(function(){c.push(a(d.item||this).attr(d.attribute||"id")||"")});return c},_intersectsWith:function(m){var e=this.positionAbs.left,d=e+this.helperProportions.width,k=this.positionAbs.top,j=k+this.helperProportions.height;var f=m.left,c=f+m.width,n=m.top,i=n+m.height;var o=this.offset.click.top,h=this.offset.click.left;var g=(k+o)>n&&(k+o)<i&&(e+h)>f&&(e+h)<c;if(this.options.tolerance=="pointer"||this.options.forcePointerForContainers||(this.options.tolerance!="pointer"&&this.helperProportions[this.floating?"width":"height"]>m[this.floating?"width":"height"])){return g}else{return(f<e+(this.helperProportions.width/2)&&d-(this.helperProportions.width/2)<c&&n<k+(this.helperProportions.height/2)&&j-(this.helperProportions.height/2)<i)}},_intersectsWithPointer:function(d){var e=a.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,d.top,d.height),c=a.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,d.left,d.width),g=e&&c,b=this._getDragVerticalDirection(),f=this._getDragHorizontalDirection();if(!g){return false}return this.floating?(((f&&f=="right")||b=="down")?2:1):(b&&(b=="down"?2:1))},_intersectsWithSides:function(e){var c=a.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,e.top+(e.height/2),e.height),d=a.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,e.left+(e.width/2),e.width),b=this._getDragVerticalDirection(),f=this._getDragHorizontalDirection();if(this.floating&&f){return((f=="right"&&d)||(f=="left"&&!d))}else{return b&&((b=="down"&&c)||(b=="up"&&!c))}},_getDragVerticalDirection:function(){var b=this.positionAbs.top-this.lastPositionAbs.top;return b!=0&&(b>0?"down":"up")},_getDragHorizontalDirection:function(){var b=this.positionAbs.left-this.lastPositionAbs.left;return b!=0&&(b>0?"right":"left")},refresh:function(b){this._refreshItems(b);this.refreshPositions();return this},_connectWith:function(){var b=this.options;return b.connectWith.constructor==String?[b.connectWith]:b.connectWith},_getItemsAsjQuery:function(b){var l=this;var g=[];var e=[];var h=this._connectWith();if(h&&b){for(var d=h.length-1;d>=0;d--){var k=a(h[d]);for(var c=k.length-1;c>=0;c--){var f=a.data(k[c],"sortable");if(f&&f!=this&&!f.options.disabled){e.push([a.isFunction(f.options.items)?f.options.items.call(f.element):a(f.options.items,f.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),f])}}}}e.push([a.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):a(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);for(var d=e.length-1;d>=0;d--){e[d][0].each(function(){g.push(this)})}return a(g)},_removeCurrentsFromItems:function(){var d=this.currentItem.find(":data(sortable-item)");for(var c=0;c<this.items.length;c++){for(var b=0;b<d.length;b++){if(d[b]==this.items[c].item[0]){this.items.splice(c,1)}}}},_refreshItems:function(b){this.items=[];this.containers=[this];var h=this.items;var p=this;var f=[[a.isFunction(this.options.items)?this.options.items.call(this.element[0],b,{item:this.currentItem}):a(this.options.items,this.element),this]];var l=this._connectWith();if(l){for(var e=l.length-1;e>=0;e--){var m=a(l[e]);for(var d=m.length-1;d>=0;d--){var g=a.data(m[d],"sortable");if(g&&g!=this&&!g.options.disabled){f.push([a.isFunction(g.options.items)?g.options.items.call(g.element[0],b,{item:this.currentItem}):a(g.options.items,g.element),g]);this.containers.push(g)}}}}for(var e=f.length-1;e>=0;e--){var k=f[e][1];var c=f[e][0];for(var d=0,n=c.length;d<n;d++){var o=a(c[d]);o.data("sortable-item",k);h.push({item:o,instance:k,width:0,height:0,left:0,top:0})}}},refreshPositions:function(b){if(this.offsetParent&&this.helper){this.offset.parent=this._getParentOffset()}for(var d=this.items.length-1;d>=0;d--){var e=this.items[d];var c=this.options.toleranceElement?a(this.options.toleranceElement,e.item):e.item;if(!b){e.width=c.outerWidth();e.height=c.outerHeight()}var f=c.offset();e.left=f.left;e.top=f.top}if(this.options.custom&&this.options.custom.refreshContainers){this.options.custom.refreshContainers.call(this)}else{for(var d=this.containers.length-1;d>=0;d--){var f=this.containers[d].element.offset();this.containers[d].containerCache.left=f.left;this.containers[d].containerCache.top=f.top;this.containers[d].containerCache.width=this.containers[d].element.outerWidth();this.containers[d].containerCache.height=this.containers[d].element.outerHeight()}}return this},_createPlaceholder:function(d){var b=d||this,e=b.options;if(!e.placeholder||e.placeholder.constructor==String){var c=e.placeholder;e.placeholder={element:function(){var f=a(document.createElement(b.currentItem[0].nodeName)).addClass(c||b.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper")[0];if(!c){f.style.visibility="hidden"}return f},update:function(f,g){if(c&&!e.forcePlaceholderSize){return}if(!g.height()){g.height(b.currentItem.innerHeight()-parseInt(b.currentItem.css("paddingTop")||0,10)-parseInt(b.currentItem.css("paddingBottom")||0,10))}if(!g.width()){g.width(b.currentItem.innerWidth()-parseInt(b.currentItem.css("paddingLeft")||0,10)-parseInt(b.currentItem.css("paddingRight")||0,10))}}}}b.placeholder=a(e.placeholder.element.call(b.element,b.currentItem));b.currentItem.after(b.placeholder);e.placeholder.update(b,b.placeholder)},_contactContainers:function(b){var d=null,k=null;for(var f=this.containers.length-1;f>=0;f--){if(a.ui.contains(this.currentItem[0],this.containers[f].element[0])){continue}if(this._intersectsWith(this.containers[f].containerCache)){if(d&&a.ui.contains(this.containers[f].element[0],d.element[0])){continue}d=this.containers[f];k=f}else{if(this.containers[f].containerCache.over){this.containers[f]._trigger("out",b,this._uiHash(this));this.containers[f].containerCache.over=0}}}if(!d){return}if(this.containers.length===1){this.containers[k]._trigger("over",b,this._uiHash(this));this.containers[k].containerCache.over=1}else{if(this.currentContainer!=this.containers[k]){var h=10000;var g=null;var c=this.positionAbs[this.containers[k].floating?"left":"top"];for(var e=this.items.length-1;e>=0;e--){if(!a.ui.contains(this.containers[k].element[0],this.items[e].item[0])){continue}var l=this.items[e][this.containers[k].floating?"left":"top"];if(Math.abs(l-c)<h){h=Math.abs(l-c);g=this.items[e]}}if(!g&&!this.options.dropOnEmpty){return}this.currentContainer=this.containers[k];g?this._rearrange(b,g,null,true):this._rearrange(b,null,this.containers[k].element,true);this._trigger("change",b,this._uiHash());this.containers[k]._trigger("change",b,this._uiHash(this));this.options.placeholder.update(this.currentContainer,this.placeholder);this.containers[k]._trigger("over",b,this._uiHash(this));this.containers[k].containerCache.over=1}}},_createHelper:function(c){var d=this.options;var b=a.isFunction(d.helper)?a(d.helper.apply(this.element[0],[c,this.currentItem])):(d.helper=="clone"?this.currentItem.clone():this.currentItem);if(!b.parents("body").length){a(d.appendTo!="parent"?d.appendTo:this.currentItem[0].parentNode)[0].appendChild(b[0])}if(b[0]==this.currentItem[0]){this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}}if(b[0].style.width==""||d.forceHelperSize){b.width(this.currentItem.width())}if(b[0].style.height==""||d.forceHelperSize){b.height(this.currentItem.height())}return b},_adjustOffsetFromHelper:function(b){if(typeof b=="string"){b=b.split(" ")}if(a.isArray(b)){b={left:+b[0],top:+b[1]||0}}if("left" in b){this.offset.click.left=b.left+this.margins.left}if("right" in b){this.offset.click.left=this.helperProportions.width-b.right+this.margins.left}if("top" in b){this.offset.click.top=b.top+this.margins.top}if("bottom" in b){this.offset.click.top=this.helperProportions.height-b.bottom+this.margins.top}},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var b=this.offsetParent.offset();if(this.cssPosition=="absolute"&&this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0])){b.left+=this.scrollParent.scrollLeft();b.top+=this.scrollParent.scrollTop()}if((this.offsetParent[0]==document.body)||(this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()=="html"&&a.browser.msie)){b={top:0,left:0}}return{top:b.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:b.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if(this.cssPosition=="relative"){var b=this.currentItem.position();return{top:b.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:b.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}else{return{top:0,left:0}}},_cacheMargins:function(){this.margins={left:(parseInt(this.currentItem.css("marginLeft"),10)||0),top:(parseInt(this.currentItem.css("marginTop"),10)||0)}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var e=this.options;if(e.containment=="parent"){e.containment=this.helper[0].parentNode}if(e.containment=="document"||e.containment=="window"){this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,a(e.containment=="document"?document:window).width()-this.helperProportions.width-this.margins.left,(a(e.containment=="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]}if(!(/^(document|window|parent)$/).test(e.containment)){var c=a(e.containment)[0];var d=a(e.containment).offset();var b=(a(c).css("overflow")!="hidden");this.containment=[d.left+(parseInt(a(c).css("borderLeftWidth"),10)||0)+(parseInt(a(c).css("paddingLeft"),10)||0)-this.margins.left,d.top+(parseInt(a(c).css("borderTopWidth"),10)||0)+(parseInt(a(c).css("paddingTop"),10)||0)-this.margins.top,d.left+(b?Math.max(c.scrollWidth,c.offsetWidth):c.offsetWidth)-(parseInt(a(c).css("borderLeftWidth"),10)||0)-(parseInt(a(c).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,d.top+(b?Math.max(c.scrollHeight,c.offsetHeight):c.offsetHeight)-(parseInt(a(c).css("borderTopWidth"),10)||0)-(parseInt(a(c).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]}},_convertPositionTo:function(f,h){if(!h){h=this.position}var c=f=="absolute"?1:-1;var e=this.options,b=this.cssPosition=="absolute"&&!(this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,g=(/(html|body)/i).test(b[0].tagName);return{top:(h.top+this.offset.relative.top*c+this.offset.parent.top*c-(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():(g?0:b.scrollTop()))*c)),left:(h.left+this.offset.relative.left*c+this.offset.parent.left*c-(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():g?0:b.scrollLeft())*c))}},_generatePosition:function(e){var h=this.options,b=this.cssPosition=="absolute"&&!(this.scrollParent[0]!=document&&a.ui.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,i=(/(html|body)/i).test(b[0].tagName);if(this.cssPosition=="relative"&&!(this.scrollParent[0]!=document&&this.scrollParent[0]!=this.offsetParent[0])){this.offset.relative=this._getRelativeOffset()}var d=e.pageX;var c=e.pageY;if(this.originalPosition){if(this.containment){if(e.pageX-this.offset.click.left<this.containment[0]){d=this.containment[0]+this.offset.click.left}if(e.pageY-this.offset.click.top<this.containment[1]){c=this.containment[1]+this.offset.click.top}if(e.pageX-this.offset.click.left>this.containment[2]){d=this.containment[2]+this.offset.click.left}if(e.pageY-this.offset.click.top>this.containment[3]){c=this.containment[3]+this.offset.click.top}}if(h.grid){var g=this.originalPageY+Math.round((c-this.originalPageY)/h.grid[1])*h.grid[1];c=this.containment?(!(g-this.offset.click.top<this.containment[1]||g-this.offset.click.top>this.containment[3])?g:(!(g-this.offset.click.top<this.containment[1])?g-h.grid[1]:g+h.grid[1])):g;var f=this.originalPageX+Math.round((d-this.originalPageX)/h.grid[0])*h.grid[0];d=this.containment?(!(f-this.offset.click.left<this.containment[0]||f-this.offset.click.left>this.containment[2])?f:(!(f-this.offset.click.left<this.containment[0])?f-h.grid[0]:f+h.grid[0])):f}}return{top:(c-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():(i?0:b.scrollTop())))),left:(d-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(a.browser.safari&&this.cssPosition=="fixed"?0:(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():i?0:b.scrollLeft())))}},_rearrange:function(g,f,c,e){c?c[0].appendChild(this.placeholder[0]):f.item[0].parentNode.insertBefore(this.placeholder[0],(this.direction=="down"?f.item[0]:f.item[0].nextSibling));this.counter=this.counter?++this.counter:1;var d=this,b=this.counter;window.setTimeout(function(){if(b==d.counter){d.refreshPositions(!e)}},0)},_clear:function(d,e){this.reverting=false;var f=[],b=this;if(!this._noFinalSort&&this.currentItem[0].parentNode){this.placeholder.before(this.currentItem)}this._noFinalSort=null;if(this.helper[0]==this.currentItem[0]){for(var c in this._storedCSS){if(this._storedCSS[c]=="auto"||this._storedCSS[c]=="static"){this._storedCSS[c]=""}}this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else{this.currentItem.show()}if(this.fromOutside&&!e){f.push(function(g){this._trigger("receive",g,this._uiHash(this.fromOutside))})}if((this.fromOutside||this.domPosition.prev!=this.currentItem.prev().not(".ui-sortable-helper")[0]||this.domPosition.parent!=this.currentItem.parent()[0])&&!e){f.push(function(g){this._trigger("update",g,this._uiHash())})}if(!a.ui.contains(this.element[0],this.currentItem[0])){if(!e){f.push(function(g){this._trigger("remove",g,this._uiHash())})}for(var c=this.containers.length-1;c>=0;c--){if(a.ui.contains(this.containers[c].element[0],this.currentItem[0])&&!e){f.push((function(g){return function(h){g._trigger("receive",h,this._uiHash(this))}}).call(this,this.containers[c]));f.push((function(g){return function(h){g._trigger("update",h,this._uiHash(this))}}).call(this,this.containers[c]))}}}for(var c=this.containers.length-1;c>=0;c--){if(!e){f.push((function(g){return function(h){g._trigger("deactivate",h,this._uiHash(this))}}).call(this,this.containers[c]))}if(this.containers[c].containerCache.over){f.push((function(g){return function(h){g._trigger("out",h,this._uiHash(this))}}).call(this,this.containers[c]));this.containers[c].containerCache.over=0}}if(this._storedCursor){a("body").css("cursor",this._storedCursor)}if(this._storedOpacity){this.helper.css("opacity",this._storedOpacity)}if(this._storedZIndex){this.helper.css("zIndex",this._storedZIndex=="auto"?"":this._storedZIndex)}this.dragging=false;if(this.cancelHelperRemoval){if(!e){this._trigger("beforeStop",d,this._uiHash());for(var c=0;c<f.length;c++){f[c].call(this,d)}this._trigger("stop",d,this._uiHash())}return false}if(!e){this._trigger("beforeStop",d,this._uiHash())}this.placeholder[0].parentNode.removeChild(this.placeholder[0]);if(this.helper[0]!=this.currentItem[0]){this.helper.remove()}this.helper=null;if(!e){for(var c=0;c<f.length;c++){f[c].call(this,d)}this._trigger("stop",d,this._uiHash())}this.fromOutside=false;return true},_trigger:function(){if(a.Widget.prototype._trigger.apply(this,arguments)===false){this.cancel()}},_uiHash:function(c){var b=c||this;return{helper:b.helper,placeholder:b.placeholder||a([]),position:b.position,originalPosition:b.originalPosition,offset:b.positionAbs,item:b.currentItem,sender:c?c.element:null}}});a.extend(a.ui.sortable,{version:"1.8"})})(jQuery);;/*
 * jQuery UI Dialog 1.8
 *
 * Copyright (c) 2010 AUTHORS.txt (http://jqueryui.com/about)
 * Dual licensed under the MIT (MIT-LICENSE.txt)
 * and GPL (GPL-LICENSE.txt) licenses.
 *
 * http://docs.jquery.com/UI/Dialog
 *
 * Depends:
 *	jquery.ui.core.js
 *	jquery.ui.widget.js
 *  jquery.ui.button.js
 *	jquery.ui.draggable.js
 *	jquery.ui.mouse.js
 *	jquery.ui.position.js
 *	jquery.ui.resizable.js
 */
(function(b){var a="ui-dialog ui-widget ui-widget-content ui-corner-all ";b.widget("ui.dialog",{options:{autoOpen:true,buttons:{},closeOnEscape:true,closeText:"close",dialogClass:"",draggable:true,hide:null,height:"auto",maxHeight:false,maxWidth:false,minHeight:150,minWidth:150,modal:false,position:"center",resizable:true,show:null,stack:true,title:"",width:300,zIndex:1000},_create:function(){this.originalTitle=this.element.attr("title");var k=this,l=k.options,i=l.title||k.originalTitle||"&#160;",d=b.ui.dialog.getTitleId(k.element),j=(k.uiDialog=b("<div></div>")).appendTo(document.body).hide().addClass(a+l.dialogClass).css({zIndex:l.zIndex}).attr("tabIndex",-1).css("outline",0).keydown(function(m){if(l.closeOnEscape&&m.keyCode&&m.keyCode===b.ui.keyCode.ESCAPE){k.close(m);m.preventDefault()}}).attr({role:"dialog","aria-labelledby":d}).mousedown(function(m){k.moveToTop(false,m)}),f=k.element.show().removeAttr("title").addClass("ui-dialog-content ui-widget-content").appendTo(j),e=(k.uiDialogTitlebar=b("<div></div>")).addClass("ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix").prependTo(j),h=b('<a href="#"></a>').addClass("ui-dialog-titlebar-close ui-corner-all").attr("role","button").hover(function(){h.addClass("ui-state-hover")},function(){h.removeClass("ui-state-hover")}).focus(function(){h.addClass("ui-state-focus")}).blur(function(){h.removeClass("ui-state-focus")}).click(function(m){k.close(m);return false}).appendTo(e),g=(k.uiDialogTitlebarCloseText=b("<span></span>")).addClass("ui-icon ui-icon-closethick").text(l.closeText).appendTo(h),c=b("<span></span>").addClass("ui-dialog-title").attr("id",d).html(i).prependTo(e);if(b.isFunction(l.beforeclose)&&!b.isFunction(l.beforeClose)){l.beforeClose=l.beforeclose}e.find("*").add(e).disableSelection();if(l.draggable&&b.fn.draggable){k._makeDraggable()}if(l.resizable&&b.fn.resizable){k._makeResizable()}k._createButtons(l.buttons);k._isOpen=false;if(b.fn.bgiframe){j.bgiframe()}},_init:function(){if(this.options.autoOpen){this.open()}},destroy:function(){var c=this;if(c.overlay){c.overlay.destroy()}c.uiDialog.hide();c.element.unbind(".dialog").removeData("dialog").removeClass("ui-dialog-content ui-widget-content").hide().appendTo("body");c.uiDialog.remove();if(c.originalTitle){c.element.attr("title",c.originalTitle)}return c},widget:function(){return this.uiDialog},close:function(e){var c=this,d;if(false===c._trigger("beforeClose",e)){return}if(c.overlay){c.overlay.destroy()}c.uiDialog.unbind("keypress.ui-dialog");c._isOpen=false;if(c.options.hide){c.uiDialog.hide(c.options.hide,function(){c._trigger("close",e)})}else{c.uiDialog.hide();c._trigger("close",e)}b.ui.dialog.overlay.resize();if(c.options.modal){d=0;b(".ui-dialog").each(function(){if(this!==c.uiDialog[0]){d=Math.max(d,b(this).css("z-index"))}});b.ui.dialog.maxZ=d}return c},isOpen:function(){return this._isOpen},moveToTop:function(g,f){var c=this,e=c.options,d;if((e.modal&&!g)||(!e.stack&&!e.modal)){return c._trigger("focus",f)}if(e.zIndex>b.ui.dialog.maxZ){b.ui.dialog.maxZ=e.zIndex}if(c.overlay){b.ui.dialog.maxZ+=1;c.overlay.$el.css("z-index",b.ui.dialog.overlay.maxZ=b.ui.dialog.maxZ)}d={scrollTop:c.element.attr("scrollTop"),scrollLeft:c.element.attr("scrollLeft")};b.ui.dialog.maxZ+=1;c.uiDialog.css("z-index",b.ui.dialog.maxZ);c.element.attr(d);c._trigger("focus",f);return c},open:function(){if(this._isOpen){return}var d=this,e=d.options,c=d.uiDialog;d.overlay=e.modal?new b.ui.dialog.overlay(d):null;if(c.next().length){c.appendTo("body")}d._size();d._position(e.position);c.show(e.show);d.moveToTop(true);if(e.modal){c.bind("keypress.ui-dialog",function(h){if(h.keyCode!==b.ui.keyCode.TAB){return}var g=b(":tabbable",this),i=g.filter(":first"),f=g.filter(":last");if(h.target===f[0]&&!h.shiftKey){i.focus(1);return false}else{if(h.target===i[0]&&h.shiftKey){f.focus(1);return false}}})}b([]).add(c.find(".ui-dialog-content :tabbable:first")).add(c.find(".ui-dialog-buttonpane :tabbable:first")).add(c).filter(":first").focus();d._trigger("open");d._isOpen=true;return d},_createButtons:function(f){var e=this,c=false,d=b("<div></div>").addClass("ui-dialog-buttonpane ui-widget-content ui-helper-clearfix");e.uiDialog.find(".ui-dialog-buttonpane").remove();if(typeof f==="object"&&f!==null){b.each(f,function(){return !(c=true)})}if(c){b.each(f,function(g,i){var h=b('<button type="button"></button>').text(g).click(function(){i.apply(e.element[0],arguments)}).appendTo(d);if(b.fn.button){h.button()}});d.appendTo(e.uiDialog)}},_makeDraggable:function(){var c=this,f=c.options,g=b(document),e;function d(h){return{position:h.position,offset:h.offset}}c.uiDialog.draggable({cancel:".ui-dialog-content, .ui-dialog-titlebar-close",handle:".ui-dialog-titlebar",containment:"document",start:function(h,i){e=f.height==="auto"?"auto":b(this).height();b(this).height(b(this).height()).addClass("ui-dialog-dragging");c._trigger("dragStart",h,d(i))},drag:function(h,i){c._trigger("drag",h,d(i))},stop:function(h,i){f.position=[i.position.left-g.scrollLeft(),i.position.top-g.scrollTop()];b(this).removeClass("ui-dialog-dragging").height(e);c._trigger("dragStop",h,d(i));b.ui.dialog.overlay.resize()}})},_makeResizable:function(h){h=(h===undefined?this.options.resizable:h);var d=this,g=d.options,c=d.uiDialog.css("position"),f=(typeof h==="string"?h:"n,e,s,w,se,sw,ne,nw");function e(i){return{originalPosition:i.originalPosition,originalSize:i.originalSize,position:i.position,size:i.size}}d.uiDialog.resizable({cancel:".ui-dialog-content",containment:"document",alsoResize:d.element,maxWidth:g.maxWidth,maxHeight:g.maxHeight,minWidth:g.minWidth,minHeight:d._minHeight(),handles:f,start:function(i,j){b(this).addClass("ui-dialog-resizing");d._trigger("resizeStart",i,e(j))},resize:function(i,j){d._trigger("resize",i,e(j))},stop:function(i,j){b(this).removeClass("ui-dialog-resizing");g.height=b(this).height();g.width=b(this).width();d._trigger("resizeStop",i,e(j));b.ui.dialog.overlay.resize()}}).css("position",c).find(".ui-resizable-se").addClass("ui-icon ui-icon-grip-diagonal-se")},_minHeight:function(){var c=this.options;if(c.height==="auto"){return c.minHeight}else{return Math.min(c.minHeight,c.height)}},_position:function(d){var e=[],f=[0,0],c;d=d||b.ui.dialog.prototype.options.position;if(typeof d==="string"||(typeof d==="object"&&"0" in d)){e=d.split?d.split(" "):[d[0],d[1]];if(e.length===1){e[1]=e[0]}b.each(["left","top"],function(h,g){if(+e[h]===e[h]){f[h]=e[h];e[h]=g}})}else{if(typeof d==="object"){if("left" in d){e[0]="left";f[0]=d.left}else{if("right" in d){e[0]="right";f[0]=-d.right}}if("top" in d){e[1]="top";f[1]=d.top}else{if("bottom" in d){e[1]="bottom";f[1]=-d.bottom}}}}c=this.uiDialog.is(":visible");if(!c){this.uiDialog.show()}this.uiDialog.css({top:0,left:0}).position({my:e.join(" "),at:e.join(" "),offset:f.join(" "),of:window,collision:"fit",using:function(h){var g=b(this).css(h).offset().top;if(g<0){b(this).css("top",h.top-g)}}});if(!c){this.uiDialog.hide()}},_setOption:function(f,g){var d=this,c=d.uiDialog,h=c.is(":data(resizable)"),e=false;switch(f){case"beforeclose":f="beforeClose";break;case"buttons":d._createButtons(g);break;case"closeText":d.uiDialogTitlebarCloseText.text(""+g);break;case"dialogClass":c.removeClass(d.options.dialogClass).addClass(a+g);break;case"disabled":if(g){c.addClass("ui-dialog-disabled")}else{c.removeClass("ui-dialog-disabled")}break;case"draggable":if(g){d._makeDraggable()}else{c.draggable("destroy")}break;case"height":e=true;break;case"maxHeight":if(h){c.resizable("option","maxHeight",g)}e=true;break;case"maxWidth":if(h){c.resizable("option","maxWidth",g)}e=true;break;case"minHeight":if(h){c.resizable("option","minHeight",g)}e=true;break;case"minWidth":if(h){c.resizable("option","minWidth",g)}e=true;break;case"position":d._position(g);break;case"resizable":if(h&&!g){c.resizable("destroy")}if(h&&typeof g==="string"){c.resizable("option","handles",g)}if(!h&&g!==false){d._makeResizable(g)}break;case"title":b(".ui-dialog-title",d.uiDialogTitlebar).html(""+(g||"&#160;"));break;case"width":e=true;break}b.Widget.prototype._setOption.apply(d,arguments);if(e){d._size()}},_size:function(){var d=this.options,c;this.element.css("width","auto").hide();c=this.uiDialog.css({height:"auto",width:d.width}).height();this.element.css(d.height==="auto"?{minHeight:Math.max(d.minHeight-c,0),height:"auto"}:{minHeight:0,height:Math.max(d.height-c,0)}).show();if(this.uiDialog.is(":data(resizable)")){this.uiDialog.resizable("option","minHeight",this._minHeight())}}});b.extend(b.ui.dialog,{version:"1.8",uuid:0,maxZ:0,getTitleId:function(c){var d=c.attr("id");if(!d){this.uuid+=1;d=this.uuid}return"ui-dialog-title-"+d},overlay:function(c){this.$el=b.ui.dialog.overlay.create(c)}});b.extend(b.ui.dialog.overlay,{instances:[],oldInstances:[],maxZ:0,events:b.map("focus,mousedown,mouseup,keydown,keypress,click".split(","),function(c){return c+".dialog-overlay"}).join(" "),create:function(d){if(this.instances.length===0){setTimeout(function(){if(b.ui.dialog.overlay.instances.length){b(document).bind(b.ui.dialog.overlay.events,function(e){return(b(e.target).zIndex()>=b.ui.dialog.overlay.maxZ)})}},1);b(document).bind("keydown.dialog-overlay",function(e){if(d.options.closeOnEscape&&e.keyCode&&e.keyCode===b.ui.keyCode.ESCAPE){d.close(e);e.preventDefault()}});b(window).bind("resize.dialog-overlay",b.ui.dialog.overlay.resize)}var c=(this.oldInstances.pop()||b("<div></div>").addClass("ui-widget-overlay")).appendTo(document.body).css({width:this.width(),height:this.height()});if(b.fn.bgiframe){c.bgiframe()}this.instances.push(c);return c},destroy:function(c){this.oldInstances.push(this.instances.splice(b.inArray(c,this.instances),1)[0]);if(this.instances.length===0){b([document,window]).unbind(".dialog-overlay")}c.remove();var d=0;b.each(this.instances,function(){d=Math.max(d,this.css("z-index"))});this.maxZ=d},height:function(){var d,c;if(b.browser.msie&&b.browser.version<7){d=Math.max(document.documentElement.scrollHeight,document.body.scrollHeight);c=Math.max(document.documentElement.offsetHeight,document.body.offsetHeight);if(d<c){return b(window).height()+"px"}else{return d+"px"}}else{return b(document).height()+"px"}},width:function(){var c,d;if(b.browser.msie&&b.browser.version<7){c=Math.max(document.documentElement.scrollWidth,document.body.scrollWidth);d=Math.max(document.documentElement.offsetWidth,document.body.offsetWidth);if(c<d){return b(window).width()+"px"}else{return c+"px"}}else{return b(document).width()+"px"}},resize:function(){var c=b([]);b.each(b.ui.dialog.overlay.instances,function(){c=c.add(this)});c.css({width:0,height:0}).css({width:b.ui.dialog.overlay.width(),height:b.ui.dialog.overlay.height()})}});b.extend(b.ui.dialog.overlay.prototype,{destroy:function(){b.ui.dialog.overlay.destroy(this.$el)}})}(jQuery));;
;(function(){function log(){if(typeof(console)!='undefined'&&typeof(console.log)=='function'){Array.prototype.unshift.call(arguments,'[Ajax Upload]');console.log(Array.prototype.join.call(arguments,' '));}}
function addEvent(el,type,fn){if(el.addEventListener){el.addEventListener(type,fn,false);}else if(el.attachEvent){el.attachEvent('on'+type,function(){fn.call(el);});}else{throw new Error('not supported or DOM not loaded');}}
function addResizeEvent(fn){var timeout;addEvent(window,'resize',function(){if(timeout){clearTimeout(timeout);}
timeout=setTimeout(fn,100);});}
if(document.documentElement.getBoundingClientRect){var getOffset=function(el){var box=el.getBoundingClientRect();var doc=el.ownerDocument;var body=doc.body;var docElem=doc.documentElement;var clientTop=docElem.clientTop||body.clientTop||0;var clientLeft=docElem.clientLeft||body.clientLeft||0;var zoom=1;if(body.getBoundingClientRect){var bound=body.getBoundingClientRect();zoom=(bound.right-bound.left)/body.clientWidth;}
if(zoom>1){clientTop=0;clientLeft=0;}
var top=box.top/zoom+(window.pageYOffset||docElem&&docElem.scrollTop/zoom||body.scrollTop/zoom)-clientTop,left=box.left/zoom+(window.pageXOffset||docElem&&docElem.scrollLeft/zoom||body.scrollLeft/zoom)-clientLeft;return{top:top,left:left};};}else{var getOffset=function(el){var top=0,left=0;do{top+=el.offsetTop||0;left+=el.offsetLeft||0;el=el.offsetParent;}while(el);return{left:left,top:top};};}
function getBox(el){var left,right,top,bottom;var offset=getOffset(el);left=offset.left;top=offset.top;right=left+el.offsetWidth;bottom=top+el.offsetHeight;return{left:left,right:right,top:top,bottom:bottom};}
function addStyles(el,styles){for(var name in styles){if(styles.hasOwnProperty(name)){el.style[name]=styles[name];}}}
function copyLayout(from,to){var box=getBox(from);addStyles(to,{position:'absolute',left:box.left+'px',top:box.top+'px',width:from.offsetWidth+'px',height:from.offsetHeight+'px'});}
var toElement=(function(){var div=document.createElement('div');return function(html){div.innerHTML=html;var el=div.firstChild;return div.removeChild(el);};})();var getUID=(function(){var id=0;return function(){return'ValumsAjaxUpload'+id++;};})();function fileFromPath(file){return file.replace(/.*(\/|\\)/,"");}
function getExt(file){return(-1!==file.indexOf('.'))?file.replace(/.*[.]/,''):'';}
function hasClass(el,name){var re=new RegExp('\\b'+name+'\\b');return re.test(el.className);}
function addClass(el,name){if(!hasClass(el,name)){el.className+=' '+name;}}
function removeClass(el,name){var re=new RegExp('\\b'+name+'\\b');el.className=el.className.replace(re,'');}
function removeNode(el){el.parentNode.removeChild(el);}
window.AjaxUpload=function(button,options){this._settings={action:'upload.php',name:'userfile',data:{},autoSubmit:true,responseType:false,hoverClass:'hover',disabledClass:'disabled',onChange:function(file,extension){},onSubmit:function(file,extension){},onComplete:function(file,response){}};for(var i in options){if(options.hasOwnProperty(i)){this._settings[i]=options[i];}}
if(button.jquery){button=button[0];}else if(typeof button=="string"){if(/^#.*/.test(button)){button=button.slice(1);}
button=document.getElementById(button);}
if(!button||button.nodeType!==1){throw new Error("Please make sure that you're passing a valid element");}
if(button.nodeName.toUpperCase()=='A'){addEvent(button,'click',function(e){if(e&&e.preventDefault){e.preventDefault();}else if(window.event){window.event.returnValue=false;}});}
this._button=button;this._input=null;this._disabled=false;this.enable();this._rerouteClicks();};AjaxUpload.prototype={setData:function(data){this._settings.data=data;},disable:function(){addClass(this._button,this._settings.disabledClass);this._disabled=true;var nodeName=this._button.nodeName.toUpperCase();if(nodeName=='INPUT'||nodeName=='BUTTON'){this._button.setAttribute('disabled','disabled');}
if(this._input){this._input.parentNode.style.visibility='hidden';}},enable:function(){removeClass(this._button,this._settings.disabledClass);this._button.removeAttribute('disabled');this._disabled=false;},_createInput:function(){var self=this;var input=document.createElement("input");input.setAttribute('type','file');input.setAttribute('name',this._settings.name);addStyles(input,{'position':'absolute','right':0,'margin':0,'padding':0,'fontSize':'480px','cursor':'pointer'});var div=document.createElement("div");addStyles(div,{'display':'block','position':'absolute','overflow':'hidden','margin':0,'padding':0,'opacity':0,'direction':'ltr','zIndex':2147483583});if(div.style.opacity!=="0"){if(typeof(div.filters)=='undefined'){throw new Error('Opacity not supported by the browser');}
div.style.filter="alpha(opacity=0)";}
addEvent(input,'change',function(){if(!input||input.value===''){return;}
var file=fileFromPath(input.value);if(false===self._settings.onChange.call(self,file,getExt(file))){self._clearInput();return;}
if(self._settings.autoSubmit){self.submit();}});addEvent(input,'mouseover',function(){addClass(self._button,self._settings.hoverClass);});addEvent(input,'mouseout',function(){removeClass(self._button,self._settings.hoverClass);input.parentNode.style.visibility='hidden';});div.appendChild(input);document.body.appendChild(div);this._input=input;},_clearInput:function(){if(!this._input){return;}
removeNode(this._input.parentNode);this._input=null;this._createInput();removeClass(this._button,this._settings.hoverClass);},_rerouteClicks:function(){var self=this;addEvent(self._button,'mouseover',function(){if(self._disabled){return;}
if(!self._input){self._createInput();}
var div=self._input.parentNode;copyLayout(self._button,div);div.style.visibility='visible';});},_createIframe:function(){var id=getUID();var iframe=toElement('<iframe src="javascript:false;" name="'+id+'" />');iframe.setAttribute('id',id);iframe.style.display='none';document.body.appendChild(iframe);return iframe;},_createForm:function(iframe){var settings=this._settings;var form=toElement('<form method="post" enctype="multipart/form-data"></form>');form.setAttribute('action',settings.action);form.setAttribute('target',iframe.name);form.style.display='none';document.body.appendChild(form);for(var prop in settings.data){if(settings.data.hasOwnProperty(prop)){var el=document.createElement("input");el.setAttribute('type','hidden');el.setAttribute('name',prop);el.setAttribute('value',settings.data[prop]);form.appendChild(el);}}
return form;},_getResponse:function(iframe,file){var toDeleteFlag=false,self=this,settings=this._settings;addEvent(iframe,'load',function(){if(iframe.src=="javascript:'%3Chtml%3E%3C/html%3E';"||iframe.src=="javascript:'<html></html>';"){if(toDeleteFlag){setTimeout(function(){removeNode(iframe);},0);}
return;}
var doc=iframe.contentDocument?iframe.contentDocument:window.frames[iframe.id].document;if(doc.readyState&&doc.readyState!='complete'){return;}
if(doc.body&&doc.body.innerHTML=="false"){return;}
var response;if(doc.XMLDocument){response=doc.XMLDocument;}else if(doc.body){response=doc.body.innerHTML;if(settings.responseType&&settings.responseType.toLowerCase()=='json'){if(doc.body.firstChild&&doc.body.firstChild.nodeName.toUpperCase()=='PRE'){response=doc.body.firstChild.firstChild.nodeValue;}
if(response){response=eval("("+response+")");}else{response={};}}}else{response=doc;}
settings.onComplete.call(self,file,response);toDeleteFlag=true;iframe.src="javascript:'<html></html>';";});},submit:function(){var self=this,settings=this._settings;if(!this._input||this._input.value===''){return;}
var file=fileFromPath(this._input.value);if(false===settings.onSubmit.call(this,file,getExt(file))){this._clearInput();return;}
var iframe=this._createIframe();var form=this._createForm(iframe);removeNode(this._input.parentNode);removeClass(self._button,self._settings.hoverClass);form.appendChild(this._input);form.submit();removeNode(form);form=null;removeNode(this._input);this._input=null;this._getResponse(iframe,file);this._createInput();}};})();;function Menu(){this.menu_node=$(document.createElement('div'));this.option_list=$(document.createElement('ul'));this.menu_node.addClass('menu');this.menu_node.append(this.option_list);this.menu_node.hide();this.menu_node.css('position','absolute');this.source_node=null;$('body').append(this.menu_node);}
Menu.prototype={add_option:function(name,text,func){this.option_list.find('li[name="'+name+'"]').remove();var opt=$(document.createElement('li'));opt.attr('name',name);opt.html(text);opt.mousedown(func).mouseover(function(){$(this).addClass('hover');}).mouseout(function(){$(this).removeClass('hover');});this.option_list.append(opt);},add_separator:function(after_option){var separator=$(document.createElement('li'));separator.css('padding','0');separator.css('margin','0 3px');separator.html('<hr />');if(after_option){this.option_list.find('li[name="'+after_option+'"]').after(separator);}else{this.option_list.append(separator);}},hide:function(){this.menu_node.hide();},remove_all_options:function(){this.option_list.find('li').remove();},remove_option:function(name){this.option_list.find('li[name="'+name+'"]').remove();},show:function(node){this.source_node=$(node);var coords=this.source_node.offset();var height=this.source_node.outerHeight();this.menu_node.show();var screen_overflow=($(document).width()-(coords.left+this.menu_node.width()));if(screen_overflow<0){this.menu_node.offset({left:(coords.left+screen_overflow-15),top:(coords.top+height)});this.menu_node.offset({left:(coords.left+screen_overflow-15),top:(coords.top+height)});}else{this.menu_node.offset({left:coords.left,top:(coords.top+height)});this.menu_node.offset({left:coords.left,top:(coords.top+height)});}},toggle:function(node){var new_offset=node.offset();var curent_offset=(this.source_node?this.source_node.offset():{top:0,left:0});if(this.menu_node.is(':visible')&&new_offset.top==curent_offset.top&&new_offset.left==curent_offset.left){this.hide();}else{this.show(node);}}};;eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}(';(3($){$.2e.1u({19:3(b,d){5 c=W b=="1B";d=$.1u({},$.M.1T,{Y:c?b:P,y:c?P:b,1J:c?$.M.1T.1J:10,X:d&&!d.1D?10:48},d);d.1y=d.1y||3(a){6 a};d.1v=d.1v||d.1R;6 A.I(3(){1M $.M(A,d)})},L:3(a){6 A.11("L",a)},1k:3(a){6 A.14("1k",[a])},2b:3(){6 A.14("2b")},28:3(a){6 A.14("28",[a])},24:3(){6 A.14("24")}});$.M=3(o,r){5 t={2Y:38,2S:40,2N:46,2I:9,2E:13,2B:27,2x:3I,2v:33,2p:34,2n:8};5 u=$(o).3r("19","3o").Q(r.2Q);5 p;5 m="";5 n=$.M.3c(r);5 s=0;5 k;5 h={1F:C};5 l=$.M.32(r,o,1Z,h);5 j;$.1Y.2X&&$(o.2U).11("45.19",3(){4(j){j=C;6 C}});u.11(($.1Y.2X?"43":"42")+".19",3(a){s=1;k=a.2M;3V(a.2M){O t.2Y:a.1d();4(l.N()){l.30()}w{12(0,D)}R;O t.2S:a.1d();4(l.N()){l.2D()}w{12(0,D)}R;O t.2v:a.1d();4(l.N()){l.2C()}w{12(0,D)}R;O t.2p:a.1d();4(l.N()){l.2A()}w{12(0,D)}R;O r.17&&$.1c(r.S)==","&&t.2x:O t.2I:O t.2E:4(1Z()){a.1d();j=D;6 C}R;O t.2B:l.Z();R;3J:1P(p);p=1O(12,r.1J);R}}).2t(3(){s++}).3E(3(){s=0;4(!h.1F){2r()}}).2q(3(){4(s++>1&&!l.N()){12(0,D)}}).11("1k",3(){5 c=(1r.7>1)?1r[1]:P;3 1N(q,a){5 b;4(a&&a.7){16(5 i=0;i<a.7;i++){4(a[i].L.J()==q.J()){b=a[i];R}}}4(W c=="3")c(b);w u.14("L",b&&[b.y,b.F])}$.I(15(u.K()),3(i,a){21(a,1N,1N)})}).11("2b",3(){n.1o()}).11("28",3(){$.1u(r,1r[1]);4("y"2h 1r[1])n.1e()}).11("24",3(){l.1p();u.1p();$(o.2U).1p(".19")});3 1Z(){5 e=l.2g();4(!e)6 C;5 v=e.L;m=v;4(r.17){5 b=15(u.K());4(b.7>1){5 f=r.S.7;5 c=$(o).18().1I;5 d,1H=0;$.I(b,3(i,a){1H+=a.7;4(c<=1H){d=i;6 C}1H+=f});b[d]=v;v=b.3f(r.S)}v+=r.S}u.K(v);1l();u.14("L",[e.y,e.F]);6 D}3 12(b,c){4(k==t.2N){l.Z();6}5 a=u.K();4(!c&&a==m)6;m=a;a=1m(a);4(a.7>=r.29){u.Q(r.26);4(!r.1s)a=a.J();21(a,3a,1l)}w{1q();l.Z()}};3 15(b){4(!b)6[""];4(!r.17)6[$.1c(b)];6 $.4h(b.23(r.S),3(a){6 $.1c(b).7?$.1c(a):P})}3 1m(a){4(!r.17)6 a;5 c=15(a);4(c.7==1)6 c[0];5 b=$(o).18().1I;4(b==a.7){c=15(a)}w{c=15(a.22(a.37(b),""))}6 c[c.7-1]}3 1G(q,a){4(r.1G&&(1m(u.K()).J()==q.J())&&k!=t.2n){u.K(u.K()+a.37(1m(m).7));$(o).18(m.7,m.7+a.7)}};3 2r(){1P(p);p=1O(1l,4g)};3 1l(){5 c=l.N();l.Z();1P(p);1q();4(r.36){u.1k(3(a){4(!a){4(r.17){5 b=15(u.K()).1n(0,-1);u.K(b.3f(r.S)+(b.7?r.S:""))}w{u.K("");u.14("L",P)}}})}};3 3a(q,a){4(a&&a.7&&s){1q();l.35(a,q);1G(q,a[0].F);l.20()}w{1l()}};3 21(f,d,g){4(!r.1s)f=f.J();5 e=n.31(f);4(e&&e.7){d(f,e)}w 4((W r.Y=="1B")&&(r.Y.7>0)){5 c={4f:+1M 4e()};$.I(r.2Z,3(a,b){c[a]=W b=="3"?b():b});$.4d({4c:"4b",4a:"19"+o.49,2V:r.2V,Y:r.Y,y:$.1u({q:1m(f),47:r.X},c),44:3(a){5 b=r.1A&&r.1A(a)||1A(a);n.1i(f,b);d(f,b)}})}w{l.2T();g(f)}};3 1A(c){5 d=[];5 b=c.23("\\n");16(5 i=0;i<b.7;i++){5 a=$.1c(b[i]);4(a){a=a.23("|");d[d.7]={y:a,F:a[0],L:r.1z&&r.1z(a,a[0])||a[0]}}}6 d};3 1q(){u.1h(r.26)}};$.M.1T={2Q:"41",2P:"3Z",26:"3Y",29:1,1J:3W,1s:C,1f:D,1w:C,1g:10,X:3U,36:C,2Z:{},1X:D,1R:3(a){6 a[0]},1v:P,1G:C,E:0,17:C,S:", ",1y:3(b,a){6 b.22(1M 3T("(?![^&;]+;)(?!<[^<>]*)("+a.22(/([\\^\\$\\(\\)\\[\\]\\{\\}\\*\\.\\+\\?\\|\\\\])/2K,"\\\\$1")+")(?![^<>]*>)(?![^&;]+;)","2K"),"<2J>$1</2J>")},1D:D,1E:3S};$.M.3c=3(g){5 h={};5 j=0;3 1f(s,a){4(!g.1s)s=s.J();5 i=s.2H(a);4(g.1w=="3R"){i=s.J().1k("\\\\b"+a.J())}4(i==-1)6 C;6 i==0||g.1w};3 1i(q,a){4(j>g.1g){1o()}4(!h[q]){j++}h[q]=a}3 1e(){4(!g.y)6 C;5 f={},2G=0;4(!g.Y)g.1g=1;f[""]=[];16(5 i=0,2F=g.y.7;i<2F;i++){5 c=g.y[i];c=(W c=="1B")?[c]:c;5 d=g.1v(c,i+1,g.y.7);4(d===C)1V;5 e=d.3Q(0).J();4(!f[e])f[e]=[];5 b={F:d,y:c,L:g.1z&&g.1z(c)||d};f[e].1U(b);4(2G++<g.X){f[""].1U(b)}};$.I(f,3(i,a){g.1g++;1i(i,a)})}1O(1e,25);3 1o(){h={};j=0}6{1o:1o,1i:1i,1e:1e,31:3(q){4(!g.1g||!j)6 P;4(!g.Y&&g.1w){5 a=[];16(5 k 2h h){4(k.7>0){5 c=h[k];$.I(c,3(i,x){4(1f(x.F,q)){a.1U(x)}})}}6 a}w 4(h[q]){6 h[q]}w 4(g.1f){16(5 i=q.7-1;i>=g.29;i--){5 c=h[q.3O(0,i)];4(c){5 a=[];$.I(c,3(i,x){4(1f(x.F,q)){a[a.7]=x}});6 a}}}6 P}}};$.M.32=3(e,g,f,k){5 h={H:"3N"};5 j,z=-1,y,1t="",1S=D,G,B;3 2y(){4(!1S)6;G=$("<3M/>").Z().Q(e.2P).T("3L","3K").1Q(1K.2w);B=$("<3H/>").1Q(G).3G(3(a){4(U(a).2u&&U(a).2u.3F()==\'2s\'){z=$("1L",B).1h(h.H).3D(U(a));$(U(a)).Q(h.H)}}).2q(3(a){$(U(a)).Q(h.H);f();g.2t();6 C}).3C(3(){k.1F=D}).3B(3(){k.1F=C});4(e.E>0)G.T("E",e.E);1S=C}3 U(a){5 b=a.U;3A(b&&b.3z!="2s")b=b.3y;4(!b)6[];6 b}3 V(b){j.1n(z,z+1).1h(h.H);2o(b);5 a=j.1n(z,z+1).Q(h.H);4(e.1D){5 c=0;j.1n(0,z).I(3(){c+=A.1a});4((c+a[0].1a-B.1b())>B[0].3x){B.1b(c+a[0].1a-B.3w())}w 4(c<B.1b()){B.1b(c)}}};3 2o(a){z+=a;4(z<0){z=j.1j()-1}w 4(z>=j.1j()){z=0}}3 2m(a){6 e.X&&e.X<a?e.X:a}3 2l(){B.2z();5 b=2m(y.7);16(5 i=0;i<b;i++){4(!y[i])1V;5 a=e.1R(y[i].y,i+1,b,y[i].F,1t);4(a===C)1V;5 c=$("<1L/>").3v(e.1y(a,1t)).Q(i%2==0?"3u":"3P").1Q(B)[0];$.y(c,"2k",y[i])}j=B.3t("1L");4(e.1X){j.1n(0,1).Q(h.H);z=0}4($.2e.2W)B.2W()}6{35:3(d,q){2y();y=d;1t=q;2l()},2D:3(){V(1)},30:3(){V(-1)},2C:3(){4(z!=0&&z-8<0){V(-z)}w{V(-8)}},2A:3(){4(z!=j.1j()-1&&z+8>j.1j()){V(j.1j()-1-z)}w{V(8)}},Z:3(){G&&G.Z();j&&j.1h(h.H);z=-1},N:3(){6 G&&G.3s(":N")},3q:3(){6 A.N()&&(j.2j("."+h.H)[0]||e.1X&&j[0])},20:3(){5 a=$(g).3p();G.T({E:W e.E=="1B"||e.E>0?e.E:$(g).E(),2i:a.2i+g.1a,1W:a.1W}).20();4(e.1D){B.1b(0);B.T({2L:e.1E,3n:\'3X\'});4($.1Y.3m&&W 1K.2w.3l.2L==="1x"){5 c=0;j.I(3(){c+=A.1a});5 b=c>e.1E;B.T(\'3k\',b?e.1E:c);4(!b){j.E(B.E()-2R(j.T("2O-1W"))-2R(j.T("2O-3j")))}}}},2g:3(){5 a=j&&j.2j("."+h.H).1h(h.H);6 a&&a.7&&$.y(a[0],"2k")},2T:3(){B&&B.2z()},1p:3(){G&&G.3i()}}};$.2e.18=3(b,f){4(b!==1x){6 A.I(3(){4(A.2d){5 a=A.2d();4(f===1x||b==f){a.4n("2c",b);a.3h()}w{a.4m(D);a.4l("2c",b);a.4k("2c",f);a.3h()}}w 4(A.3g){A.3g(b,f)}w 4(A.1C){A.1C=b;A.3e=f}})}5 c=A[0];4(c.2d){5 e=1K.18.4j(),3d=c.F,2a="<->",2f=e.3b.7;e.3b=2a;5 d=c.F.2H(2a);c.F=3d;A.18(d,d+2f);6{1I:d,39:d+2f}}w 4(c.1C!==1x){6{1I:c.1C,39:c.3e}}}})(4i);',62,272,'|||function|if|var|return|length|||||||||||||||||||||||||else||data|active|this|list|false|true|width|value|element|ACTIVE|each|toLowerCase|val|result|Autocompleter|visible|case|null|addClass|break|multipleSeparator|css|target|moveSelect|typeof|max|url|hide||bind|onChange||trigger|trimWords|for|multiple|selection|autocomplete|offsetHeight|scrollTop|trim|preventDefault|populate|matchSubset|cacheLength|removeClass|add|size|search|hideResultsNow|lastWord|slice|flush|unbind|stopLoading|arguments|matchCase|term|extend|formatMatch|matchContains|undefined|highlight|formatResult|parse|string|selectionStart|scroll|scrollHeight|mouseDownOnSelect|autoFill|progress|start|delay|document|li|new|findValueCallback|setTimeout|clearTimeout|appendTo|formatItem|needsInit|defaults|push|continue|left|selectFirst|browser|selectCurrent|show|request|replace|split|unautocomplete||loadingClass||setOptions|minChars|teststring|flushCache|character|createTextRange|fn|textLength|selected|in|top|filter|ac_data|fillList|limitNumberOfItems|BACKSPACE|movePosition|PAGEDOWN|click|hideResults|LI|focus|nodeName|PAGEUP|body|COMMA|init|empty|pageDown|ESC|pageUp|next|RETURN|ol|nullData|indexOf|TAB|strong|gi|maxHeight|keyCode|DEL|padding|resultsClass|inputClass|parseInt|DOWN|emptyList|form|dataType|bgiframe|opera|UP|extraParams|prev|load|Select|||display|mustMatch|substring||end|receiveData|text|Cache|orig|selectionEnd|join|setSelectionRange|select|remove|right|height|style|msie|overflow|off|offset|current|attr|is|find|ac_even|html|innerHeight|clientHeight|parentNode|tagName|while|mouseup|mousedown|index|blur|toUpperCase|mouseover|ul|188|default|absolute|position|div|ac_over|substr|ac_odd|charAt|word|180|RegExp|100|switch|400|auto|ac_loading|ac_results||ac_input|keydown|keypress|success|submit||limit|150|name|port|abort|mode|ajax|Date|timestamp|200|map|jQuery|createRange|moveEnd|moveStart|collapse|move'.split('|'),0,{}));;(function($){var helper={},current,title,tID,IE=$.browser.msie&&/MSIE\s(5\.5|6\.)/.test(navigator.userAgent),track=false;$.tooltip={blocked:false,defaults:{delay:200,fade:false,showURL:true,extraClass:"",top:15,left:15,id:"tooltip"},block:function(){$.tooltip.blocked=!$.tooltip.blocked;}};$.fn.extend({tooltip:function(settings){settings=$.extend({},$.tooltip.defaults,settings);createHelper(settings);return this.each(function(){$.data(this,"tooltip",settings);this.tOpacity=helper.parent.css("opacity");this.tooltipText=this.title;$(this).removeAttr("title");this.alt="";}).mouseover(save).mouseout(hide).click(hide);},fixPNG:IE?function(){return this.each(function(){var image=$(this).css('backgroundImage');if(image.match(/^url\(["']?(.*\.png)["']?\)$/i)){image=RegExp.$1;$(this).css({'backgroundImage':'none','filter':"progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=crop, src='"+image+"')"}).each(function(){var position=$(this).css('position');if(position!='absolute'&&position!='relative')
$(this).css('position','relative');});}});}:function(){return this;},unfixPNG:IE?function(){return this.each(function(){$(this).css({'filter':'',backgroundImage:''});});}:function(){return this;},hideWhenEmpty:function(){return this.each(function(){$(this)[$(this).html()?"show":"hide"]();});},url:function(){return this.attr('href')||this.attr('src');}});function createHelper(settings){if(helper.parent)
return;helper.parent=$('<div id="'+settings.id+'"><h3></h3><div class="body"></div><div class="url"></div></div>').appendTo(document.body).hide();if($.fn.bgiframe)
helper.parent.bgiframe();helper.title=$('h3',helper.parent);helper.body=$('div.body',helper.parent);helper.url=$('div.url',helper.parent);}
function settings(element){return $.data(element,"tooltip");}
function handle(event){if(settings(this).delay)
tID=setTimeout(show,settings(this).delay);else
show();track=!!settings(this).track;$(document.body).bind('mousemove',update);update(event);}
function save(){if($.tooltip.blocked||this==current||(!this.tooltipText&&!settings(this).bodyHandler))
return;current=this;title=this.tooltipText;if(settings(this).bodyHandler){helper.title.hide();var bodyContent=settings(this).bodyHandler.call(this);if(bodyContent.nodeType||bodyContent.jquery){helper.body.empty().append(bodyContent)}else{helper.body.html(bodyContent);}
helper.body.show();}else if(settings(this).showBody){var parts=title.split(settings(this).showBody);helper.title.html(parts.shift()).show();helper.body.empty();for(var i=0,part;(part=parts[i]);i++){if(i>0)
helper.body.append("<br/>");helper.body.append(part);}
helper.body.hideWhenEmpty();}else{helper.title.html(title).show();helper.body.hide();}
if(settings(this).showURL&&$(this).url())
helper.url.html($(this).url().replace('http://','')).show();else
helper.url.hide();helper.parent.addClass(settings(this).extraClass);if(settings(this).fixPNG)
helper.parent.fixPNG();handle.apply(this,arguments);}
function show(){tID=null;if((!IE||!$.fn.bgiframe)&&settings(current).fade){if(helper.parent.is(":animated"))
helper.parent.stop().show().fadeTo(settings(current).fade,current.tOpacity);else
helper.parent.is(':visible')?helper.parent.fadeTo(settings(current).fade,current.tOpacity):helper.parent.fadeIn(settings(current).fade);}else{helper.parent.show();}
update();}
function update(event){if($.tooltip.blocked)
return;if(event&&event.target.tagName=="OPTION"){return;}
if(!track&&helper.parent.is(":visible")){$(document.body).unbind('mousemove',update)}
if(current==null){$(document.body).unbind('mousemove',update);return;}
helper.parent.removeClass("viewport-right").removeClass("viewport-bottom");var left=helper.parent[0].offsetLeft;var top=helper.parent[0].offsetTop;if(event){left=event.pageX+settings(current).left;top=event.pageY+settings(current).top;var right='auto';if(settings(current).positionLeft){right=$(window).width()-left;left='auto';}
helper.parent.css({left:left,right:right,top:top});}
var v=viewport(),h=helper.parent[0];if(v.x+v.cx<h.offsetLeft+h.offsetWidth){left-=h.offsetWidth+20+settings(current).left;helper.parent.css({left:left+'px'}).addClass("viewport-right");}
if(v.y+v.cy<h.offsetTop+h.offsetHeight){top-=h.offsetHeight+20+settings(current).top;helper.parent.css({top:top+'px'}).addClass("viewport-bottom");}}
function viewport(){return{x:$(window).scrollLeft(),y:$(window).scrollTop(),cx:$(window).width(),cy:$(window).height()};}
function hide(event){if($.tooltip.blocked)
return;if(tID)
clearTimeout(tID);current=null;var tsettings=settings(this);function complete(){helper.parent.removeClass(tsettings.extraClass).hide().css("opacity","");}
if((!IE||!$.fn.bgiframe)&&tsettings.fade){if(helper.parent.is(':animated'))
helper.parent.stop().fadeTo(tsettings.fade,0,complete);else
helper.parent.stop().fadeOut(tsettings.fade,complete);}else
complete();if(settings(this).fixPNG)
helper.parent.unfixPNG();}})(jQuery);;(function(){var fieldSelection={getSelection:function(){var e=this.jquery?this[0]:this;return(('selectionStart'in e&&function(){var l=e.selectionEnd-e.selectionStart;return{start:e.selectionStart,end:e.selectionEnd,length:l,text:e.value.substr(e.selectionStart,l)};})||(document.selection&&function(){e.focus();var r=document.selection.createRange();if(r==null){return{start:0,end:e.value.length,length:0};}
var re=e.createTextRange();var rc=re.duplicate();re.moveToBookmark(r.getBookmark());rc.setEndPoint('EndToStart',re);return{start:rc.text.length,end:rc.text.length+r.text.length,length:r.text.length,text:r.text};})||function(){return{start:0,end:e.value.length,length:0};})();},replaceSelection:function(){var e=this.jquery?this[0]:this;var text=arguments[0]||'';return(('selectionStart'in e&&function(){e.value=e.value.substr(0,e.selectionStart)+text+e.value.substr(e.selectionEnd,e.value.length);return this;})||(document.selection&&function(){e.focus();document.selection.createRange().text=text;return this;})||function(){e.value+=text;return this;})();},setSelection:function(start,end){var e=this.jquery?this[0]:this;if(e.setSelectionRange){e.focus();e.setSelectionRange(start,end);}
else if(e.createTextRange){var range=e.createTextRange();range.collapse(true);range.moveEnd('character',end);range.moveStart('character',start);range.select();}}};jQuery.each(fieldSelection,function(i){jQuery.fn[i]=this;});})();;var dateFormat=function(){var token=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,timezone=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,timezoneClip=/[^-+\dA-Z]/g,pad=function(val,len){val=String(val);len=len||2;while(val.length<len)val="0"+val;return val;};return function(date,mask,utc){var dF=dateFormat;if(arguments.length==1&&Object.prototype.toString.call(date)=="[object String]"&&!/\d/.test(date)){mask=date;date=undefined;}
date=date?new Date(date):new Date;if(isNaN(date))throw SyntaxError("invalid date");mask=String(dF.masks[mask]||mask||dF.masks["default"]);if(mask.slice(0,4)=="UTC:"){mask=mask.slice(4);utc=true;}
var _=utc?"getUTC":"get",d=date[_+"Date"](),D=date[_+"Day"](),m=date[_+"Month"](),y=date[_+"FullYear"](),H=date[_+"Hours"](),M=date[_+"Minutes"](),s=date[_+"Seconds"](),L=date[_+"Milliseconds"](),o=utc?0:date.getTimezoneOffset(),flags={d:d,dd:pad(d),ddd:dF.i18n.dayNames[D],dddd:dF.i18n.dayNames[D+7],m:m+1,mm:pad(m+1),mmm:dF.i18n.monthNames[m],mmmm:dF.i18n.monthNames[m+12],yy:String(y).slice(2),yyyy:y,h:H%12||12,hh:pad(H%12||12),H:H,HH:pad(H),M:M,MM:pad(M),s:s,ss:pad(s),l:pad(L,3),L:pad(L>99?Math.round(L/10):L),t:H<12?"a":"p",tt:H<12?"am":"pm",T:H<12?"A":"P",TT:H<12?"AM":"PM",Z:utc?"UTC":(String(date).match(timezone)||[""]).pop().replace(timezoneClip,""),o:(o>0?"-":"+")+pad(Math.floor(Math.abs(o)/60)*100+Math.abs(o)%60,4),S:["th","st","nd","rd"][d%10>3?0:(d%100-d%10!=10)*d%10]};return mask.replace(token,function($0){return $0 in flags?flags[$0]:$0.slice(1,$0.length-1);});};}();dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};Date.prototype.format=function(mask,utc){return dateFormat(this,mask,utc);};;!function(){var q=null;window.PR_SHOULD_USE_CONTINUATION=!0;(function(){function S(a){function d(e){var b=e.charCodeAt(0);if(b!==92)return b;var a=e.charAt(1);return(b=r[a])?b:"0"<=a&&a<="7"?parseInt(e.substring(1),8):a==="u"||a==="x"?parseInt(e.substring(2),16):e.charCodeAt(1)}function g(e){if(e<32)return(e<16?"\\x0":"\\x")+e.toString(16);e=String.fromCharCode(e);return e==="\\"||e==="-"||e==="]"||e==="^"?"\\"+e:e}function b(e){var b=e.substring(1,e.length-1).match(/\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\[0-3][0-7]{0,2}|\\[0-7]{1,2}|\\[\S\s]|[^\\]/g),e=[],a=b[0]==="^",c=["["];a&&c.push("^");for(var a=a?1:0,f=b.length;a<f;++a){var h=b[a];if(/\\[bdsw]/i.test(h))c.push(h);else{var h=d(h),l;a+2<f&&"-"===b[a+1]?(l=d(b[a+2]),a+=2):l=h;e.push([h,l]);l<65||h>122||(l<65||h>90||e.push([Math.max(65,h)|32,Math.min(l,90)|32]),l<97||h>122||e.push([Math.max(97,h)&-33,Math.min(l,122)&-33]))}}e.sort(function(e,a){return e[0]-a[0]||a[1]-e[1]});b=[];f=[];for(a=0;a<e.length;++a)h=e[a],h[0]<=f[1]+1?f[1]=Math.max(f[1],h[1]):b.push(f=h);for(a=0;a<b.length;++a)h=b[a],c.push(g(h[0])),h[1]>h[0]&&(h[1]+1>h[0]&&c.push("-"),c.push(g(h[1])));c.push("]");return c.join("")}function s(e){for(var a=e.source.match(/\[(?:[^\\\]]|\\[\S\s])*]|\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}|\\\d+|\\[^\dux]|\(\?[!:=]|[()^]|[^()[\\^]+/g),c=a.length,d=[],f=0,h=0;f<c;++f){var l=a[f];l==="("?++h:"\\"===l.charAt(0)&&(l=+l.substring(1))&&(l<=h?d[l]=-1:a[f]=g(l))}for(f=1;f<d.length;++f)-1===d[f]&&(d[f]=++x);for(h=f=0;f<c;++f)l=a[f],l==="("?(++h,d[h]||(a[f]="(?:")):"\\"===l.charAt(0)&&(l=+l.substring(1))&&l<=h&&(a[f]="\\"+d[l]);for(f=0;f<c;++f)"^"===a[f]&&"^"!==a[f+1]&&(a[f]="");if(e.ignoreCase&&m)for(f=0;f<c;++f)l=a[f],e=l.charAt(0),l.length>=2&&e==="["?a[f]=b(l):e!=="\\"&&(a[f]=l.replace(/[A-Za-z]/g,function(a){a=a.charCodeAt(0);return"["+String.fromCharCode(a&-33,a|32)+"]"}));return a.join("")}for(var x=0,m=!1,j=!1,k=0,c=a.length;k<c;++k){var i=a[k];if(i.ignoreCase)j=!0;else if(/[a-z]/i.test(i.source.replace(/\\u[\da-f]{4}|\\x[\da-f]{2}|\\[^UXux]/gi,""))){m=!0;j=!1;break}}for(var r={b:8,t:9,n:10,v:11,f:12,r:13},n=[],k=0,c=a.length;k<c;++k){i=a[k];if(i.global||i.multiline)throw Error(""+i);n.push("(?:"+s(i)+")")}return RegExp(n.join("|"),j?"gi":"g")}function T(a,d){function g(a){var c=a.nodeType;if(c==1){if(!b.test(a.className)){for(c=a.firstChild;c;c=c.nextSibling)g(c);c=a.nodeName.toLowerCase();if("br"===c||"li"===c)s[j]="\n",m[j<<1]=x++,m[j++<<1|1]=a}}else if(c==3||c==4)c=a.nodeValue,c.length&&(c=d?c.replace(/\r\n?/g,"\n"):c.replace(/[\t\n\r ]+/g," "),s[j]=c,m[j<<1]=x,x+=c.length,m[j++<<1|1]=a)}var b=/(?:^|\s)nocode(?:\s|$)/,s=[],x=0,m=[],j=0;g(a);return{a:s.join("").replace(/\n$/,""),d:m}}function H(a,d,g,b){d&&(a={a:d,e:a},g(a),b.push.apply(b,a.g))}function U(a){for(var d=void 0,g=a.firstChild;g;g=g.nextSibling)var b=g.nodeType,d=b===1?d?a:g:b===3?V.test(g.nodeValue)?a:d:d;return d===a?void 0:d}function C(a,d){function g(a){for(var j=a.e,k=[j,"pln"],c=0,i=a.a.match(s)||[],r={},n=0,e=i.length;n<e;++n){var z=i[n],w=r[z],t=void 0,f;if(typeof w==="string")f=!1;else{var h=b[z.charAt(0)];if(h)t=z.match(h[1]),w=h[0];else{for(f=0;f<x;++f)if(h=d[f],t=z.match(h[1])){w=h[0];break}t||(w="pln")}if((f=w.length>=5&&"lang-"===w.substring(0,5))&&!(t&&typeof t[1]==="string"))f=!1,w="src";f||(r[z]=w)}h=c;c+=z.length;if(f){f=t[1];var l=z.indexOf(f),B=l+f.length;t[2]&&(B=z.length-t[2].length,l=B-f.length);w=w.substring(5);H(j+h,z.substring(0,l),g,k);H(j+h+l,f,I(w,f),k);H(j+h+B,z.substring(B),g,k)}else k.push(j+h,w)}a.g=k}var b={},s;(function(){for(var g=a.concat(d),j=[],k={},c=0,i=g.length;c<i;++c){var r=g[c],n=r[3];if(n)for(var e=n.length;--e>=0;)b[n.charAt(e)]=r;r=r[1];n=""+r;k.hasOwnProperty(n)||(j.push(r),k[n]=q)}j.push(/[\S\s]/);s=S(j)})();var x=d.length;return g}function v(a){var d=[],g=[];a.tripleQuotedStrings?d.push(["str",/^(?:'''(?:[^'\\]|\\[\S\s]|''?(?=[^']))*(?:'''|$)|"""(?:[^"\\]|\\[\S\s]|""?(?=[^"]))*(?:"""|$)|'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$))/,q,"'\""]):a.multiLineStrings?d.push(["str",/^(?:'(?:[^'\\]|\\[\S\s])*(?:'|$)|"(?:[^"\\]|\\[\S\s])*(?:"|$)|`(?:[^\\`]|\\[\S\s])*(?:`|$))/,q,"'\"`"]):d.push(["str",/^(?:'(?:[^\n\r'\\]|\\.)*(?:'|$)|"(?:[^\n\r"\\]|\\.)*(?:"|$))/,q,"\"'"]);a.verbatimStrings&&g.push(["str",/^@"(?:[^"]|"")*(?:"|$)/,q]);var b=a.hashComments;b&&(a.cStyleComments?(b>1?d.push(["com",/^#(?:##(?:[^#]|#(?!##))*(?:###|$)|.*)/,q,"#"]):d.push(["com",/^#(?:(?:define|e(?:l|nd)if|else|error|ifn?def|include|line|pragma|undef|warning)\b|[^\n\r]*)/,q,"#"]),g.push(["str",/^<(?:(?:(?:\.\.\/)*|\/?)(?:[\w-]+(?:\/[\w-]+)+)?[\w-]+\.h(?:h|pp|\+\+)?|[a-z]\w*)>/,q])):d.push(["com",/^#[^\n\r]*/,q,"#"]));a.cStyleComments&&(g.push(["com",/^\/\/[^\n\r]*/,q]),g.push(["com",/^\/\*[\S\s]*?(?:\*\/|$)/,q]));if(b=a.regexLiterals){var s=(b=b>1?"":"\n\r")?".":"[\\S\\s]";g.push(["lang-regex",RegExp("^(?:^^\\.?|[+-]|[!=]=?=?|\\#|%=?|&&?=?|\\(|\\*=?|[+\\-]=|->|\\/=?|::?|<<?=?|>>?>?=?|,|;|\\?|@|\\[|~|{|\\^\\^?=?|\\|\\|?=?|break|case|continue|delete|do|else|finally|instanceof|return|throw|try|typeof)\\s*("+("/(?=[^/*"+b+"])(?:[^/\\x5B\\x5C"+b+"]|\\x5C"+s+"|\\x5B(?:[^\\x5C\\x5D"+b+"]|\\x5C"+
s+")*(?:\\x5D|$))+/")+")")])}(b=a.types)&&g.push(["typ",b]);b=(""+a.keywords).replace(/^ | $/g,"");b.length&&g.push(["kwd",RegExp("^(?:"+b.replace(/[\s,]+/g,"|")+")\\b"),q]);d.push(["pln",/^\s+/,q," \r\n\t\u00a0"]);b="^.[^\\s\\w.$@'\"`/\\\\]*";a.regexLiterals&&(b+="(?!s*/)");g.push(["lit",/^@[$_a-z][\w$@]*/i,q],["typ",/^(?:[@_]?[A-Z]+[a-z][\w$@]*|\w+_t\b)/,q],["pln",/^[$_a-z][\w$@]*/i,q],["lit",/^(?:0x[\da-f]+|(?:\d(?:_\d+)*\d*(?:\.\d*)?|\.\d\+)(?:e[+-]?\d+)?)[a-z]*/i,q,"0123456789"],["pln",/^\\[\S\s]?/,q],["pun",RegExp(b),q]);return C(d,g)}function J(a,d,g){function b(a){var c=a.nodeType;if(c==1&&!x.test(a.className))if("br"===a.nodeName)s(a),a.parentNode&&a.parentNode.removeChild(a);else for(a=a.firstChild;a;a=a.nextSibling)b(a);else if((c==3||c==4)&&g){var d=a.nodeValue,i=d.match(m);if(i)c=d.substring(0,i.index),a.nodeValue=c,(d=d.substring(i.index+i[0].length))&&a.parentNode.insertBefore(j.createTextNode(d),a.nextSibling),s(a),c||a.parentNode.removeChild(a)}}function s(a){function b(a,c){var d=c?a.cloneNode(!1):a,e=a.parentNode;if(e){var e=b(e,1),g=a.nextSibling;e.appendChild(d);for(var i=g;i;i=g)g=i.nextSibling,e.appendChild(i)}return d}for(;!a.nextSibling;)if(a=a.parentNode,!a)return;for(var a=b(a.nextSibling,0),d;(d=a.parentNode)&&d.nodeType===1;)a=d;c.push(a)}for(var x=/(?:^|\s)nocode(?:\s|$)/,m=/\r\n?|\n/,j=a.ownerDocument,k=j.createElement("li");a.firstChild;)k.appendChild(a.firstChild);for(var c=[k],i=0;i<c.length;++i)b(c[i]);d===(d|0)&&c[0].setAttribute("value",d);var r=j.createElement("ol");r.className="linenums";for(var d=Math.max(0,d-1|0)||0,i=0,n=c.length;i<n;++i)k=c[i],k.className="L"+(i+d)%10,k.firstChild||k.appendChild(j.createTextNode("\u00a0")),r.appendChild(k);a.appendChild(r)}function p(a,d){for(var g=d.length;--g>=0;){var b=d[g];F.hasOwnProperty(b)?D.console&&console.warn("cannot override language handler %s",b):F[b]=a}}function I(a,d){if(!a||!F.hasOwnProperty(a))a=/^\s*</.test(d)?"default-markup":"default-code";return F[a]}function K(a){var d=a.h;try{var g=T(a.c,a.i),b=g.a;a.a=b;a.d=g.d;a.e=0;I(d,b)(a);var s=/\bMSIE\s(\d+)/.exec(navigator.userAgent),s=s&&+s[1]<=8,d=/\n/g,x=a.a,m=x.length,g=0,j=a.d,k=j.length,b=0,c=a.g,i=c.length,r=0;c[i]=m;var n,e;for(e=n=0;e<i;)c[e]!==c[e+2]?(c[n++]=c[e++],c[n++]=c[e++]):e+=2;i=n;for(e=n=0;e<i;){for(var p=c[e],w=c[e+1],t=e+2;t+2<=i&&c[t+1]===w;)t+=2;c[n++]=p;c[n++]=w;e=t}c.length=n;var f=a.c,h;if(f)h=f.style.display,f.style.display="none";try{for(;b<k;){var l=j[b+2]||m,B=c[r+2]||m,t=Math.min(l,B),A=j[b+1],G;if(A.nodeType!==1&&(G=x.substring(g,t))){s&&(G=G.replace(d,"\r"));A.nodeValue=G;var L=A.ownerDocument,o=L.createElement("span");o.className=c[r+1];var v=A.parentNode;v.replaceChild(o,A);o.appendChild(A);g<l&&(j[b+1]=A=L.createTextNode(x.substring(t,l)),v.insertBefore(A,o.nextSibling))}g=t;g>=l&&(b+=2);g>=B&&(r+=2)}}finally{if(f)f.style.display=h}}catch(u){D.console&&console.log(u&&u.stack||u)}}var D=window,y=["break,continue,do,else,for,if,return,while"],E=[[y,"auto,case,char,const,default,double,enum,extern,float,goto,inline,int,long,register,short,signed,sizeof,static,struct,switch,typedef,union,unsigned,void,volatile"],"catch,class,delete,false,import,new,operator,private,protected,public,this,throw,true,try,typeof"],M=[E,"alignof,align_union,asm,axiom,bool,concept,concept_map,const_cast,constexpr,decltype,delegate,dynamic_cast,explicit,export,friend,generic,late_check,mutable,namespace,nullptr,property,reinterpret_cast,static_assert,static_cast,template,typeid,typename,using,virtual,where"],N=[E,"abstract,assert,boolean,byte,extends,final,finally,implements,import,instanceof,interface,null,native,package,strictfp,super,synchronized,throws,transient"],O=[N,"as,base,by,checked,decimal,delegate,descending,dynamic,event,fixed,foreach,from,group,implicit,in,internal,into,is,let,lock,object,out,override,orderby,params,partial,readonly,ref,sbyte,sealed,stackalloc,string,select,uint,ulong,unchecked,unsafe,ushort,var,virtual,where"],E=[E,"debugger,eval,export,function,get,null,set,undefined,var,with,Infinity,NaN"],P=[y,"and,as,assert,class,def,del,elif,except,exec,finally,from,global,import,in,is,lambda,nonlocal,not,or,pass,print,raise,try,with,yield,False,True,None"],Q=[y,"alias,and,begin,case,class,def,defined,elsif,end,ensure,false,in,module,next,nil,not,or,redo,rescue,retry,self,super,then,true,undef,unless,until,when,yield,BEGIN,END"],W=[y,"as,assert,const,copy,drop,enum,extern,fail,false,fn,impl,let,log,loop,match,mod,move,mut,priv,pub,pure,ref,self,static,struct,true,trait,type,unsafe,use"],y=[y,"case,done,elif,esac,eval,fi,function,in,local,set,then,until"],R=/^(DIR|FILE|vector|(de|priority_)?queue|list|stack|(const_)?iterator|(multi)?(set|map)|bitset|u?(int|float)\d*)\b/,V=/\S/,X=v({keywords:[M,O,E,"caller,delete,die,do,dump,elsif,eval,exit,foreach,for,goto,if,import,last,local,my,next,no,our,print,package,redo,require,sub,undef,unless,until,use,wantarray,while,BEGIN,END",P,Q,y],hashComments:!0,cStyleComments:!0,multiLineStrings:!0,regexLiterals:!0}),F={};p(X,["default-code"]);p(C([],[["pln",/^[^<?]+/],["dec",/^<!\w[^>]*(?:>|$)/],["com",/^<\!--[\S\s]*?(?:--\>|$)/],["lang-",/^<\?([\S\s]+?)(?:\?>|$)/],["lang-",/^<%([\S\s]+?)(?:%>|$)/],["pun",/^(?:<[%?]|[%?]>)/],["lang-",/^<xmp\b[^>]*>([\S\s]+?)<\/xmp\b[^>]*>/i],["lang-js",/^<script\b[^>]*>([\S\s]*?)(<\/script\b[^>]*>)/i],["lang-css",/^<style\b[^>]*>([\S\s]*?)(<\/style\b[^>]*>)/i],["lang-in.tag",/^(<\/?[a-z][^<>]*>)/i]]),["default-markup","htm","html","mxml","xhtml","xml","xsl"]);p(C([["pln",/^\s+/,q," \t\r\n"],["atv",/^(?:"[^"]*"?|'[^']*'?)/,q,"\"'"]],[["tag",/^^<\/?[a-z](?:[\w-.:]*\w)?|\/?>$/i],["atn",/^(?!style[\s=]|on)[a-z](?:[\w:-]*\w)?/i],["lang-uq.val",/^=\s*([^\s"'>]*(?:[^\s"'/>]|\/(?=\s)))/],["pun",/^[/<->]+/],["lang-js",/^on\w+\s*=\s*"([^"]+)"/i],["lang-js",/^on\w+\s*=\s*'([^']+)'/i],["lang-js",/^on\w+\s*=\s*([^\s"'>]+)/i],["lang-css",/^style\s*=\s*"([^"]+)"/i],["lang-css",/^style\s*=\s*'([^']+)'/i],["lang-css",/^style\s*=\s*([^\s"'>]+)/i]]),["in.tag"]);p(C([],[["atv",/^[\S\s]+/]]),["uq.val"]);p(v({keywords:M,hashComments:!0,cStyleComments:!0,types:R}),["c","cc","cpp","cxx","cyc","m"]);p(v({keywords:"null,true,false"}),["json"]);p(v({keywords:O,hashComments:!0,cStyleComments:!0,verbatimStrings:!0,types:R}),["cs"]);p(v({keywords:N,cStyleComments:!0}),["java"]);p(v({keywords:y,hashComments:!0,multiLineStrings:!0}),["bash","bsh","csh","sh"]);p(v({keywords:P,hashComments:!0,multiLineStrings:!0,tripleQuotedStrings:!0}),["cv","py","python"]);p(v({keywords:"caller,delete,die,do,dump,elsif,eval,exit,foreach,for,goto,if,import,last,local,my,next,no,our,print,package,redo,require,sub,undef,unless,until,use,wantarray,while,BEGIN,END",hashComments:!0,multiLineStrings:!0,regexLiterals:2}),["perl","pl","pm"]);p(v({keywords:Q,hashComments:!0,multiLineStrings:!0,regexLiterals:!0}),["rb","ruby"]);p(v({keywords:E,cStyleComments:!0,regexLiterals:!0}),["javascript","js"]);p(v({keywords:"all,and,by,catch,class,else,extends,false,finally,for,if,in,is,isnt,loop,new,no,not,null,of,off,on,or,return,super,then,throw,true,try,unless,until,when,while,yes",hashComments:3,cStyleComments:!0,multilineStrings:!0,tripleQuotedStrings:!0,regexLiterals:!0}),["coffee"]);p(v({keywords:W,cStyleComments:!0,multilineStrings:!0}),["rc","rs","rust"]);p(C([],[["str",/^[\S\s]+/]]),["regex"]);var Y=D.PR={createSimpleLexer:C,registerLangHandler:p,sourceDecorator:v,PR_ATTRIB_NAME:"atn",PR_ATTRIB_VALUE:"atv",PR_COMMENT:"com",PR_DECLARATION:"dec",PR_KEYWORD:"kwd",PR_LITERAL:"lit",PR_NOCODE:"nocode",PR_PLAIN:"pln",PR_PUNCTUATION:"pun",PR_SOURCE:"src",PR_STRING:"str",PR_TAG:"tag",PR_TYPE:"typ",prettyPrintOne:D.prettyPrintOne=function(a,d,g){var b=document.createElement("div");b.innerHTML="<pre>"+a+"</pre>";b=b.firstChild;g&&J(b,g,!0);K({h:d,j:g,c:b,i:1});return b.innerHTML},prettyPrint:D.prettyPrint=function(a,d){function g(){for(var b=D.PR_SHOULD_USE_CONTINUATION?c.now()+250:Infinity;i<p.length&&c.now()<b;i++){for(var d=p[i],j=h,k=d;k=k.previousSibling;){var m=k.nodeType,o=(m===7||m===8)&&k.nodeValue;if(o?!/^\??prettify\b/.test(o):m!==3||/\S/.test(k.nodeValue))break;if(o){j={};o.replace(/\b(\w+)=([\w%+\-.:]+)/g,function(a,b,c){j[b]=c});break}}k=d.className;if((j!==h||e.test(k))&&!v.test(k)){m=!1;for(o=d.parentNode;o;o=o.parentNode)if(f.test(o.tagName)&&o.className&&e.test(o.className)){m=!0;break}if(!m){d.className+=" prettyprinted";m=j.lang;if(!m){var m=k.match(n),y;if(!m&&(y=U(d))&&t.test(y.tagName))m=y.className.match(n);m&&(m=m[1])}if(w.test(d.tagName))o=1;else var o=d.currentStyle,u=s.defaultView,o=(o=o?o.whiteSpace:u&&u.getComputedStyle?u.getComputedStyle(d,q).getPropertyValue("white-space"):0)&&"pre"===o.substring(0,3);u=j.linenums;if(!(u=u==="true"||+u))u=(u=k.match(/\blinenums\b(?::(\d+))?/))?u[1]&&u[1].length?+u[1]:!0:!1;u&&J(d,u,o);r={h:m,c:d,j:u,i:o};K(r)}}}i<p.length?setTimeout(g,250):"function"===typeof a&&a()}for(var b=d||document.body,s=b.ownerDocument||document,b=[b.getElementsByTagName("pre"),b.getElementsByTagName("code"),b.getElementsByTagName("xmp")],p=[],m=0;m<b.length;++m)for(var j=0,k=b[m].length;j<k;++j)p.push(b[m][j]);var b=q,c=Date;c.now||(c={now:function(){return+new Date}});var i=0,r,n=/\blang(?:uage)?-([\w.]+)(?!\S)/,e=/\bprettyprint\b/,v=/\bprettyprinted\b/,w=/pre|xmp/i,t=/^code$/i,f=/^(?:pre|code|xmp)$/i,h={};g()}};typeof define==="function"&&define.amd&&define("google-code-prettify",[],function(){return Y})})();}()